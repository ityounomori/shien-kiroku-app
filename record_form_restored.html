<!-- record_form.html - v33 (Logic Restored & Final Bug Fixes) -->
<!DOCTYPE html>
<html>

<head>
    <base target="_top">
    <title>ÊîØÊè¥Ë®òÈå≤„Ç¢„Éó„É™</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=no">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';</script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        // „ÅÅEÅ°„ÇÅEÅÜ„Ç´„É©„Éº (Ginkgo)
                        'ginkgo': {
                            50: '#fffaeb', 100: '#fef0c7', 200: '#fde08b', 300: '#fccb4e',
                            400: '#fbb116', 500: '#f59e0b', 600: '#d97706', 700: '#b45309', 800: '#92400e',
                        },
                        // Ê£Æ„Ç´„É©„Éº (Forest)
                        'forest': { 50: '#f2fcf5', 500: '#22c55e', 700: '#15803d' }
                    },
                    fontFamily: {
                        // „Éï„Ç©„É≥„ÉàË®≠ÂÆÅE(Êó¢Â≠ò„Å®Ë¶™ÂíåÊÄß„ÅÆÈ´ò„ÅÑË®≠ÂÆÅE
                        sans: ['"Inter"', '"Hiragino Kaku Gothic ProN"', '"Meiryo"', 'sans-serif'],
                    }
                }
            }
        }
    </script>

    <!-- [Fix] Synchronous filter restoration to prevent flash -->
    <script>
            (function () {
                try {
                    const vm = localStorage.getItem('filter_viewMode');
                    const cd = localStorage.getItem('filter_currentDate');

                    if (!vm && !cd) return; // Nothing to restore

                    // [Fix] Skip restoration if just signed in
                    if (sessionStorage.getItem('skip_filter_restore') === 'true') {
                        console.log('[Sync] Skipping filter restoration (just signed in)');
                        return;
                    }

                    // Helper function for date formatting (minimal version)
                    function formatDate(d, short) {
                        const y = d.getFullYear();
                        const m = d.getMonth() + 1;
                        const dt = d.getDate();
                        const w = ["Êó•", "ÊúÅE, "ÁÅ´", "Ê∞¥", "Êú®", "ÈáÅE, "ÂúÅE][d.getDay()];
                        return short ? `${m}/${dt}(${w})` : `${y}/${m}/${dt} (${w})`;
                    }

                    // Restore on DOMContentLoaded (but synchronously scheduled)
                    document.addEventListener('DOMContentLoaded', function () {
                        const viewMode = vm || 'day';
                        const currentDate = cd ? new Date(cd) : new Date();

                        // Update segment buttons
                        document.querySelectorAll('.segment-btn').forEach(b => b.classList.remove('active'));
                        const segBtn = document.getElementById(`seg-${viewMode}`);
                        if (segBtn) segBtn.classList.add('active');

                        // Update btn-current text
                        const btnCurrent = document.getElementById('btn-current');
                        if (btnCurrent) {
                            if (viewMode === 'day') btnCurrent.textContent = '‰ªäÊó•„Å∏';
                            else if (viewMode === 'week') btnCurrent.textContent = '‰ªäÈÄ±„Å∏';
                            else if (viewMode === 'month') btnCurrent.textContent = '‰ªäÊúà„Å∏';
                        }

                        // Calculate and set date display
                        const a = new Date(currentDate);
                        a.setHours(0, 0, 0, 0);
                        let s = new Date(a);
                        let e = new Date(a);
                        let displayText = "";

                        if (viewMode === 'day') {
                            displayText = formatDate(a, false);
                        } else if (viewMode === 'week') {
                            const d = a.getDay();
                            const diff = (d === 0 ? 6 : d - 1);
                            s.setDate(a.getDate() - diff);
                            e = new Date(s);
                            e.setDate(s.getDate() + 6);
                            displayText = `${formatDate(s, true)} - ${formatDate(e, true)}`;
                        } else if (viewMode === 'month') {
                            s.setDate(1);
                            e = new Date(s.getFullYear(), s.getMonth() + 1, 0);
                            const y = s.getFullYear();
                            const m = s.getMonth() + 1;
                            displayText = `${y}Âπ¥${m}ÊúÅE;
                        }

                        const dateDisplay = document.getElementById('current-date-display');
                        if (dateDisplay) dateDisplay.textContent = displayText;

                        console.log('[Sync] Filter restored before main app init:', { viewMode, displayText });

                        // [Fix] Show UI immediately after restoring DOM (don't wait for server)
                        document.body.classList.remove('pre-init');

                    }, { once: true, capture: true }); // Run before other DOMContentLoaded handlers
                } catch (e) {
                    console.warn('[Sync] Filter restoration failed:', e);
                }
            })();
    </script>



    <style>
        /* ‚ñº‚ñº‚ñº Responsive Header Overrides (Robust) ‚ñº‚ñº‚ñº */
        #header-user-pc-container {
            display: none;
        }

        #toolbar-pc {
            display: none;
        }

        #mobile-menu-btn {
            display: block;
        }

        @media (min-width: 768px) {
            #header-user-pc-container {
                display: block !important;
            }

            #toolbar-pc {
                display: flex !important;
            }

            #mobile-menu-btn {
                display: none !important;
            }
        }

        /* ‚ñ≤‚ñ≤‚ñ≤ End Overrides ‚ñ≤‚ñ≤‚ñ≤ */

        /* ‚ñº‚ñº‚ñº Robust List Visibility ‚ñº‚ñº‚ñº */
        .responsive-table-view {
            display: none !important;
        }

        .responsive-card-view {
            display: block !important;
        }

        @media (min-width: 768px) {
            .responsive-table-view {
                display: block !important;
            }

            .responsive-card-view {
                display: none !important;
            }
        }

        /* ‚ñ≤‚ñ≤‚ñ≤ End List Visibility ‚ñ≤‚ñ≤‚ñ≤ */

        html {
            height: 100%;
            overflow: hidden;
            /* Fix for App-Layout */
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: #f4f7f9;
            height: 100%;
            overflow: hidden;
            /* Fix for App-Layout */
            display: flex;
            /* Flex Layout */
            flex-direction: column;
        }

        /* Incident Card Styles */
        .incident-card {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 16px;
            padding: 16px;
            margin-bottom: 12px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
            transition: all 0.2s ease;
            position: relative;
            cursor: pointer;
        }

        .incident-card:hover {
            border-color: #6366f1;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }

        .status-badge {
            font-size: 10px;
            font-weight: 800;
            padding: 4px 10px;
            border-radius: 99px;
            text-transform: uppercase;
        }

        .status-pending {
            background: #fff7ed;
            color: #c2410c;
            border: 1px solid #ffedd5;
        }

        .status-approved {
            background: #f0fdf4;
            color: #15803d;
            border: 1px solid #dcfce7;
        }

        .status-returned {
            background: #fef2f2;
            color: #b91c1c;
            border: 1px solid #fee2e2;
        }

        /* Ê®™„Çπ„ÇØ„É≠„Éº„É´„ÅÆ‰øÆÊ≠£ („Çø„Éñ„Éê„ÉºÁ≠ÅE */
        #header-tabs-list,
        #phrase-category-tabs {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            touch-action: pan-x;
            /* scrollbar-width: none;  <-- Removed to show scrollbar */
            padding-bottom: 4px;
            /* Space for scrollbar */
        }

        /* WebKit Scrollbar for Tabs (Thin & Visible) */
        #header-tabs-list::-webkit-scrollbar,
        #phrase-category-tabs::-webkit-scrollbar {
            height: 4px;
            /* Visible */
            display: block;
        }

        #header-tabs-list::-webkit-scrollbar-thumb,
        #phrase-category-tabs::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            /* Visible Color */
            border-radius: 2px;
        }

        /* Main Scroll Area */
        #main-scroll-wrapper {
            flex: 1;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            min-height: 0;
            /* Important for flex child scroll */
            position: relative;
            /* [v33 Fix] Force GPU composite layer to prevent scroll freeze/paint lag */
            transform: translateZ(0);
            will-change: scroll-position;
            /* [v33 Fix] Prevent scroll chaining */
            overscroll-behavior-y: contain;
            /* [v33 Fix] Hint for vertical scroll only (Optimizes touch) */
            touch-action: pan-y;
        }

        /* Phrase Manager Scroll Area */
        #phrase-manager-list {
            overscroll-behavior-y: contain;
            /* [v33 Fix] Hint for vertical scroll only */
            touch-action: pan-y;
            /* Ensure smooth scroll */
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }


        /* „Çπ„ÇØ„É≠„Éº„É´„Éê„ÅE„ÅÆ„Ç´„Çπ„Çø„Éû„Ç§„Ç∫ÅEàÂ∏∏ÊôÇË°®Á§∫ÅEÅE*/
        .custom-scrollbar {
            -webkit-overflow-scrolling: touch;
            /* FirefoxÁî® */
            scrollbar-width: thin;
            scrollbar-color: #94a3b8 transparent;
        }

        /* WebKitÁ≥ªÅEÅEhrome, SafariÅEâÁî®Ë®≠ÂÆÅE*/
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
            /* Á∏¶„Çπ„ÇØ„É≠„Éº„É´„Éê„ÅE„ÅÆÂπÅE*/
            height: 6px;
            /* Ê®™„Çπ„ÇØ„É≠„Éº„É´„Éê„ÅE„ÅÆÈ´ò„Åï */
        }

        .custom-scrollbar::-webkit-scrollbar-track {
            background: transparent;
            /* ËÉåÊôØ„ÅØÈÄèÊÅE */
        }

        .custom-scrollbar::-webkit-scrollbar-thumb {
            background-color: #94a3b8;
            /* „Éê„ÅE„ÅÆËâ≤ÅEàÊøÅEÅÑ„ÇÅ„ÅE„Ç∞„É¨„ÉºÅEÅE*/
            border-radius: 3px;
            /* ‰∏∏„Åø„ÇíÊåÅ„Åü„Åõ„ÇÅE*/
        }


        .line-clamp-3 {
            display: -webkit-box;
            -webkit-line-clamp: 3;
            line-clamp: 3;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        /* [v33 Fix] Scroll Lock Class */
        .no-scroll {
            overflow: hidden !important;
            touch-action: none;
            /* iOS„Åß„Çπ„ÇØ„É≠„Éº„É´Ëá™‰Ωì„ÇíÊ≠¢„ÇÅ„Çã */
        }


        .fab-safe-area {
            padding-bottom: 160px !important;
        }

        input[type="date"] {
            -webkit-appearance: none;
            appearance: none;
            min-width: 0;
            text-align: center;
        }

        .segment-btn {
            background-color: transparent;
            color: #4b5563;
            border: 1px solid transparent;
        }

        .segment-btn.active {
            background-color: #6366f1;
            color: white;
            border-color: #6366f1;
        }

        /* [v33 Final Style] PDF„Åå‰º∏„Å≥„Åö„ÄÅ‰ΩôÁôΩ„ÅåÂùáÁ≠â„Å´„Å™„ÇãË®≠ÂÆÅE*/
        #pc-pdf-container {
            cursor: grab;
            overflow: auto;
            height: calc(100% - 46px);
            position: relative;
            background-color: #525659;

            /* ËÉåÊôØ„ÅÆ„Ç∞„É¨„Éº */
            user-select: none;
            display: block;
            text-align: center;
            padding: 0;
        }

        .pdf-center-wrapper,
        .pdf-full-wrapper {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: fit-content;
            margin: 0 auto;
            text-align: center;
            /* ‰∏ä‰∏ã„Å´40px„ÄÅÂ∑¶Âè≥„Å´20px„ÅÆ„Äå„Ç∞„É¨„Éº„ÅÆÈöôÈñì„Äç„ÇíÂÜÅEÅE„Å´‰Ωú„Çã */
            padding: 40px 20px;
            background-color: transparent !important;
            /* ÁÆ±„ÅØÈÄèÊÅE„Å´„Åó„Å¶PDF„ÅÆÁôΩ„Åå‰º∏„Å≥„Çã„ÅE„ÇíÈò≤Ê≠¢ */
        }

        canvas.pdf-page-canvas {
            display: block;
            margin: 0 auto 20px auto;
            /* „Éö„ÅE„Ç∏„Å®„Éö„ÅE„Ç∏„ÅÆÈñìÈöî„ÇÅE0px„Å´ */
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
            background-color: #fff;
            /* ÁôΩ„ÅÅEÅE„ÅØ„Åì„ÅEÁ¥ôÔºÅEanvasÅEâ„Å†„ÅÅE*/
            flex-shrink: 0;
            /* Á∏Æ„ÅøÈò≤Ê≠¢ */
        }

        /* ÊúÄÂæå„ÅE„Éö„ÅE„Ç∏„ÅÆ‰∏ã„ÅE„Éº„Ç∏„É≥„ÇíÊ∂à„Åô„Åì„Å®„Åß„ÄÅwrapper„ÅÆpadding(40px)„ÅåÊ≠£Á¢∫„Å´Â∫ï‰ΩôÁôΩ„Å´„Å™„ÇÅE*/
        canvas.pdf-page-canvas:last-child {
            margin-bottom: 0;
        }

        #pc-pdf-container:active {
            cursor: grabbing;
        }

        #mobile-pdf-container {
            height: 100%;
            width: 100%;
            position: relative;
            background-color: #333;
        }

        .pdf-content-wrapper {
            transform-origin: 0 0;
            position: absolute;
            top: 0;
            left: 0;
            opacity: 0;
            transition: opacity 0.2s ease-in;
        }

        .pdf-content-wrapper.loaded {
            opacity: 1;
        }

        .db-item:hover {
            background-color: #f3f4f6;
        }

        .cursor-pointer {
            cursor: pointer;
        }



        /* Sign-in bars (non-sticky) */
        .signin-bar {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .signin-badge {
            padding: 4px 8px;
            background: #fff;
            border: 1px solid #dadfe6;
            border-radius: 8px;
            color: #222;
            max-width: 240px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            font-size: 12px;
        }

        .signin-actions button {
            padding: 4px 8px;
            border-radius: 6px;
            border: 1px solid #dadfe6;
            background: #fff;
            cursor: pointer;
            font-size: 12px;
        }

        .signin-actions button.accent {
            background: #10b981;
            color: #fff;
            border-color: #10b981;
        }

        /* Wizard Styles */
        .step-container {
            display: none;
        }

        .step-container.active {
            display: block;
        }

        .wizard-step-dot {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            background: #e2e8f0;
            color: #64748b;
        }

        .wizard-step-dot.active {
            background: #4f46e5;
            color: #fff;
        }

        .wizard-step-dot.completed {
            background: #10b981;
            color: #fff;
        }

        /* Sign-in View Styles */
        #signinView {
            position: fixed;
            inset: 0;
            z-index: 1000;
            background: linear-gradient(135deg, #6366f1 0%, #312e81 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 16px;
        }

        .signin-card {
            background: #fff;
            padding: 32px;
            border-radius: 24px;
            width: 100%;
            max-width: 400px;
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1);
        }

        .pin-digit {
            -webkit-text-security: disc;
            font-family: monospace;
            letter-spacing: 0.5em;
            text-align: center;
            font-size: 24px;
        }

        /* Overflow Menu Styles */
        #moreMenu {
            display: none;
            position: absolute;
            top: 100%;
            right: 0;
            background: #fff;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            min-width: 220px;
            z-index: 50;
            padding: 8px 0;
            white-space: nowrap;
        }

        #moreMenu.active {
            display: block;
        }

        .more-item {
            display: block;
            width: 100%;
            padding: 10px 16px;
            text-align: left;
            font-size: 13px;
            font-weight: 600;
            color: #4b5563;
            border-bottom: 1px solid #f1f5f9;
        }

        .more-item:last-child {
            border-bottom: none;
        }

        .more-item:hover {
            background: #f8fafc;
            color: #4f46e5;
        }

        /* --- Usability Polishing Styles --- */
        .validation-error {
            outline: 2px solid #f87171 !important;
            box-shadow: 0 0 0 2px #f87171;
        }

        .selected-row {
            background-color: #eef2ff !important;
            border-color: #6366f1 !important;
        }

        #toast-root {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 20000;
            display: flex;
            flex-direction: column;
            gap: 8px;
            pointer-events: none;
        }

        .toast {
            pointer-events: auto;
            min-width: 200px;
            max-width: 320px;
            padding: 12px 16px;
            border-radius: 12px;
            background: #fff;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 14px;
            font-weight: 600;
            animation: toast-in 0.3s cubic-bezier(0, 0, 0.2, 1) forwards;
            border-left: 4px solid #6366f1;
        }

        .toast.success {
            border-left-color: #10b981;
        }

        .toast.error {
            border-left-color: #ef4444;
        }

        .toast.info {
            border-left-color: #3b82f6;
        }

        /* „É¶„Éº„Ç∂„Éº„É°„Éã„É•„Éº„Éª„Éâ„É≠„ÉÅEÅE„ÉÄ„Ç¶„É≥ */
        #userDropdown {
            /* display: none;  <-- Removed to let Tailwind 'hidden' class work */
            position: absolute;
            top: 100%;
            right: 0;
            margin-top: 8px;
            width: 200px;
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            z-index: 100;
        }

        #userDropdown.active {
            display: block;
        }

        .user-dropdown-item {
            display: flex;
            align-items: center;
            gap: 10px;
            width: 100%;
            padding: 12px 16px;
            text-align: left;
            font-size: 13px;
            font-weight: 600;
            color: #4b5563;
            transition: all 0.2s;
        }

        .user-dropdown-item:hover {
            background: #f8fafc;
            color: #4f46e5;
        }

        .user-dropdown-item.text-red-500:hover {
            background: #fef2f2;
            color: #ef4444;
        }

        /* [NEW] Unified Spinner System */
        .spinner {
            display: inline-block;
            /* Default to 1em so it scales with font if no size class */
            width: 1em;
            height: 1em;
            border: 2px solid currentColor;
            border-right-color: transparent;
            border-radius: 9999px;
            animation: spin 1s linear infinite;
            vertical-align: middle;
        }

        /* Overlay Spinner - Large */
        .spinner-overlay .spinner {
            width: 3rem;
            height: 3rem;
            border-width: 4px;
        }

        /* Contextual Colors */
        .bg-white .spinner,
        .spinner-on-white .spinner,
        .spinner-on-white.spinner {
            color: #4f46e5;
            /* Indigo-600 */
        }

        .bg-indigo-600 .spinner,
        .bg-red-600 .spinner,
        .bg-gray-600 .spinner,
        .spinner-white .spinner,
        .spinner-white.spinner {
            color: #fff;
        }

        @keyframes spin {
            from {
                transform: rotate(0deg);
            }

            to {
                transform: rotate(360deg);
            }
        }

        /* Utility Classes */
        .cursor-not-allowed {
            cursor: not-allowed !important;
        }

        .opacity-75 {
            opacity: 0.75;
        }

        .hidden {
            display: none !important;
        }

        .show {
            display: flex !important;
        }

        /* For Overlay */
        .ml-2 {
            margin-left: 0.5rem;
        }

        /* Overlay Styles */
        .spinner-overlay {
            position: fixed;
            inset: 0;
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(2px);
            z-index: 9999;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .spinner-overlay.hidden {
            display: none !important;
        }

        /* Keep fa-spin for other icons if needed, but not for main loader */
        @keyframes fa-spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .fa-spin {
            animation: fa-spin 2s infinite linear;
        }

        @keyframes toast-in {
            from {
                transform: translateX(100%);
                opacity: 0;
            }

            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .toast.toast-out {
            animation: toast-out 0.3s cubic-bezier(0, 0, 0.2, 1) forwards;
        }

        @keyframes toast-out {
            from {
                transform: translateX(0);
                opacity: 1;
            }

            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }

        /* [v41 Fix] Z-Index Management & Modal Layers */
        /* Dropbox„ÅÅE0„ÄÅPDF„Éó„É¨„Éì„É•„Éº„ÅÅE0 (Dropbox„Çà„Çä‰∏ÅE„ÄÅToast„ÅÅE0000 */
        #dropbox-modal {
            z-index: 60 !important;
        }

        #mobile-pdf-modal {
            z-index: 70 !important;
        }

        #success-modal {
            z-index: 16000 !important;
        }

        /* FAB (Add Button) - Ensure visibility control */
        #fab-add {
            z-index: 40 !important;
            /* „É°„Éã„É•„Éº(50)„Çà„Çä„ÅØ‰∏ÅE*/
        }

        .loading-overlay {
            position: fixed;
            inset: 0;
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(2px);
            z-index: 11000;
            /* Force Flex Centering */
            display: flex !important;
            flex-direction: column;
            align-items: center !important;
            justify-content: center !important;
        }

        .loading-overlay.hidden {
            display: none !important;
        }


        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f4f6;
            border-top: 4px solid #6366f1;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .glass-card {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(25px);
            -webkit-backdrop-filter: blur(25px);
            border: 1px solid rgba(255, 255, 255, 0.4);
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.1);
        }

        .forest-gradient {
            background: linear-gradient(135deg, #1e3a34 0%, #2d5a27 50%, #4a7c44 100%);
        }

        .ginkgo-bg-overlay {
            background-image: radial-gradient(circle at 2px 2px, rgba(234, 179, 8, 0.1) 1px, transparent 0);
            background-size: 32px 32px;
        }

        @keyframes float {
            0% {
                transform: translateY(0px) rotate(0deg);
            }

            50% {
                transform: translateY(-15px) rotate(5deg);
            }

            100% {
                transform: translateY(0px) rotate(0deg);
            }
        }

        .float-leaf {
            animation: float 8s ease-in-out infinite;
        }

        /* Êñ∞„Çµ„Ç§„É≥„Ç§„É≥ÁîªÈù¢Áî®„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥ & „Çπ„Çø„Ç§„É´ */
        @keyframes float {
            0% {
                transform: translateY(0px) rotate(0deg);
            }

            50% {
                transform: translateY(-10px) rotate(5deg);
            }

            100% {
                transform: translateY(0px) rotate(0deg);
            }
        }

        .floating-leaf {
            animation: float 6s ease-in-out infinite;
        }

        .floating-leaf-delay {
            animation: float 8s ease-in-out infinite;
            animation-delay: 1s;
        }

        .glass-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }

        /* ÈÅ∏ÊäûÁä∂ÊÖã„ÅEPIN„Éâ„ÉÉ„ÉÅE*/
        .pin-dot.active {
            background-color: #fbb116;
            /* ginkgo-400 */
            transform: scale(1.1);
        }

        /* [Fix] Pre-init: Hide app until filter is restored to prevent flash */
        .pre-init #appView {
            visibility: hidden !important;
        }
    </style>
</head>

<body class="bg-gray-50 text-gray-800 pre-init">
    <!-- Dedicated Sign-in View -->
    <!-- Sign-in View (Full Screen) -->
    <div id="signinView"
        class="hidden fixed inset-0 z-[9999] flex items-center justify-center p-4 transition-all duration-500 bg-yellow-50 overflow-hidden"
        style="display: none;">

        <div
            class="glass-card w-full max-w-md rounded-3xl shadow-xl overflow-hidden z-10 border border-ginkgo-100 flex flex-col max-h-[95vh]">
            <!-- „Éò„ÉÉ„ÉÄ„Éº -->
            <div class="bg-ginkgo-600 p-8 text-center relative shrink-0">
                <div class="w-16 h-16 bg-white rounded-full flex items-center justify-center shadow-md mx-auto mb-3">
                    <i class="fas fa-leaf text-ginkgo-600 text-3xl"></i>
                </div>
                <h1 class="text-white text-xl font-bold">„ÅÅEÅ°„ÇÅEÅÜ„ÅÆÊ£Æ</h1>
                <p class="text-white/90 text-sm font-bold tracking-wider">ÊîØÊè¥Ë®òÈå≤„Ç∑„Çπ„ÉÅEÉ†</p>
            </div>

            <!-- „Éï„Ç©„Éº„É† -->
            <div class="p-6 pt-12 flex-1 overflow-y-auto" style="-webkit-overflow-scrolling: touch;">
                <!-- „Ç®„É©„ÉºË°®Á§∫ -->
                <div id="signin-error"
                    class="hidden mb-4 p-3 rounded-lg bg-red-50 text-red-600 text-xs font-bold border border-red-100 flex items-center gap-2">
                    <i class="fas fa-exclamation-circle"></i> <span id="signin-error-text"></span>
                </div>

                <!-- ‰∫ãÊ•≠ÊâÄÈÅ∏ÊäÅE-->
                <div class="mb-4">
                    <label class="block text-xs font-bold text-gray-500 mb-1 pl-1" for="signinOffice">‰∫ãÊ•≠ÊâÄ</label>
                    <div class="relative">
                        <select id="signinOffice"
                            class="w-full bg-gray-50 border border-gray-200 text-gray-800 py-3 px-4 rounded-xl focus:ring-2 focus:ring-ginkgo-400 font-bold text-sm appearance-none">
                            <option value="">Ë™≠„ÅøËæº„Åø‰∏≠... </option>
                        </select>
                        <!-- Custom Spinner for Signin (White) -->
                        <!-- Custom Spinner for Signin (White) - Removed -->
                        <div
                            class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-4 text-gray-400">
                            <i class="fas fa-chevron-down text-xs"></i>
                        </div>
                    </div>
                </div>

                <!-- ËÅ∑Âì°ÈÅ∏ÊäÅE-->
                <div class="mb-6">
                    <label class="block text-xs font-bold text-gray-500 mb-1 pl-1" for="staffSelect">ËÅ∑Âì°ÂêÅE/label>
                        <div class="relative">
                            <select id="staffSelect"
                                class="w-full bg-gray-50 border border-gray-200 text-gray-800 py-3 px-4 rounded-xl focus:ring-2 focus:ring-ginkgo-400 font-bold text-sm appearance-none"
                                disabled>
                                <option value="">‰∫ãÊ•≠ÊâÄ„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ</option>
                            </select>
                            <div
                                class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-4 text-gray-400">
                                <i class="fas fa-chevron-down text-xs"></i>
                            </div>
                        </div>
                </div>

                <!-- PINÂÖ•ÂäÅE(Ê®ôÊ∫ñÂÅEÂäõ„Å´Â§âÊõ¥) -->
                <div class="mb-8">
                    <label class="block text-xs font-bold text-gray-500 mb-2 pl-1 uppercase tracking-widest text-center"
                        for="pinInput">PIN
                        (4Ê°ÅE</label>
                    <input type="password" id="pinInput" maxlength="4" inputmode="numeric"
                        class="w-full bg-gray-50 border border-gray-200 text-gray-800 py-4 px-4 rounded-xl focus:ring-2 focus:ring-ginkgo-400 font-bold text-2xl text-center tracking-[1em] placeholder:tracking-normal"
                        placeholder="¬∑¬∑¬∑¬∑">
                </div>

                <button id="btnSigninGo"
                    class="w-full bg-ginkgo-500 text-white font-bold py-4 rounded-xl shadow-lg hover:bg-ginkgo-600 transition-all duration-200 flex items-center justify-center gap-2">
                    <span>„Çµ„Ç§„É≥„Ç§„É≥</span> <i class="fas fa-arrow-right"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- Main App View -->
    <div id="appView" class="flex flex-col h-screen overflow-hidden" style="display:none;">

        <!-- Header (No Sticky, Flex Child)-->
        <!-- [v33 Fix] touch-action: manipulation to prevent scroll freeze on header touch -->
        <div id="appHeader" class="bg-white border-b border-gray-200 shadow-sm shrink-0 z-40"
            style="touch-action: manipulation;">
            <div class="max-w-7xl mx-auto px-2 sm:px-6">
                <div
                    class="flex justify-between items-center py-2 gap-2 border-b border-gray-100 sm:border-none mb-1 sm:mb-0">
                    <!-- Left: Logo & PC User Select -->
                    <div class="flex items-center gap-4">
                        <h1 onclick="switchView('list')"
                            class="text-lg sm:text-xl font-bold text-gray-800 flex items-center gap-2 shrink-0 cursor-pointer hover:opacity-70 transition"
                            title="„É°„Ç§„É≥ÁîªÈù¢„Å∏">
                            <!-- Logo Icon -->
                            <div
                                class="w-8 h-8 rounded-lg bg-gradient-to-br from-indigo-500 to-purple-600 flex items-center justify-center text-white shadow-md">
                                <i class="fas fa-feather-alt text-sm"></i>
                            </div>
                            <!-- Title Text -->
                            <span class="font-bold text-gray-800">ÊîØÊè¥Ë®òÈå≤</span>
                        </h1>
                        <!-- PC User Selector -->
                        <div class="w-64" id="header-user-pc-container">
                            <select id="user-selector-pc" aria-label="Âà©Áî®ËÄÅEÅ∏ÊäÅE
                                class=" w-full p-2 bg-gray-50 border border-gray-300 rounded-lg text-sm font-medium
                                text-gray-700 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                                <!-- Populated by JS -->
                            </select>
                        </div>
                    </div>
                    <!-- Right Side: User Icon, Refresh, PC Menu, Hamburger -->
                    <div class="flex items-center gap-2" id="toolbar">

                        <!-- 1. User Icon (Visible on All Devices) -->
                        <!-- 1. User Icon (Visible on All Devices) -->
                        <div class="relative shrink-0 flex items-center">
                            <button onclick="toggleUserDropdown()" id="userAvatarBtn"
                                class="flex w-9 h-9 sm:w-10 sm:h-10 rounded-full bg-indigo-50 border-2 border-indigo-100 items-center justify-center text-indigo-500 hover:bg-indigo-100 transition shadow-sm overflow-hidden z-20 relative">
                                <i class="fas fa-user text-base sm:text-lg"></i>
                            </button>

                            <!-- User Dropdown (Same as before) -->
                            <div id="userDropdown"
                                class="hidden absolute top-full right-0 mt-2 w-52 bg-white border border-gray-200 rounded-xl shadow-xl z-[100] overflow-hidden transform origin-top-right transition-all">
                                <div class="px-4 py-3 border-b border-gray-100 bg-gray-50/50 flex items-center gap-3">
                                    <div id="dropdownAvatar" class="shrink-0"></div>
                                    <div class="overflow-hidden">
                                        <p class="text-[10px] font-bold text-gray-400 uppercase tracking-widest mb-0.5">
                                            „É≠„Ç∞„Ç§„É≥‰∏≠</p>
                                        <p id="dropdownUserName" class="text-sm font-bold text-gray-800 truncate">
                                            Êú™„É≠„Ç∞„Ç§„É≥
                                        </p>
                                    </div>
                                </div>
                                <div class="p-1">
                                    <button onclick="openUserSwitchModal()" class="user-dropdown-item rounded-lg">
                                        <i class="fas fa-user-friends opacity-70"></i> <span>„É¶„Éº„Ç∂„ÉºÂàÅEÇäÊõø„ÅÅE/span>
                                    </button>
                                    <button
                                        onclick="clearWhoami(); document.getElementById('userDropdown').classList.add('hidden')"
                                        class="user-dropdown-item rounded-lg text-red-500">
                                        <i class="fas fa-sign-out-alt opacity-70"></i> <span>„É≠„Ç∞„Ç¢„Ç¶„ÉÅE/span>
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- 2. Refresh Button (Visible on All Devices) -->
                        <button onclick="reloadApp()" id="btn-refresh"
                            class="flex items-center justify-center w-9 h-9 sm:w-auto sm:h-auto sm:px-3 sm:py-1.5 text-gray-700 bg-white rounded-lg border border-gray-300 hover:bg-gray-50 transition font-bold"
                            title="Êõ¥Êñ∞">
                            <i class="fas fa-sync-alt text-gray-400"></i>
                            <span class="hidden lg:inline ml-1">Êõ¥Êñ∞</span>
                        </button>

                        <!-- 3. PC Menu Items (Visibility controlled by CSS) -->
                        <div id="toolbar-pc" class="items-center gap-2">
                            <button onclick="openIncidentSection()" id="btn-incident-nav"
                                class="flex items-center gap-1 text-sm text-gray-700 bg-white px-3 py-1.5 rounded-lg border border-gray-300 hover:bg-gray-50 transition font-bold"
                                title="‰∫ãÊïÖÂ†±ÂëÅE>
                                <i class=" fas fa-exclamation-triangle text-orange-500"></i>
                                <span class="hidden lg:inline">‰∫ãÊïÖÂ†±ÂëÅE/span>
                            </button>
                            <button onclick="switchView('output')" id="btn-view-output"
                                class="flex items-center gap-1 text-sm text-indigo-600 bg-indigo-50 px-3 py-1.5 rounded-lg border border-indigo-100 hover:bg-indigo-100 transition font-bold"
                                title="Âá∫ÂäÅE>
                                <i class=" fas fa-file-export"></i>
                                <span class="hidden lg:inline">Âá∫ÂäÅE/span>
                            </button>

                            <!-- Flattened Menu Items: Dropbox & Trash -->
                            <button onclick="openDropboxBrowser()" id="btn-dropbox"
                                class="flex items-center gap-1 text-sm text-gray-700 bg-white px-3 py-1.5 rounded-lg border border-gray-300 hover:bg-gray-50 transition font-bold"
                                title="Dropbox„Éï„Ç©„É´„ÉÄ„Éº">
                                <span>üìÇ</span>
                                <span class="hidden lg:inline">Dropbox</span>
                            </button>
                            <button onclick="openTrashModal()" id="btn-trash"
                                class="flex items-center gap-1 text-sm text-gray-700 bg-white px-3 py-1.5 rounded-lg border border-gray-300 hover:bg-gray-50 transition font-bold"
                                title="„Ç¥„ÉüÁÆ±">
                                <span>üóëÅEÅE/span>
                                    <span class="hidden lg:inline">„Ç¥„ÉüÁÆ±</span>
                            </button>
                        </div>

                        <!-- 4. Hamburger Menu (Mobile Only) -->
                        <div id="mobile-menu-btn">
                            <button onclick="toggleMobileMenu()"
                                class="p-2 text-gray-600 hover:bg-gray-100 rounded-lg border border-gray-200 transition-colors">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M4 6h16M4 12h16M4 18h16"></path>
                                </svg>
                            </button>
                        </div>
                    </div>
                </div>
                <!-- Global Navigation Drawer (Mobile/PC) -->
                <div id="mobile-menu"
                    class="hidden absolute top-14 left-0 right-0 bg-white border-b shadow-lg p-2 space-y-2 z-[60]">
                    <!-- Hidden from Header -->
                    <button onclick="openIncidentSection(); toggleMobileMenu()"
                        class="w-full text-left px-4 py-3 font-bold text-gray-700 hover:bg-gray-100 rounded-lg flex items-center gap-2"><span
                            class="text-lg">‚ö†</span> ‰∫ãÊïÖÂ†±ÂëÅE(Wizard)</button>
                    <button onclick="switchView('output'); toggleMobileMenu()"
                        class="w-full text-left px-4 py-3 font-bold text-gray-700 hover:bg-gray-100 rounded-lg flex items-center gap-2"><span
                            class="text-lg">üìÑ</span> „É¨„Éù„ÅE„ÉàÂÅEÂäÅE/button>

                        <div class="h-px bg-gray-100 mx-2 my-1"></div>

                        <!-- Kebab Items -->
                        <button onclick="openDropboxBrowser(); toggleMobileMenu()"
                            class="w-full text-left px-4 py-3 font-bold text-gray-700 hover:bg-gray-100 rounded-lg flex items-center gap-2"><span
                                class="text-lg">üìÇ</span> Dropbox„Éï„Ç©„É´„ÉÄ„Éº</button>
                        <button onclick="openTrashModal(); toggleMobileMenu()"
                            class="w-full text-left px-4 py-3 font-bold text-gray-700 hover:bg-gray-100 rounded-lg flex items-center gap-2"><span
                                class="text-lg">üóëÅEÅE/span> „Ç¥„ÉüÁÆ±</button>
                </div>

                <!-- Mobile Sign-in Bar („Éü„Éã„Éê„ÅE) -->
                <!-- Mobile Sign-in Bar Removed -->

                <!-- Header Controls & Tabs -->
                <div id="header-controls-list" class="pb-2 flex flex-col gap-2 items-start">
                    <div class="md:hidden w-full"><select id="user-selector-sp" aria-label="Âà©Áî®ËÄÅEÅ∏ÊäÅE
                            class=" w-full p-2 bg-gray-50 border border-gray-300 rounded-lg text-sm focus:ring-2
                            focus:ring-indigo-500 font-medium text-gray-700"></select>
                    </div>
                    <div
                        class="flex flex-col md:flex-row md:items-center gap-2 bg-gray-50 p-2 rounded-lg border border-gray-200 w-full md:w-fit">
                        <div class="flex items-center justify-between w-full md:w-auto gap-2">
                            <div class="flex bg-white rounded-md shadow-sm p-0.5 border border-gray-200 shrink-0">
                                <button onclick="setGranularity('day')" id="seg-day"
                                    class="segment-btn active px-3 py-1.5 text-xs font-bold rounded transition">Êó•</button>
                                <button onclick="setGranularity('week')" id="seg-week"
                                    class="segment-btn px-3 py-1.5 text-xs font-bold rounded transition">ÈÄ±</button>
                                <button onclick="setGranularity('month')" id="seg-month"
                                    class="segment-btn px-3 py-1.5 text-xs font-bold rounded transition">ÊúÅE/button>
                            </div>
                            <div class="flex items-center gap-1">
                                <button onclick="shiftDate(-1)"
                                    class="p-1.5 bg-white border border-gray-200 rounded hover:text-indigo-600 transition"><svg
                                        class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M15 19l-7-7 7-7" />
                                    </svg></button>
                                <button onclick="setToday()" id="btn-current"
                                    class="px-3 py-1.5 text-xs font-bold text-gray-700 bg-white border border-gray-200 rounded hover:text-indigo-600 transition w-16">‰ªäÊó•„Å∏</button>
                                <button onclick="shiftDate(1)"
                                    class="p-1.5 bg-white border border-gray-200 rounded hover:text-indigo-600 transition"><svg
                                        class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M9 5l7 7-7 7" />
                                    </svg></button>
                            </div>
                        </div>
                        <div
                            class="flex items-center justify-between w-full md:w-auto gap-2 border-t border-gray-200 pt-2 md:border-none md:pt-0 md:ml-2">
                            <div id="current-date-display"
                                class="text-sm font-bold text-gray-800 truncate text-left md:text-center px-2 md:min-w-[140px] flex-grow md:flex-grow-0">
                                2024/01/01 (ÊúÅE</div>
                            <button onclick="toggleDetailPanel()"
                                class="px-2 py-1 text-xs text-gray-500 hover:text-indigo-600 flex items-center gap-1 shrink-0 ml-auto bg-white border border-gray-200 rounded md:bg-transparent md:border-none">Ë©≥Á¥∞
                                <svg id="detail-icon" class="w-3 h-3 transition-transform" fill="none"
                                    stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M19 9l-7 7-7-7" />
                                </svg></button>
                        </div>
                    </div>
                    <div id="detail-panel"
                        class="hidden bg-white border border-gray-200 rounded-lg p-3 shadow-sm text-sm w-full md:w-fit transition-all">
                        <div class="flex flex-col md:flex-row items-center gap-3">
                            <div class="flex items-center gap-2 w-full md:w-auto"><label
                                    class="text-gray-500 text-xs font-bold shrink-0"
                                    for="custom-start">ÈñãÂßÅE</label><input type="date" id="custom-start"
                                    class="border border-gray-300 rounded p-1 text-sm w-full md:w-auto">
                            </div>
                            <div class="flex items-center gap-2 w-full md:w-auto"><label
                                    class="text-gray-500 text-xs font-bold shrink-0" for="custom-end">ÁµÇ‰∫ÅE</label><input
                                    type="date" id="custom-end"
                                    class="border border-gray-300 rounded p-1 text-sm w-full md:w-auto">
                            </div>
                            <div
                                class="flex items-center gap-2 w-full md:w-auto md:ml-2 pt-2 md:pt-0 border-t border-gray-100 md:border-none mt-2 md:mt-0">
                                <label class="flex items-center gap-1 cursor-pointer mr-2 hidden">
                                    <input type="checkbox" id="include-archive" class="w-4 h-4 text-indigo-600 rounded">
                                    <span class="text-xs font-bold text-gray-500">„Ç¢„Éº„Ç´„Ç§„Éñ„ÇíÂê´„ÇÅ„Çã</span>
                                </label>
                                <button onclick="resetToDefault()"
                                    class="flex-1 px-3 py-1.5 border border-gray-300 rounded text-xs font-bold whitespace-nowrap">„ÇØ„É™„Ç¢</button>
                                <button onclick="applyCustomRange()"
                                    class="flex-1 px-4 py-1.5 bg-indigo-600 text-white rounded text-xs font-bold whitespace-nowrap">ÈÅ©Áî®</button>
                            </div>
                        </div>
                    </div>
                </div>
                <div id="header-tabs-list"
                    class="flex space-x-1 overflow-x-auto whitespace-nowrap hide-scrollbar pb-0.5 mt-1 border-b border-gray-200"
                    style="-webkit-overflow-scrolling: touch;">
                    <button class="record-item-tab tab-active px-4 py-2 text-sm font-medium border-b-2 transition"
                        data-item="all">ÂÖ®„Å¶ <span id="badge-all"
                            class="bg-gray-200 text-gray-600 text-xs px-1.5 rounded-full">0</span></button>
                    <button
                        class="record-item-tab px-4 py-2 text-sm font-medium border-b-2 border-transparent text-gray-500"
                        data-item="ÊéíÊ≥ÅE>ÊéíÊ≥ÅE<span id=" badge-ÊéíÊ≥ÅE
                        class="bg-gray-100 text-gray-400 text-xs px-1.5 rounded-full">0</span></button>
                    <button
                        class="record-item-tab px-4 py-2 text-sm font-medium border-b-2 border-transparent text-gray-500"
                        data-item="ÊúçËñ¨">ÊúçËñ¨ <span id="badge-ÊúçËñ¨"
                            class="bg-gray-100 text-gray-400 text-xs px-1.5 rounded-full">0</span></button>
                    <button
                        class="record-item-tab px-4 py-2 text-sm font-medium border-b-2 border-transparent text-gray-500"
                        data-item="„Éê„Ç§„Çø„É´">„Éê„Ç§„Çø„É´ <span id="badge-„Éê„Ç§„Çø„É´"
                            class="bg-gray-100 text-gray-400 text-xs px-1.5 rounded-full">0</span></button>
                    <button
                        class="record-item-tab px-4 py-2 text-sm font-medium border-b-2 border-transparent text-gray-500"
                        data-item="È£ü‰∫ÅE>È£ü‰∫ÅE<span id=" badge-È£ü‰∫ÅE
                        class="bg-gray-100 text-gray-400 text-xs px-1.5 rounded-full">0</span></button>
                    <button
                        class="record-item-tab px-4 py-2 text-sm font-medium border-b-2 border-transparent text-gray-500"
                        data-item="„Åù„ÅE‰ªÅE>„Åù„ÅE‰ªÅE<span id=" badge-„Åù„ÅE‰ªÅE
                        class="bg-gray-100 text-gray-400 text-xs px-1.5 rounded-full">0</span></button>
                </div>
            </div>
        </div>

        <!-- Main Content Wrapper (Scrollable) -->
        <div id="main-scroll-wrapper">
            <div id="app" class="max-w-7xl mx-auto p-4 sm:p-6 fab-safe-area">
                <div id="loading-initial" class="hidden flex flex-col items-center justify-center h-64">
                    <div class="spinner text-indigo-600 w-8 h-8"></div>
                </div>
                <div id="main-content" class="hidden">
                    <!-- List View -->
                    <div id="view-list">
                        <div id="records-container" class="space-y-3">
                            <div
                                class="hidden sm:grid grid-cols-12 gap-4 px-4 py-2 bg-gray-200 text-xs font-bold text-gray-600 uppercase tracking-wider rounded-lg">
                                <div class="col-span-2">Êó•ÊôÅE/div>
                                    <div class="col-span-2">È†ÅEõÆ„ÉªË©≥Á¥∞</div>
                                    <div class="col-span-5">ÁµåÈÅéÂÜÅEÆπ</div>
                                    <div class="col-span-1">Ë®òÈå≤ËÄÅE/div>
                                        <div class="col-span-2 text-right">Êìç‰ΩÅE/div>
                                        </div>
                                        <div id="record-list-container" class="space-y-3 sm:space-y-0"></div>
                                        <!-- Load More Button -->
                                        <div id="load-more-container" class="hidden mt-6 pb-20 text-center">
                                            <button onclick="loadMore()" id="btn-load-more"
                                                class="px-8 py-3 bg-white border-2 border-indigo-100 text-indigo-600 rounded-xl font-bold hover:bg-indigo-50 transition shadow-sm flex items-center justify-center gap-2 mx-auto disabled:opacity-50">
                                                <div id="load-more-loader" class="hidden"></div>
                                                <span>„Åï„Çâ„Å´Ë™≠„ÅøËæº„ÇÄ</span>
                                            </button>
                                        </div>
                                    </div>
                                </div>

                                <!-- Output View -->
                                <div id="view-output" class="hidden">
                                    <div class="bg-white p-6 rounded-xl border border-gray-200 shadow-sm text-center">
                                        <h2 class="text-xl font-bold text-gray-800 mb-4">ÊúàÊ¨°„É¨„Éù„ÅE„ÉàÂÅEÂäÅE/h2>
                                            <div
                                                class="flex flex-col sm:flex-row justify-center items-center gap-4 mb-6">
                                                <label for="output-month" class="font-bold text-gray-600">ÂØæË±°ÊúÅE</label>
                                                <input type="month" id="output-month"
                                                    class="p-2 border rounded-lg w-full sm:w-auto">
                                                <button id="btn-generate-pdf" onclick="requestPdfGeneration()"
                                                    class="px-6 py-2 bg-indigo-600 text-white rounded-lg font-bold shadow hover:bg-indigo-700 transition w-full sm:w-auto flex items-center justify-center gap-2">
                                                    <span>„Éó„É¨„Éì„É•„Éº‰ΩúÊÅE</span>
                                                    <div id="pdf-gen-loader" class="hidden"></div>
                                                </button>
                                            </div>
                                            <div id="report-message" class="hidden mb-4"></div>
                                            <div id="report-preview-area" class="hidden border-t pt-6 text-left">
                                                <div class="flex flex-col sm:flex-row justify-center gap-4 mb-6">
                                                    <a id="btn-download-pdf" href="#"
                                                        class="px-4 py-2 bg-emerald-600 text-white rounded-lg font-bold hover:bg-emerald-700 flex items-center justify-center gap-2 no-underline text-center"><svg
                                                            class="w-5 h-5" fill="none" stroke="currentColor"
                                                            viewBox="0 0 24 24">
                                                            <path stroke-linecap="round" stroke-linejoin="round"
                                                                stroke-width="2"
                                                                d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4">
                                                            </path>
                                                        </svg> PDF„ÉÄ„Ç¶„É≥„É≠„Éº„ÉÅE/a>
                                                        <button id="btn-save-dropbox" onclick="saveToDropbox()"
                                                            class="px-4 py-2 bg-blue-600 text-white rounded-lg font-bold hover:bg-blue-700 flex items-center justify-center gap-2"><svg
                                                                class="w-5 h-5" fill="none" stroke="currentColor"
                                                                viewBox="0 0 24 24">
                                                                <path stroke-linecap="round" stroke-linejoin="round"
                                                                    stroke-width="2"
                                                                    d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4">
                                                                </path>
                                                            </svg> <span>Dropbox„Å∏‰øùÂ≠ÅE/span>
                                                                <div id="dropbox-save-loader" class="hidden"></div>
                                                        </button>
                                                        <button onclick="openFullPreview()"
                                                            class="sm:hidden px-4 py-2 bg-gray-600 text-white rounded-lg font-bold hover:bg-gray-700 flex items-center justify-center gap-2">ÂÖ®ÁîªÈù¢„ÅßË¶ã„Çã</button>
                                                        <button onclick="resetOutputView()"
                                                            class="px-4 py-2 border border-gray-300 text-gray-600 rounded-lg font-bold hover:bg-gray-50">ÂÆå‰∫ÅEÅó„Å¶Êàª„ÇÅE/button>
                                                </div>
                                                <!-- PCÁî® Âüã„ÇÅËæº„Åø„Éó„É¨„Éì„É•„Éº -->
                                                <div id="pc-preview-wrapper"
                                                    class="hidden sm:block w-full border border-gray-400 rounded-lg overflow-hidden flex flex-col h-[700px]">
                                                    <div
                                                        class="bg-gray-200 p-2 border-b flex justify-between items-center px-4 shrink-0">
                                                        <span class="text-xs font-bold text-gray-600">„Éó„É¨„Éì„É•„Éº
                                                            („Éâ„É©„ÉÅEÇ∞„Åß„Çπ„ÇØ„É≠„Éº„É´)</span>
                                                        <div class="flex items-center gap-3">
                                                            <span id="zoom-level"
                                                                class="text-xs font-bold bg-white px-2 py-1 rounded">100%</span>
                                                            <div class="flex items-center bg-white rounded border">
                                                                <button onclick="changePdfZoom(25)"
                                                                    class="px-2 py-1 text-gray-600 hover:bg-gray-50 border-r"
                                                                    title="Êã°Â§ß">ÅEÅE/button>
                                                                    <button onclick="changePdfZoom(-25)"
                                                                        class="px-2 py-1 text-gray-600 hover:bg-gray-50"
                                                                        title="Á∏ÆÂ∞ÅE>ÅEÅE/button>
                                            </div>
                                            <button onclick=" openFullPreview()"
                                                                        class="px-2 py-1 bg-white border rounded text-xs hover:bg-gray-50 flex items-center gap-1"
                                                                        title="ÂÖ®ÁîªÈù¢Ë°®Á§∫"><svg class="w-3 h-3"
                                                                            fill="none" stroke="currentColor"
                                                                            viewBox="0 0 24 24">
                                                                            <path stroke-linecap="round"
                                                                                stroke-linejoin="round" stroke-width="2"
                                                                                d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4">
                                                                            </path>
                                                                        </svg></button>
                                                            </div>
                                                        </div>
                                                        <div id="pc-pdf-container"></div>
                                                    </div>
                                                </div>
                                            </div>
                                    </div>

                                </div>

                                <!-- Incident Tabs & Sections -->
                                <div id="incident-container"
                                    class="hidden flex-1 flex flex-col min-height-0 overflow-hidden bg-white">
                                    <!-- Tabs -->
                                    <div id="incidentTabs" class="flex border-b bg-gray-50 shrink-0">
                                        <button id="tabIncidentPending" onclick="switchIncidentTab('pending')"
                                            class="flex-1 py-3 px-4 text-sm font-bold border-b-2 border-indigo-600 text-indigo-600 bg-white transition">
                                            ÂØæÂøúÂæÅEÅ°
                                        </button>
                                        <button id="tabIncidentHistory" onclick="switchIncidentTab('history')"
                                            class="flex-1 py-3 px-4 text-sm font-bold border-b-2 border-transparent text-gray-500 hover:text-gray-700 transition">
                                            Â±•Ê≠¥
                                        </button>
                                        <button id="tabIncidentApprove" onclick="switchIncidentTab('approval')"
                                            class="flex-1 py-3 px-4 text-sm font-bold border-b-2 border-transparent text-gray-500 hover:text-gray-700 transition hidden">
                                            ÊâøË™çÂæÅEÅ°
                                        </button>
                                    </div>
                                    <div id="incident-scroll-area" class="flex-1 overflow-y-auto custom-scrollbar p-4">
                                        <!-- 1. ÂØæÂøúÂæÅEÅ°„É™„Çπ„ÉÅE-->
                                        <section id="incidentPendingSection" class="max-w-3xl mx-auto py-2">
                                            <div id="incidentPendingCards" class="space-y-3">
                                                <!-- Dynamic Items -->
                                                <div class="text-center py-20 text-gray-400 text-sm">Ë™≠„ÅøËæº„Åø‰∏≠...</div>
                                            </div>
                                        </section>

                                        <!-- 2. Â±•Ê≠¥ (History) -->
                                        <section id="incidentHistorySection" class="max-w-6xl mx-auto py-4 hidden">
                                            <!-- Filters -->
                                            <div class="bg-white p-6 rounded-2xl border border-gray-200 mb-6 shadow-sm">
                                                <div class="grid grid-cols-2 sm:grid-cols-6 gap-4">
                                                    <div class="col-span-1">
                                                        <label class="text-[10px] font-bold text-gray-400 block mb-1"
                                                            for="hist-from">FROM</label>
                                                        <input type="date" id="hist-from"
                                                            class="w-full text-xs p-2.5 border border-gray-200 rounded-xl">
                                                    </div>
                                                    <div class="col-span-1">
                                                        <label class="text-[10px] font-bold text-gray-400 block mb-1"
                                                            for="hist-to">TO</label>
                                                        <input type="date" id="hist-to"
                                                            class="w-full text-xs p-2.5 border border-gray-200 rounded-xl">
                                                    </div>
                                                    <div class="col-span-1">
                                                        <label class="text-[10px] font-bold text-gray-400 block mb-1"
                                                            for="hist-type">Á®ÆÂà•</label>
                                                        <select id="hist-type"
                                                            class="w-full text-xs p-2.5 border border-gray-200 rounded-xl">
                                                            <option value="">ÂÖ®„Å¶</option>
                                                            <option>„Éí„É§„É™„Éè„ÉÉ„ÉÅE/option>
                                                            <option>‰∫ãÊïÖ</option>
                                                            <option>Ëã¶ÊÉÅE/option>
                                                        </select>
                                                    </div>
                                                    <div class="col-span-1">
                                                        <label class="text-[10px] font-bold text-gray-400 block mb-1"
                                                            for="hist-user">Âà©Áî®ËÄÅE/label>
                                                            <input type="text" id="hist-user" placeholder="Ê∞èÂêç"
                                                                class="w-full text-xs p-2.5 border border-gray-200 rounded-xl">
                                                    </div>
                                                    <div class="col-span-2 flex items-end gap-2">
                                                        <button onclick="loadIncidentHistory()"
                                                            class="flex-1 bg-indigo-600 text-white text-xs py-2.5 rounded-xl font-bold shadow-lg shadow-indigo-100">Ê§úÁ¥¢ÂÆüË°ÅE/button>
                                                            <button onclick="clearHistoryFilters()"
                                                                class="bg-gray-100 text-gray-500 text-xs py-2.5 px-4 rounded-xl font-bold">„É™„Çª„ÉÅEÉà</button>
                                                    </div>
                                                </div>
                                            </div>

                                            <div class="flex justify-between items-center mb-4 px-2">
                                                <h2 class="text-lg font-bold text-gray-800">‰∫ãÊïÖÂ†±ÂëäÂ±•Ê≠¥</h2>
                                                <button onclick="exportIncidentToCsv()"
                                                    class="text-xs text-indigo-600 font-bold flex items-center gap-1 hover:underline">
                                                    CSVÂá∫ÂäÅE </button>
                                            </div>

                                            <!-- Card-based History View -->
                                            <div id="incidentHistoryCards"
                                                class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                                <!-- Dynamic Cards -->
                                            </div>

                                            <div id="hist-empty"
                                                class="hidden py-20 text-center text-gray-400 text-sm bg-white rounded-2xl border border-dashed border-gray-200">
                                                Êù°‰ª∂„Å´‰∏ÄËá¥„Åô„ÇãÂ±•Ê≠¥„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì
                                            </div>
                                        </section>

                                        <!-- 3. ÊâøË™çÂæÅEÅ° (Approval) -->
                                        <section id="incidentApprovalSection" class="hidden h-full flex flex-col">
                                            <div class="flex flex-col lg:flex-row gap-6 h-full min-h-0">
                                                <div
                                                    class="w-full bg-white border border-gray-200 rounded-xl overflow-hidden flex flex-col shadow-sm">
                                                    <div
                                                        class="bg-gray-50 p-3 border-b border-gray-200 flex justify-between items-center">
                                                        <div class="flex items-center gap-2">
                                                            <span
                                                                class="font-bold text-xs text-gray-600">Êú™ÊâøË™ç„É™„Çπ„ÉÅE/span>
                                                                <span id="inc-pending-count"
                                                                    class="bg-indigo-100 text-indigo-700 text-[10px] font-bold px-2 py-0.5 rounded-full">0‰ª∂</span>
                                                        </div>
                                                        <button id="btn-bulk-approve" onclick="approveSelected()"
                                                            disabled
                                                            class="text-[10px] font-bold bg-white border border-indigo-200 text-indigo-600 px-2 py-1 rounded-md hover:bg-indigo-50 disabled:opacity-50 disabled:cursor-not-allowed transition">‰∏ÄÊã¨ÊâøË™ÅE/button>
                                                    </div>
                                                    <div id="incidentApprovalList"
                                                        class="flex-1 overflow-y-auto custom-scrollbar divide-y divide-gray-100">
                                                    </div>
                                                </div>

                                            </div>
                                        </section>
                                    </div>
                                </div>

                            </div>
                        </div>




                    </div><!-- End main-scroll-wrapper (Restored) -->

                    <!-- Global Loading Overlay (Legacy Removed) -->
                    <!-- <div id="loading-overlay" ...></div> -->


                    <!-- Modals -->
                    <div id="dropbox-modal"
                        class="hidden fixed inset-0 modal-overlay flex justify-center items-center p-4 fade-in z-[12000]">
                        <div class="bg-white rounded-xl shadow-2xl w-full max-w-3xl h-[80vh] flex flex-col">
                            <div class="p-4 border-b flex justify-between items-center bg-gray-50 rounded-t-xl">
                                <h3 class="font-bold text-gray-800 flex items-center gap-2">Dropbox ‰øùÂ≠ò„Éï„Ç°„Ç§„É´</h3>
                                <button onclick="closeDropboxBrowser()"
                                    class="text-gray-400 hover:text-gray-600">√ÅE/button>
                            </div>
                            <div class="px-4 py-2 bg-gray-100 border-b text-xs text-gray-600 break-all"
                                id="db-current-path">/</div>
                            <div id="db-file-list"
                                class="flex-grow overflow-y-auto p-2 custom-scrollbar bg-white min-h-0"
                                style="overscroll-behavior: contain;"></div>
                            <div class="p-4 border-t bg-gray-50 rounded-b-xl flex justify-end"><button
                                    onclick="closeDropboxBrowser()"
                                    class="px-6 py-2 border rounded-lg text-gray-600 hover:bg-white font-bold">Èñâ„Åò„ÇÅE/button>
                            </div>
                        </div>
                    </div>
                    <!-- Confirm Modal -->
                    <div id="confirm-modal"
                        class="hidden fixed inset-0 modal-overlay flex justify-center items-center p-4 fade-in z-[15000]">
                        <div
                            class="bg-white rounded-xl shadow-2xl w-full max-w-sm p-6 transform transition-all scale-100">
                            <h3 id="confirm-title" class="text-lg font-bold text-gray-800 mb-2">Á¢∫Ë™ÅE/h3>
                                <p id="confirm-message" class="text-gray-600 mb-6 whitespace-pre-wrap"></p>
                                <div class="flex justify-end gap-3">
                                    <button onclick="closeConfirm()"
                                        class="px-4 py-2 text-gray-500 hover:text-gray-700 font-bold transition">„Ç≠„É£„É≥„Çª„É´</button>
                                    <button id="confirm-ok-btn"
                                        class="px-6 py-2 bg-indigo-600 text-white font-bold rounded-lg hover:bg-indigo-700 transition">OK</button>
                                </div>
                        </div>
                    </div>
                    <div id="trash-modal"
                        class="hidden fixed inset-0 modal-overlay flex justify-center items-center p-4 fade-in z-[12000]">
                        <div class="bg-white rounded-xl shadow-2xl w-full max-w-4xl h-[80vh] flex flex-col">
                            <div class="p-4 border-b flex justify-between items-center bg-gray-50 rounded-t-xl">
                                <h3 class="font-bold text-gray-800">„Ç¥„ÉüÁÆ± <span
                                        class="text-xs text-red-500 font-normal ml-2">‚Äª30Êó•ÂæåËÅEÂãïÂâäÈô§</span></h3><button
                                    onclick="closeTrashModal()" class="text-gray-400 hover:text-gray-600">√ÅE/button>
                            </div>
                            <!-- Trash Tabs -->
                            <div id="trash-tabs" class="flex border-b bg-gray-50 px-4 gap-4">
                                <button id="tab-trash-record" onclick="switchTrashTab('record')"
                                    class="py-2 text-sm font-bold text-indigo-600 border-b-2 border-indigo-600">ÊîØÊè¥Ë®òÈå≤</button>
                                <button id="tab-trash-incident" onclick="switchTrashTab('incident')"
                                    class="py-2 text-sm font-bold text-gray-400 border-b-2 border-transparent hover:text-gray-600">‰∫ãÊïÖÂ†±ÂëÅE/button>
                            </div>
                            <div id="trash-list-container"
                                class="flex-grow overflow-y-auto p-4 custom-scrollbar bg-gray-50 min-h-0"
                                style="overscroll-behavior: contain;"></div>
                            <div class="p-4 border-t bg-gray-50 rounded-b-xl flex justify-end"><button
                                    onclick="closeTrashModal()"
                                    class="px-6 py-2 border rounded-lg text-gray-600 hover:bg-white font-bold">Èñâ„Åò„ÇÅE/button>
                            </div>
                        </div>
                    </div>
                    <div id="user-select-modal"
                        class="hidden fixed inset-0 modal-overlay flex justify-center items-center p-4 fade-in z-[13000]">
                        <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg h-[80vh] flex flex-col">
                            <div class="p-4 border-b bg-gray-50 rounded-t-xl flex justify-between items-center">
                                <h3 class="font-bold text-gray-800">Âà©Áî®ËÄÅEÅ∏ÊäÅE/h3><button
                                        onclick="closeUserSelectModal()"
                                        class="text-gray-400 hover:text-gray-600">√ÅE/button>
                            </div>
                            <div class="p-4 border-b"><input type="text" id="user-select-search" aria-label="Âà©Áî®ËÄÅE§úÁ¥¢"
                                    placeholder="Ê§úÁ¥¢..."
                                    class="w-full p-2 border rounded-lg text-sm bg-white focus:ring-2 focus:ring-indigo-500">
                            </div>
                            <div id="user-select-list"
                                class="flex-grow overflow-y-auto p-4 custom-scrollbar bg-white grid grid-cols-2 gap-2 content-start min-h-0"
                                style="overscroll-behavior: contain;">
                            </div>
                            <div class="p-4 border-t bg-white rounded-b-xl flex justify-end"><button
                                    onclick="confirmUserSelection()"
                                    class="px-6 py-2 bg-indigo-600 text-white rounded-lg font-bold hover:bg-indigo-700">Ê±∫ÂÆÅE/button>
                            </div>
                        </div>
                    </div>
                </div>
                <div id="incidentDetailPanel"
                    class="hidden fixed inset-0 modal-overlay flex justify-center items-center p-4 fade-in z-[12000]">
                    <div class="bg-white rounded-xl shadow-2xl w-full max-w-4xl max-h-[90vh] flex flex-col">
                        <div class="p-4 border-b bg-gray-50 flex justify-between items-center shrink-0 rounded-t-xl">
                            <h4 class="font-bold text-gray-700">Â†±ÂëäÊõ∏Ë©≥Á¥∞„ÉªÊâøË™ÅE/h4>
                                <button onclick="document.getElementById('incidentDetailPanel').classList.add('hidden')"
                                    class="p-2 -mr-2 text-gray-500 hover:bg-gray-100 rounded-full"><svg class="w-6 h-6"
                                        fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M6 18L18 6M6 6l12 12">
                                        </path>
                                    </svg></button>
                        </div>
                        <div id="incidentDetailContent"
                            class="flex-1 overflow-y-auto p-6 space-y-6 custom-scrollbar min-h-0"
                            style="overscroll-behavior: contain;">
                            <div class="text-center py-20 text-gray-400">Ë™≠„ÅøËæº„Åø‰∏≠...</div>
                        </div>
                        <div id="incidentDetailFooter"
                            class="p-4 border-t bg-gray-50 flex justify-end gap-3 shrink-0 rounded-b-xl">
                            <button id="btnDelete"
                                class="hidden px-4 py-2 border border-red-200 text-red-600 rounded-lg font-bold hover:bg-red-50 transition">ÂâäÈô§</button>
                            <button id="btnEdit"
                                class="hidden px-4 py-2 border border-indigo-200 text-indigo-600 rounded-lg font-bold hover:bg-indigo-50 transition">Á∑®ÈõÅE/button>
                                <button id="btnReturn"
                                    class="hidden px-6 py-2 border border-red-200 text-red-600 rounded-lg font-bold hover:bg-red-50 transition">Â∑Æ„ÅóÊàª„ÅÅE/button>
                                    <button id="btnApprove"
                                        class="hidden px-8 py-2 bg-indigo-600 text-white rounded-lg font-bold shadow-lg shadow-indigo-100 hover:bg-indigo-700 transition">ÊâøË™ç„Åô„ÇÅE/button>
                        </div>
                    </div>
                </div>
                <div id="record-modal"
                    class="hidden fixed inset-0 modal-overlay flex justify-center items-center p-4 fade-in z-[12000]">
                    <div class="bg-white rounded-xl shadow-2xl w-full max-w-4xl max-h-[90vh] flex flex-col">
                        <div class="p-4 border-b flex justify-between items-center bg-gray-50 rounded-t-xl">
                            <h3 id="modal-title" class="text-lg font-bold text-gray-800">Ë®òÈå≤</h3><button
                                onclick="closeRecordModal()"
                                class="p-2 -mr-2 text-gray-500 hover:bg-gray-100 rounded-full"><svg class="w-6 h-6"
                                    fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M6 18L18 6M6 6l12 12">
                                    </path>
                                </svg></button>
                        </div>
                        <div class="p-4 overflow-y-auto custom-scrollbar flex-1 min-h-0"
                            style="overscroll-behavior: contain;">
                            <form id="record-form" class="space-y-5"><input type="hidden" id="record-row-number"><input
                                    type="hidden" id="current-mode">
                                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                    <div><label for="recorder-select"
                                            class="block text-xs font-bold text-gray-500 mb-1">Ë®òÈå≤ËÄÅE<span
                                                class="text-red-500">*</span></label><input type="text"
                                            id="recorder-select" readonly required
                                            class="w-full p-3 border border-gray-300 rounded-lg bg-gray-100 font-bold text-sm cursor-default focus:ring-0">
                                    </div>
                                    <div><span class="block text-xs font-bold text-gray-500 mb-1">ÂØæË±°Âà©Áî®ËÄÅE/span>
                                            <div id="single-user-display"
                                                class="hidden p-3 bg-blue-50 border border-blue-200 rounded-lg text-blue-800 font-bold text-sm">
                                            </div>
                                            <div id="multi-user-section" class="hidden">
                                                <div class="flex items-center gap-2">
                                                    <div class="flex-grow p-2.5 border rounded-lg bg-gray-50 text-sm text-gray-700 truncate"
                                                        id="selected-users-display">(Êú™ÈÅ∏ÊäÅE</div><button type="button"
                                                        onclick="openUserSelectModal()"
                                                        class="px-3 py-2.5 bg-indigo-600 text-white text-xs font-bold rounded-lg hover:bg-indigo-700 whitespace-nowrap">ÈÅ∏ÊäÅE/button>
                                                </div>
                                            </div>
                                    </div>
                                </div>
                                <div class="grid grid-cols-2 gap-4">
                                    <div><label for="record-date"
                                            class="block text-xs font-bold text-gray-500 mb-1">Êó•ÊôÅE<span
                                                class="text-red-500">*</span></label><input type="datetime-local"
                                            id="record-date" required
                                            class="w-full h-11 p-2 border border-gray-300 rounded-lg text-xs sm:text-sm text-center">
                                    </div>
                                    <div><label for="record-item" class="block text-xs font-bold text-gray-500 mb-1">È†ÅEõÆ
                                            <span class="text-red-500">*</span></label><select id="record-item" required
                                            class="w-full p-3 border border-gray-300 rounded-lg text-sm">
                                            <option value="">ÈÅ∏ÊäÅE/option>
                                            <option value="ÊéíÊ≥ÅE>ÊéíÊ≥ÅE/option>
                                <option value=" ÊúçËñ¨">ÊúçËñ¨</option>
                                            <option value="„Éê„Ç§„Çø„É´">„Éê„Ç§„Çø„É´</option>
                                            <option value="È£ü‰∫ÅE>È£ü‰∫ÅE/option>
                                <option value=" „Åù„ÅE‰ªÅE>„Åù„ÅE‰ªÅE/option>
                                        </select></div>
                                </div>
                                <div id="dynamic-input-area"
                                    class="hidden p-3 bg-gray-50 rounded-lg border border-gray-200">
                                </div>
                                <div class="border rounded-lg p-3 relative bg-white">
                                    <div class="flex justify-between items-center mb-2"><label for="record-content"
                                            class="block text-xs font-bold text-gray-500">ÁµåÈÅéÂÜÅEÆπ</label><button
                                            type="button" onclick="openPhraseManagerModal()"
                                            class="text-xs bg-indigo-50 text-indigo-700 border border-indigo-200 px-3 py-1.5 rounded flex items-center gap-1 active:bg-indigo-100"><svg
                                                class="w-3 h-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                    d="M4 6h16M4 12h16m-7 6h7"></path>
                                            </svg> ÂÆöÂûãÊñÅE/button></div>
                                    <textarea id="record-content" rows="4"
                                        class="w-full p-3 border border-gray-300 rounded-lg text-sm"
                                        placeholder="ÂÖ•ÂäÅE.."></textarea>
                                </div>
                            </form>
                        </div>
                        <div class="p-4 border-t bg-gray-50 rounded-b-xl flex justify-end gap-3 sticky bottom-0"><button
                                onclick="closeRecordModal()"
                                class="flex-1 sm:flex-none px-4 py-3 border rounded-lg text-gray-700 font-bold bg-white active:bg-gray-100">„Ç≠„É£„É≥„Çª„É´</button><button
                                onclick="handleRecordSubmission()" id="modal-submit-btn"
                                class="flex-1 sm:flex-none px-6 py-3 bg-indigo-600 text-white rounded-lg font-bold shadow active:bg-indigo-700 flex justify-center items-center"><span
                                    id="submit-text">‰øùÂ≠ÅE/span>
                                    <!-- <div id="submit-loader" class="hidden"></div> -->
                            </button></div>
                    </div>
                </div>



                <!-- Incident Modal (Phase 3.1) [Scroll Fix Applied] -->
                <div id="phrase-manager-modal"
                    class="hidden fixed inset-0 modal-overlay flex justify-center items-center p-4 fade-in z-[13000]">
                    <div class="bg-white rounded-xl shadow-2xl w-full max-w-2xl h-[80vh] flex flex-col">
                        <div class="p-4 border-b flex justify-between items-center bg-gray-50 rounded-t-xl">
                            <h3 class="font-bold text-gray-800">ÂÆöÂûãÊñÅEÆ°ÁêÅE/h3><button onclick="closePhraseManagerModal()"
                                    class="text-gray-400 hover:text-gray-600">√ÅE/button>
                        </div>
                        <div class="p-4 border-b"><input type="text" id="phrase-manager-search" aria-label="ÂÆöÂûãÊñÅE§úÁ¥¢"
                                placeholder="Ê§úÁ¥¢" class="w-full p-2 border rounded-lg mb-2 text-sm">
                            <div class="flex gap-2 overflow-x-auto pb-1" id="phrase-category-tabs"></div>
                        </div>
                        <div id="phrase-manager-list"
                            class="flex-grow overflow-y-auto p-4 custom-scrollbar bg-gray-50 min-h-0"
                            style="overscroll-behavior: contain;"></div>
                        <div class="p-4 border-t bg-white rounded-b-xl flex gap-2"><input type="text"
                                id="new-phrase-input" aria-label="Êñ∞„Åó„ÅÑÂÆöÂûãÊñÅE class=" flex-grow p-2 border rounded-lg
                                text-sm" placeholder="Êñ∞Ë¶èÂÆöÂûãÊñÅE.."><button onclick="addNewPhrase()"
                                class="px-4 py-2 bg-indigo-600 text-white rounded-lg font-bold hover:bg-indigo-700">ËøΩÂä†</button>
                        </div>
                    </div>
                </div>
                <div id="phrase-edit-modal"
                    class="hidden fixed inset-0 modal-overlay flex justify-center items-center p-4 fade-in z-60">
                    <div class="bg-white rounded-xl shadow-lg w-full max-w-sm p-4 text-center">
                        <h3 class="font-bold text-lg mb-2">ÂÆöÂûãÊñÅEÇíÁ∑®ÈõÅE/h3><input type="hidden"
                                id="edit-phrase-old-text"><input type="hidden" id="edit-phrase-category"><textarea
                                id="edit-phrase-input" rows="4" aria-label="ÂÆöÂûãÊñÅEÅEÂÆπ"
                                class="w-full p-2 border rounded-lg mb-4 text-sm"></textarea>
                            <div class="flex gap-2 justify-end"><button onclick="closePhraseEditModal()"
                                    class="px-4 py-2 border rounded text-sm">„Ç≠„É£„É≥„Çª„É´</button><button
                                    onclick="submitEditPhrase()"
                                    class="px-4 py-2 bg-indigo-600 text-white rounded text-sm font-bold">Êõ¥Êñ∞</button>
                            </div>
                    </div>
                </div>
                <div id="text-detail-modal"
                    class="hidden fixed inset-0 modal-overlay flex justify-center items-center p-4 fade-in z-[12000]">
                    <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg max-h-[80vh] flex flex-col relative">
                        <div class="p-4 border-b flex justify-between items-center">
                            <h3 class="font-bold text-gray-800">Ë©≥Á¥∞</h3><button
                                onclick="document.getElementById('text-detail-modal').classList.add('hidden')"
                                class="p-2 -mr-2"><svg class="w-6 h-6 text-gray-500" fill="none" stroke="currentColor"
                                    viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M6 18L18 6M6 6l12 12">
                                    </path>
                                </svg></button>
                        </div>
                        <div id="text-detail-content"
                            class="p-6 text-gray-700 text-sm whitespace-pre-wrap leading-relaxed overflow-y-auto custom-scrollbar flex-1 min-h-0"
                            style="overscroll-behavior: contain;">
                        </div>
                        <div class="p-4 border-t flex justify-end"><button onclick="closeTextDetailModal()"
                                class="px-6 py-2 bg-indigo-600 text-white rounded-lg font-bold w-full sm:w-auto">Èñâ„Åò„ÇÅE/button>
                        </div>
                    </div>
                </div>

                <div id="toast-container"
                    class="fixed bottom-4 left-4 right-4 sm:left-auto sm:right-4 z-[100] flex flex-col gap-2 pointer-events-none">
                </div>
                <!-- Staff Management Modal -->
                <div id="staff-modal"
                    class="hidden fixed inset-0 modal-overlay flex justify-center items-center p-4 fade-in z-[60]">
                    <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg flex flex-col max-h-[90vh]">
                        <div class="p-4 border-b flex justify-between items-center bg-gray-50 rounded-t-xl">
                            <h3 class="font-bold text-gray-800">ËÅ∑Âì°ÁÆ°ÁêÅE/h3>
                                <button onclick="closeStaffModal()" class="text-gray-400 hover:text-gray-600">
                                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M6 18L18 6M6 6l12 12">
                                        </path>
                                    </svg>
                                </button>
                        </div>
                        <div class="p-4 overflow-y-auto flex-1">
                            <!-- Add/Edit Form -->
                            <form id="staff-form" class="mb-6 bg-gray-50 p-3 rounded-lg border border-gray-200"
                                onsubmit="event.preventDefault(); saveStaff();">
                                <div class="grid grid-cols-2 gap-3 mb-3">
                                    <div>
                                        <label for="staff-name"
                                            class="block text-xs font-bold text-gray-500 mb-1">ÂêçÂâç</label>
                                        <input type="text" id="staff-name" class="w-full p-2 border rounded text-sm"
                                            placeholder="Â±±Áî∞ Â§™ÈÉÅE required>
                        </div>
                        <div>
                            <label for=" staff-pin" class="block text-xs font-bold text-gray-500 mb-1">PIN (4Ê°ÅE</label>
                                        <input type="text" id="staff-pin" class="w-full p-2 border rounded text-sm"
                                            placeholder="1234" required>
                                    </div>
                                </div>
                                <div class="grid grid-cols-2 gap-3 mb-3">
                                    <div>
                                        <label for="staff-role"
                                            class="block text-xs font-bold text-gray-500 mb-1">Ê®©ÈôÅE/label>
                                            <select id="staff-role" class="w-full p-2 border rounded text-sm">
                                                <option value="staff">‰∏ÄËà¨ (Staff)</option>
                                                <option value="manager">ÁÆ°ÁêÅEÄÅE(Manager)</option>
                                            </select>
                                    </div>
                                    <div>
                                        <label for="staff-office"
                                            class="block text-xs font-bold text-gray-500 mb-1">‰∫ãÊ•≠ÊâÄ
                                            (‰ªªÊÑÅE</label>
                                        <input type="text" id="staff-office" class="w-full p-2 border rounded text-sm"
                                            placeholder="‰∫ãÊ•≠ÊâÄA, ‰∫ãÊ•≠ÊâÄB">
                                    </div>
                                </div>
                                <button type="submit"
                                    class="w-full py-2 bg-indigo-600 text-white rounded font-bold hover:bg-indigo-700 transition text-sm">‰øùÂ≠ÅE
                                    / ËøΩÂä†</button>
                            </form>

                            <!-- Staff List Table -->
                            <table class="w-full text-sm text-left text-gray-600">
                                <thead class="text-xs text-gray-700 uppercase bg-gray-50">
                                    <tr>
                                        <th class="p-2 border">ÂêçÂâç</th>
                                        <th class="p-2 border">PIN</th>
                                        <th class="p-2 border">Ê®©ÈôÅE/th>
                                        <th class="p-2 border text-center">Êìç‰ΩÅE/th>
                                    </tr>
                                </thead>
                                <tbody id="staff-list-body">
                                    <!-- Dynamic Content -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>



                <!-- Success Modal (Ê±éÁî®ÈÄöÁü•„Éù„ÉÉ„Éó„Ç¢„ÉÅEÅE) -->
                <div id="success-modal"
                    class="hidden fixed inset-0 z-[16000] flex items-center justify-center p-4 opacity-0 transition-opacity duration-300">
                    <div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm p-8 text-center">
                        <!-- Success Icon -->
                        <div class="w-20 h-20 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
                            <i id="success-modal-icon" class="fas fa-check text-4xl text-green-600"></i>
                        </div>

                        <!-- Title -->
                        <h3 id="success-modal-title" class="text-2xl font-bold text-gray-800 mb-2">Ë™çË®ºÊàêÂäü</h3>

                        <!-- Message -->
                        <p class="text-gray-600 font-bold">
                            <span id="success-staff-name"></span><span id="success-modal-suffix">„Åï„Çì</span>
                        </p>

                        <!-- Loading Bar -->
                        <div class="w-full bg-gray-200 rounded-full h-1.5 mt-6 overflow-hidden">
                            <div id="loading-bar" class="bg-green-500 h-full transition-all duration-1000"
                                style="width: 0%"></div>
                        </div>
                    </div>
                </div>

                <!-- PDF / Toast / Loading (Global Modals) -->
                <div id="mobile-pdf-modal" class="hidden fixed inset-0 modal-overlay flex flex-col z-[9999]">
                    <div
                        class="bg-white p-2 border-b flex justify-between items-center shrink-0 shadow-md relative z-10">
                        <div class="flex items-center gap-2">
                            <h3 class="font-bold text-gray-700">„Éó„É¨„Éì„É•„Éº</h3>
                            <div class="flex items-center bg-gray-100 rounded border ml-2">
                                <button onclick="changePdfZoom(25)"
                                    class="px-3 py-1 text-gray-600 hover:bg-gray-200 border-r border-gray-300 font-bold">ÅEÅE/button>
                                    <button onclick="changePdfZoom(-25)"
                                        class="px-3 py-1 text-gray-600 hover:bg-gray-200 font-bold">ÅEÅE/button>
                            </div>
                            <span id="zoom-level-mobile" class="text-xs text-gray-500 font-mono ml-2">100%</span>
                        </div>
                        <div class="flex gap-2">
                            <a id="btn-download-pdf-mobile" href="#"
                                onclick="showSuccessModal('„ÉÄ„Ç¶„É≥„É≠„Éº„ÉÅE, null, '„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ„ÇíÈñãÂßã„Åó„Åæ„Åó„Åü')"
                                class="px-3 py-1.5 bg-emerald-600 text-white rounded text-sm font-bold flex items-center gap-1"
                                download>
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
                                </svg>
                            </a>
                            <button onclick="closeFullPreview()"
                                class="px-4 py-1.5 bg-gray-600 text-white rounded font-bold text-sm">Èñâ„Åò„ÇÅE/button>
                        </div>
                    </div>
                    <div id="mobile-pdf-container" class="flex-1 overflow-auto bg-gray-700"></div>
                </div>


            </div><!-- End appView -->

            <div id="user-switch-modal"
                class="hidden fixed inset-0 modal-overlay flex justify-center items-center p-4 fade-in z-[12000]">
                <div class="bg-white rounded-xl shadow-2xl w-full max-w-sm flex flex-col overflow-hidden">
                    <div class="p-6 bg-indigo-600 text-white flex justify-between items-center">
                        <div>
                            <h3 class="font-bold text-lg">ËÅ∑Âì°ÂàÅEÇäÊõø„ÅÅE/h3>
                                <p class="text-indigo-200 text-xs mt-1">Âêå„Åò‰∫ãÊ•≠ÊâÄÂÜÅEÅßÊãÅEΩìËÄÅEÇíÂ§âÊõ¥„Åó„Åæ„ÅÅE/p>
                        </div>
                        <button onclick="closeUserSwitchModal()" class="text-white hover:text-indigo-200">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M6 18L18 6M6 6l12 12">
                                </path>
                            </svg>
                        </button>
                    </div>
                    <div class="p-6 space-y-6">
                        <div>
                            <label class="block text-xs font-bold text-gray-400 uppercase tracking-widest mb-2"
                                for="switch-staff-select">ËÅ∑Âì°ÂêÅE/label>
                                <div class="relative">
                                    <select id="switch-staff-select"
                                        class="w-full p-4 pl-12 bg-gray-50 border-2 border-gray-100 rounded-xl appearance-none font-bold text-gray-700 focus:border-indigo-500 focus:ring-0 transition">
                                        <option value="" disabled selected>ÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ</option>
                                    </select>
                                    <i class="fas fa-user absolute left-4 top-1/2 -translate-y-1/2 text-gray-400"></i>
                                </div>
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-400 uppercase tracking-widest mb-2"
                                for="switch-pin-input">PIN„Ç≥„Éº„ÉÅE (4Ê°ÅE</label>
                            <div class="relative">
                                <input type="password" id="switch-pin-input" maxlength="4" placeholder="‚óè‚óè‚óè‚óè"
                                    class="w-full p-4 pl-12 bg-gray-50 border-2 border-gray-100 rounded-xl font-bold text-gray-700 tracking-widest focus:border-indigo-500 focus:ring-0 transition placeholder-gray-300">
                                <i class="fas fa-lock absolute left-4 top-1/2 -translate-y-1/2 text-gray-400"></i>
                            </div>
                        </div>
                        <button onclick="submitUserSwitch()"
                            class="w-full py-4 bg-indigo-600 text-white rounded-xl font-bold hover:bg-indigo-700 shadow-lg shadow-indigo-200 transition active:scale-[0.98]">
                            <span>ÂàÅEÇäÊõø„Åà„ÇíÂÆüË°ÅE/span>
                        </button>
                    </div>
                </div>
            </div>
            <!-- ‚ñº ‰∫ãÊïÖÂ†±ÂëäÔºàÂçòÁ•®ÅEâ„É¢„Éº„ÉÄ„É´ (ËøΩÂä†) -->
            <div id="incident-simple-modal"
                class="fixed inset-0 bg-black/50 hidden z-[12050] flex items-center justify-center p-4 fade-in">
                <div class="bg-white w-full max-w-3xl rounded-xl shadow-2xl flex flex-col max-h-[90vh]">
                    <!-- „Éò„ÉÉ„ÉÄ„Éº -->
                    <div class="px-6 py-4 border-b flex justify-between items-center bg-gray-50 rounded-t-xl shrink-0">
                        <h4 class="text-lg font-bold text-gray-800">„Éí„É§„É™„Éè„ÉÉ„Éà„ÅE‰∫ãÊïÖÂ†±ÂëÅE/h4>
                            <button onclick="closeIncidentSimpleModal()" class="text-gray-400 hover:text-gray-600">
                                <i class="fas fa-times text-xl"></i>
                            </button>
                    </div>

                    <!-- „Çπ„ÇØ„É≠„Éº„É´„Ç®„É™„Ç¢ -->
                    <div class="p-6 overflow-y-auto custom-scrollbar">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <label class="block md:col-span-1">
                                <span class="text-xs font-bold text-gray-500">Ë®òÈå≤ËÄÅE*</span>
                                <input id="inc-simple-recorder"
                                    class="mt-1 w-full p-2.5 border border-gray-300 rounded-lg bg-gray-100 font-bold text-sm"
                                    readonly />
                            </label>
                            <label class="block md:col-span-1">
                                <span class="text-xs font-bold text-gray-500">ÂØæË±°Âà©Áî®ËÄÅE*</span>
                                <select id="inc-simple-user"
                                    class="mt-1 w-full p-2.5 border border-gray-300 rounded-lg text-sm"></select>
                            </label>
                            <label class="block md:col-span-1">
                                <span class="text-xs font-bold text-gray-500">Áô∫ÁîüÊó•ÊôÅE*</span>
                                <input id="inc-simple-occur" type="datetime-local"
                                    class="mt-1 w-full p-2.5 border border-gray-300 rounded-lg text-sm" />
                            </label>
                            <label class="block md:col-span-1">
                                <span class="text-xs font-bold text-gray-500">Á®ÆÂà• *</span>
                                <select id="inc-simple-type"
                                    class="mt-1 w-full p-2.5 border border-gray-300 rounded-lg text-sm">
                                    <option>„Éí„É§„É™„Éè„ÉÉ„ÉÅE/option>
                                    <option>‰∫ãÊïÖ</option>
                                    <option>Ëã¶ÊÉÅE/option>
                                    <option>„Åù„ÅE‰ªÅE/option>
                                </select>
                            </label>
                            <label class="block md:col-span-2">
                                <span class="text-xs font-bold text-gray-500">Â†¥ÊâÄ</span>
                                <input id="inc-simple-place"
                                    class="mt-1 w-full p-2.5 border border-gray-300 rounded-lg text-sm" placeholder="Â±ÅEÆ§„ÄÅ„É™„Éì„É≥„Ç∞Á≠ÅE />
                    </label>
                    <div class=" block md:col-span-2">
                                <div class="flex justify-between items-end mb-1">
                                    <label for="inc-simple-situation"
                                        class="text-xs font-bold text-gray-500">Áô∫ÁîüÁä∂Ê≥ÅEºÅEW1HÅEÅE *</label>
                                    <button onclick="openPhraseManagerModal('inc-simple-situation', '‰∫ãÊïÖ_Áä∂Ê≥ÅE)"
                                        type="button"
                                        class="text-[10px] text-indigo-600 bg-indigo-50 px-2 py-0.5 rounded border border-indigo-200 hover:bg-indigo-100">ÂÆöÂûãÊñÅE/button>
                                </div>
                                <textarea id="inc-simple-situation" rows="3" oninput="saveDraft()"
                                    class="mt-1 w-full p-2.5 border border-gray-300 rounded-lg text-sm"
                                    placeholder="„ÅÅEÅ§„ÄÅ„Å©„Åì„Åß„ÄÅË™∞„Åå„ÄÅ‰Ωï„Çí..."></textarea>
                        </div>
                        <div class="block md:col-span-2">
                            <div class="flex justify-between items-end mb-1">
                                <label for="inc-simple-cause" class="text-xs font-bold text-gray-500">ÂéüÂõ†</label>
                                <button onclick="openPhraseManagerModal('inc-simple-cause', '‰∫ãÊïÖ_ÂéüÂõ†')" type="button"
                                    class="text-[10px] text-indigo-600 bg-indigo-50 px-2 py-0.5 rounded border border-indigo-200 hover:bg-indigo-100">ÂÆöÂûãÊñÅE/button>
                            </div>
                            <textarea id="inc-simple-cause" rows="2" oninput="saveDraft()"
                                class="mt-1 w-full p-2.5 border border-gray-300 rounded-lg text-sm"></textarea>
                        </div>
                        <div class="block md:col-span-1">
                            <div class="flex justify-between items-end mb-1">
                                <label for="inc-simple-response" class="text-xs font-bold text-gray-500">ÂØæÂøÅE/label>
                                    <button onclick="openPhraseManagerModal('inc-simple-response', '‰∫ãÊïÖ_ÂØæÂøÅE)"
                                        type="button"
                                        class="text-[10px] text-indigo-600 bg-indigo-50 px-2 py-0.5 rounded border border-indigo-200 hover:bg-indigo-100">ÂÆöÂûãÊñÅE/button>
                            </div>
                            <textarea id="inc-simple-response" rows="2" oninput="saveDraft()"
                                class="mt-1 w-full p-2.5 border border-gray-300 rounded-lg text-sm"></textarea>
                        </div>
                        <div class="block md:col-span-1">
                            <div class="flex justify-between items-end mb-1">
                                <label for="inc-simple-prevention"
                                    class="text-xs font-bold text-gray-500">ÂÜçÁô∫Èò≤Ê≠¢Á≠ÅE/label>
                                    <button onclick="openPhraseManagerModal('inc-simple-prevention', '‰∫ãÊïÖ_ÂÜçÁô∫Èò≤Ê≠¢')"
                                        type="button"
                                        class="text-[10px] text-indigo-600 bg-indigo-50 px-2 py-0.5 rounded border border-indigo-200 hover:bg-indigo-100">ÂÆöÂûãÊñÅE/button>
                            </div>
                            <textarea id="inc-simple-prevention" rows="2" oninput="saveDraft()"
                                class="mt-1 w-full p-2.5 border border-gray-300 rounded-lg text-sm"></textarea>
                        </div>
                    </div>
                </div>

                <!-- „Éï„ÉÉ„Çø„Éº -->
                <div class="px-6 py-4 border-t bg-gray-50 rounded-b-xl flex justify-end gap-3 shrink-0"
                    id="incidentDetailFooter">
                    <!-- „ÉÅEÉï„Ç©„É´„ÉàÔºàÊñ∞Ë¶ÅEÁ∑®ÈõÅEôÇÅEÅE-->
                    <button onclick="closeIncidentSimpleModal()"
                        class="px-4 py-2 border rounded-lg text-gray-600 font-bold hover:bg-white">„Ç≠„É£„É≥„Çª„É´</button>
                    <button onclick="saveIncident()" id="btn-save-simple-inc"
                        class="px-6 py-2 rounded-lg bg-red-600 text-white font-bold hover:bg-red-700 shadow flex items-center gap-2">
                        <span id="btn-save-simple-inc-text">Â†±Âëä„Çí‰øùÂ≠ÅE/span>
                            <!-- <div id="btn-save-simple-inc-loader" class="hidden"></div> -->
                    </button>
                </div>
            </div>
        </div>

        <!-- Global Loading Overlay (Legacy Removed - handled by showOverlaySpinner) -->
        <!--
    <div id="loading-overlay"
        class="fixed inset-0 bg-white/80 backdrop-blur-sm hidden flex items-center justify-center z-[2147483647]">
        <div class="text-indigo-800 font-bold text-xl flex items-center">
            <span id="loading-text">Êõ¥Êñ∞‰∏≠...</span>
            <i class="fas fa-spinner fa-spin ml-3 text-2xl"></i>
        </div>
    </div>
    -->

        <script>
        // Global Error Handler for Debugging
        window.onerror = function (msg, url, lineNo, columnNo, error) {
            const message = [
                'Message: ' + msg,
                'Line: ' + lineNo,
                'Column: ' + columnNo,
                'Error object: ' + JSON.stringify(error)
            ].join(' - ');
            console.error(message);
            alert('System Error: ' + msg); // Alert is safest if UI is broken
            return false;
        };
        console.log('Script Started: Initializing APP_STATE...');

        const APP_STATE = {
            office: null,
            whoami: null,
            pinInput: '',
            allRecords: {}, // { name: [] }
            hasMore: {},    // { name: boolean }
            tokens: {},     // { name: string }
            isLoadingMore: false,
            lastRequestTime: {}, // { name: timestamp } „É¨„Éº„Çπ„Ç≥„É≥„ÉÅEÇ£„Ç∑„Éß„É≥ÂØæÁ≠ÅE            users: [],
            phrases: [],
            staffs: [],
            filter: { startDate: null, endDate: null, item: 'all' },
            phraseManager: { category: 'ÊéíÊ≥ÅE, search: '' },
            selectedUsers: [],
            viewMode: 'day',
            currentDate: new Date(),
            currentUserName: null,
            pdfData: null, pdfDoc: null, pdfScale: 1.0, pdfScaleFull: 1.0,
            baseScale: 1.0, currentScale: 1.0, panX: 0, panY: 0,
            dropboxPath: null, dropboxRootPath: null,
            dropboxPrefix: '/„Ç¢„Éó„É™/Google„Éï„Ç©„Éº„É†ÊîØÊè¥Ë®òÈå≤',
            auth: { pinFailCount: 0, isLockout: false, FAIL_LIMIT: 5, LOCKOUT_MS: 60000 }
        };

        const CATEGORIES = ['ÊéíÊ≥ÅE, 'ÊúçËñ¨', '„Éê„Ç§„Çø„É´', 'È£ü‰∫ÅE, '„Åù„ÅE‰ªÅE];
        const OTHER_OPTIONS = ["Âà©Áî®ÈñãÂßÅE, "Âà©Áî®ÁµÇ‰∫ÅE, "Ê∞¥ÂàÅE£úÁµ¶", "Âè£ËÖî„Ç±„Ç¢", "ÂÖ•Êµ¥", "Âá∫Êµ¥", "Êõ¥Ë°£", "Êï¥ÂÆπ", "Ëµ∑Â∫ÅE, "ÂÖ•Áú†", "ÊßòÂ≠ÅE, "„Åù„ÅE‰ªÅE];

        // ===============================================
        // Âæ©Êóß: „Çπ„Éî„Éä„ÉºÁµ±‰∏Ä„ÉªUIÂà∂Âæ°Áî®„Éò„É´„Éë„ÅEÈñ¢Êï∞
        // ===============================================

        /**
         * „Éú„Çø„É≥„ÅÆ„É≠„Éº„ÉÅEÇ£„É≥„Ç∞Áä∂ÊÖã„ÇíÂà∂Âæ°„Åô„ÇãÅEà„Çπ„Éî„Éä„ÉºË°®Á§∫/ÈùûË°®Á§∫ÅEÅE         * @param {HTMLElement} btn - ÂØæË±°„ÅÆ„Éú„Çø„É≥Ë¶ÅÁ¥†
         * @param {boolean} isLoading - true:„É≠„Éº„Éâ‰∏≠, false:ÈÄöÂ∏∏
         */
        function setButtonLoading(btn, isLoading) {
            if (!btn) return;

            if (isLoading) {
                // ‰∫åÈáçÈÄÅ‰ø°Èò≤Ê≠¢
                btn.disabled = true;
                btn.dataset.originalHtml = btn.innerHTML; // ÂÖÅEÅEË°®Á§∫„ÇíË®òÊÅE

                // „Çπ„Éî„Éä„Éº„ÇíË°®Á§∫ÅEà„Çµ„Ç§„Ç∫Âº∑Âà∂Âõ∫ÂÆöÁâàÅEÅE                btn.innerHTML = getLoaderHtml();
            } else {
                // ÂÖÅEÅ´Êàª„ÅÅE                btn.disabled = false;
                if (btn.dataset.originalHtml) {
                    btn.innerHTML = btn.dataset.originalHtml;
                }
            }
        }

        /**
         * „Çπ„Éî„Éä„Éº„ÅÆHTML„ÇíÁîüÊàêÔºÅESSÂ¥©„ÇåÈò≤Ê≠¢„Éª„Çµ„Ç§„Ç∫Âº∑Âà∂ÁâàÔºÅE         */
        function getLoaderHtml(sizeClass = 'w-8 h-8') {
            return `
                                < svg class="animate-spin"
                            style = "width: 1.25rem !important; height: 1.25rem !important; display: inline-block; vertical-align: middle;"
                            xmlns = "http://www.w3.org/2000/svg" fill = "none" viewBox = "0 0 24 24" >
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg > `;
        }

        /**
         * ÁîªÈù¢ÂÖ®‰Ωì„ÇíË¶ÅEÅÜ„É≠„Éº„ÉÅEÇ£„É≥„Ç∞ÅEà„Ç™„Éº„Éê„ÅE„É¨„Ç§ÅEâ„ÇíË°®Á§∫
         */
        function showOverlaySpinner() {
            let overlay = document.getElementById('global-spinner');
            if (!overlay) {
                overlay = document.createElement('div');
                overlay.id = 'global-spinner';
                overlay.className = 'fixed inset-0 bg-gray-900 bg-opacity-50 z-[9999] flex items-center justify-center hidden';
                overlay.innerHTML = `
                                < div class="bg-white p-4 rounded-full shadow-xl" >
                                    <div class="spinner border-4 border-blue-500 border-t-transparent rounded-full w-12 h-12 animate-spin"></div>
                    </div > `;
                document.body.appendChild(overlay);
            }
            overlay.classList.remove('hidden');
        }

        /**
         * ÁîªÈù¢ÂÖ®‰Ωì„É≠„Éº„ÉÅEÇ£„É≥„Ç∞„ÇíÈùûË°®Á§∫
         */
        function hideOverlaySpinner() {
            const overlay = document.getElementById('global-spinner');
            if (overlay) overlay.classList.add('hidden');
        }

        // -----------------------------------------------------------
        // ÂàùÊúüÂåÅE        // -----------------------------------------------------------

        /**
         * ‰∫íÊèõÊÄßÁ∂≠ÊåÅ„ÅE„Åü„ÇÅ„ÅÆ„É©„ÉÅEÅEÈñ¢Êï∞
         * (Legacy calls to showLoading(true/false) will map to OverlaySpinner)
         */
        function showLoading(msgOrBool) {
            if (msgOrBool === false) {
                hideOverlaySpinner();
            } else {
                showOverlaySpinner();
            }
        }
        document.addEventListener('DOMContentLoaded', () => {

            // [Fix] Early filter restoration to prevent flash
            function restoreFilterEarly() {
                try {
                    // [Fix] Skip restoration if just signed in  
                    if (sessionStorage.getItem('skip_filter_restore') === 'true') {
                        console.log('[Debug] Skipping restoreFilterEarly (just signed in)');
                        return;
                    }

                    const savedViewMode = localStorage.getItem('filter_viewMode');
                    const savedDate = localStorage.getItem('filter_currentDate');

                    if (!savedViewMode && !savedDate) return; // Nothing to restore

                    // Restore viewMode
                    const viewMode = savedViewMode || 'day';

                    // Update segment buttons UI
                    document.querySelectorAll('.segment-btn').forEach(b => b.classList.remove('active'));
                    const segBtn = document.getElementById(`seg - ${ viewMode } `);
                    if (segBtn) segBtn.classList.add('active');

                    // Update btn-current text
                    const btnCurrent = document.getElementById('btn-current');
                    if (btnCurrent) {
                        if (viewMode === 'day') btnCurrent.textContent = '‰ªäÊó•„Å∏';
                        else if (viewMode === 'week') btnCurrent.textContent = '‰ªäÈÄ±„Å∏';
                        else if (viewMode === 'month') btnCurrent.textContent = '‰ªäÊúà„Å∏';
                    }

                    // Pre-calculate and set date display
                    const currentDate = savedDate ? new Date(savedDate) : new Date();
                    const a = new Date(currentDate); a.setHours(0, 0, 0, 0);
                    let s = new Date(a); let e = new Date(a); let displayText = "";

                    if (viewMode === 'day') {
                        displayText = formatDateJP(a);
                    } else if (viewMode === 'week') {
                        const d = a.getDay();
                        const diff = (d === 0 ? 6 : d - 1);
                        s.setDate(a.getDate() - diff); e = new Date(s); e.setDate(s.getDate() + 6);
                        displayText = `${ formatDateJP(s, true) } - ${ formatDateJP(e, true) } `;
                    } else if (viewMode === 'month') {
                        s.setDate(1); e = new Date(s.getFullYear(), s.getMonth() + 1, 0);
                        const y = s.getFullYear(); const m = s.getMonth() + 1; displayText = `${ y }Âπ¥${ m } ÊúÅE;
                        }

                        const dateDisplay = document.getElementById('current-date-display');
                        if (dateDisplay) dateDisplay.textContent = displayText;

                        console.log('[Debug] Early filter restoration complete:', { viewMode, displayText });
                    } catch (e) {
                        console.warn('[Warning] Early filter restoration failed:', e);
                    }
                }

            // Restore filter UI immediately before any data loads
            restoreFilterEarly();

                if (APP_STATE.isInitialized) return; // Guard against double firing
                APP_STATE.isInitialized = true; // Mark as initialized

                // 0. FAB„Éú„Çø„É≥„ÇíÂÅEÊúüÁä∂ÊÖã„ÅßÈùûË°®Á§∫„Å´„Åô„Çã
                showFab(false);

                // 1. „Çª„ÉÅEÇ∑„Éß„É≥Âæ©ÂÖÅE©¶Ë°ÅE            try {
                const saved = sessionStorage.getItem('gas_whoami');
                if (saved) {
                    const w = JSON.parse(saved);
                    if (w && w.expiresAt > Date.now()) {
                        APP_STATE.whoami = w;

                        // „Çµ„Ç§„É≥„Ç§„É≥ÁîªÈù¢„ÇíÈö†„Åó„ÄÅ„Ç¢„Éó„É™ÁîªÈù¢„ÇíË°®Á§∫
                        document.getElementById('signinView').classList.add('hidden');
                        const av = document.getElementById('appView');
                        av.classList.remove('hidden');
                        av.style.display = 'flex';

                        // „Éò„ÉÉ„ÉÄ„ÉºË¶ÅÁ¥†„ÅÆÁ¢∫ÂÆü„Å™Ë°®Á§∫
                        const header = document.getElementById('appHeader');
                        if (header) {
                            header.classList.remove('hidden');
                            header.style.display = '';
                        }
                        const userContainer = document.getElementById('header-user-pc-container');
                        if (userContainer) userContainer.classList.remove('hidden');


                        loadAppData(w.officeSelected, true); // isReload = true
                    }
                }
            } catch (e) { }

            // 2. ‰∫ãÊ•≠ÊâÄ„É™„Çπ„ÉàÂèñÂæÅE(„Çª„ÉÅEÇ∑„Éß„É≥„Åå„Å™„ÅÅE†¥Âêà„ÅE„Åø)
            if (!APP_STATE.whoami) {
                const sv = document.getElementById('signinView');
                if (sv) {
                    sv.style.display = 'flex';
                    sv.classList.remove('hidden');
                }
                loadOfficeList();
            }

            // Â§ñÂÅE„ÇØ„É™„ÉÅEÇØ„Åß„É°„Éã„É•„Éº„ÇíÈñâ„Åò„Çã
            window.addEventListener('click', (e) => {
                const drop = document.getElementById('userDropdown');
                if (drop && !drop.contains(e.target) && !e.target.closest('#userAvatarBtn')) {
                    drop.classList.add('hidden');
                }
                const more = document.getElementById('moreMenu');
                if (more && !more.contains(e.target) && !e.target.closest('#btnMore')) {
                    more.classList.add('hidden');
                }
            });

            // 3. „É™„Çπ„Éä„ÅEÂàùÊúüÂåÅE            setupSigninListeners();
            setupEventListeners();
        });


            function loadOfficeList() {
                const sel = document.getElementById('signinOffice');
                if (sel) sel.innerHTML = '<option value="" disabled selected>Ë™≠„ÅøËæº„Åø‰∏≠...</option>';

                google.script.run
                    .withSuccessHandler(data => {
                        console.log('loadOfficeList success raw:', JSON.stringify(data));

                        // Re-fetch to be safe
                        const sel = document.getElementById('signinOffice');
                        if (!sel) {
                            console.error('signinOffice element not found');
                            return;
                        }

                        if (data.error) {
                            console.error('Server reported error:', data.error);
                            showToast('„ÉÅEÅE„ÇøÂèñÂæó„Ç®„É©„Éº: ' + data.error, 'error');
                            sel.innerHTML = `<option value="" disabled selected>„Ç®„É©„Éº: ${data.error}</option>`;
                            return;
                        }

                        sel.innerHTML = '<option value="" disabled selected>‰∫ãÊ•≠ÊâÄ„ÇíÈÅ∏ÊäÅE/option>';
                        const list = data.offices || [];
                        if (list.length === 0) {
                            console.warn('Office list is empty!');
                            sel.add(new Option('ÅEà‰∫ãÊ•≠ÊâÄ„Å™„ÅóÔºÅE, ''));
                    } else {
                            list.forEach(o => {
                                console.log('Adding option:', o);
                                sel.add(new Option(o, o));
                            });
                        }

                        // [v33 Fix] PDFÂá∫ÂäõÊúà„ÅÆÂàùÊúü„Çª„ÉÅEÉà
                        const now = new Date();
                        const yyyymm = now.getFullYear() + '-' + String(now.getMonth() + 1).padStart(2, '0');
                        const outputMonth = document.getElementById('output-month');
                        if (outputMonth) outputMonth.value = yyyymm;
                    })
                    .withFailureHandler(err => {
                        console.error('Failed to load initial data:', err);
                        if (sel) sel.innerHTML = '<option value="" disabled selected>ÂèñÂæóÂ§±ÊïÅEÂÜçË™≠„ÅøËæº„Åø)</option>';
                        showToast('‰∫ãÊ•≠ÊâÄ„É™„Çπ„Éà„ÅEÂèñÂæó„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ„ÅE„Éº„Ç∏„ÇíÂÅEË™≠„ÅøËæº„Åø„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÅE, 'error');
                })
                    .getInitialData();
            }

            function setupSigninListeners() {
                // setupSigninListeners „Åß„ÅÆ„É™„Çπ„Éä„ÅEÈáçË§ÅEÇíÈò≤„Åê„Åü„ÇÅ„ÄÅÂè§„ÅÅE¶ÅÁ¥†„Çí‰∏ÄÊó¶„ÇØ„É≠„Éº„É≥Á≠â„Åß„É™„Çª„ÉÅEÉà„Åô„Çã„Åã„ÄÅ„Éï„É©„Ç∞ÁÆ°ÁêÅEÅåÊúõ„Åæ„Åó„ÅÑ„Åå„ÄÅE            // „Åì„Åì„Åß„ÅØÁ∞°ÊòìÁöÑ„Å´„Äå„Ç§„Éô„É≥„Éà„Éè„É≥„Éâ„É©Â±ûÊÄß„Äç„ÇíÂà©Áî®„Åô„Çã„Åã„ÄÅ„ÅÇ„Çã„ÅÑ„ÅØÈáçË§ÅEôªÈå≤„ÇíË®±ÂÆπ„Åó„Å¶ÂÜÅEÉ®„Åß„Ç¨„Éº„Éâ„Åô„Çã„ÄÅE            // „Åó„Åã„ÅÅEaddEventListener „ÅØÂêå‰∏ÄÈñ¢Êï∞„Å™„ÇâÈáçË§ÅEÅó„Å™„ÅÅEÅå„ÄÅÁÑ°ÂêçÈñ¢Êï∞„ÅØÈáçË§ÅEÅô„Çã„ÄÅE            // ÊúÄ„ÇÇÂÆâÂÅE„Å™„ÅÆ„ÅØ„ÄÅË¶ÅÁ¥†„ÇíÂÅEÂèñÂæó„Åó„Å¶„É™„Çª„ÉÅEÉà„Åô„Çã„Åì„Å®„ÄÅE            const officeSel = document.getElementById('signinOffice');
                const staffSel = document.getElementById('staffSelect');
                const btnGo = document.getElementById('btnSigninGo');
                const pinInput = document.getElementById('pinInput');

                if (!officeSel || !staffSel || !btnGo || !pinInput) return;

                // [Fix] Êó¢Â≠ò„ÅE„É™„Çπ„Éä„ÅE„ÇíÂâäÈô§„Åô„Çã„Åü„ÇÅ„Å´Ë¶ÅÁ¥†„ÇíÁΩÆÊèÅE(Clone Node)
                // „Åì„Çå„Å´„Çà„Çä„É≠„Ç∞„Ç¢„Ç¶„ÉàÂæå„ÅEÂÜçÁôªÈå≤ÊôÇ„ÇÇ„ÇØ„É™„Éº„É≥„Å™Áä∂ÊÖã„Å´„Å™„ÇÅE            const newOfficeSel = officeSel.cloneNode(true);
                officeSel.parentNode.replaceChild(newOfficeSel, officeSel);

                const newBtnGo = btnGo.cloneNode(true);
                btnGo.parentNode.replaceChild(newBtnGo, btnGo);

                const newPinInput = pinInput.cloneNode(true);
                pinInput.parentNode.replaceChild(newPinInput, pinInput);

                // „É™„Çπ„Éä„ÅEÂÜçÁôªÈå≤
                newOfficeSel.addEventListener('change', (e) => {
                    const office = e.target.value;
                    if (!office) return;
                    staffSel.disabled = true;
                    staffSel.innerHTML = '<option>Ë™≠„ÅøËæº„Åø‰∏≠...</option>';
                    google.script.run
                        .withSuccessHandler(staffs => {
                            staffSel.innerHTML = '<option value="" disabled selected>ËÅ∑Âì°„ÇíÈÅ∏ÊäÅE/option>';
                            if (staffs && Array.isArray(staffs)) {
                                const validStaffs = staffs.filter(s => s && /[^\s\u3000]/.test(String(s)));
                                const uniqueStaffs = [...new Set(validStaffs)];
                                uniqueStaffs.forEach(s => staffSel.add(new Option(s, s)));
                            }
                            staffSel.disabled = false;
                        })
                        .withFailureHandler(err => {
                            staffSel.innerHTML = '<option value="" disabled selected>Ë™≠„ÅøËæº„ÅøÂ§±ÊïÅE/option>';
                            staffSel.disabled = false;
                            handleError(err);
                        })
                        .getStaffListByOffice(office);
                });

                newBtnGo.addEventListener('click', doSignin);

                newPinInput.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') doSignin();
                });

                // „Ç∞„É≠„Éº„Éê„É´„Å™Enter„Ç≠„ÉºÂØæÂøú„ÇÇÁ∂≠ÊåÅEºàÂà©‰æøÊÄß„ÅÆ„Åü„ÇÅÅEÅE            window.addEventListener('keydown', (e) => {
                const sv = document.getElementById('signinView');
                if (sv.classList.contains('hidden') || sv.style.display === 'none') return;
                if (e.key === 'Enter' && document.activeElement !== pinInput) {
                    doSignin();
                }
            });
        }

            // [NEW] Centralized View Switcher
            function showMainApp() {
                try {
                    // 1. Hide Signin
                    const sv = document.getElementById('signinView');
                    if (sv) {
                        sv.classList.add('hidden', 'opacity-0');
                        sv.style.display = 'none'; // Force hide
                    }

                    // 2. Show App Container
                    // 2. Show App Container
                    const av = document.getElementById('appView');
                    if (av) {
                        // [Fix] Force set "Today" before showing app to prevent flash
                        // (Only if signing in, not reloading. Reload handles this in head script)
                        if (sessionStorage.getItem('skip_filter_restore') === 'true') {
                            const today = new Date();
                            const y = today.getFullYear();
                            const m = today.getMonth() + 1;
                            const dt = today.getDate();
                            const w = ["Êó•", "ÊúÅE, "ÁÅ´", "Ê∞¥", "Êú®", "ÈáÅE, "ÂúÅE][today.getDay()];
                        const disp = `${y}/${m}/${dt} (${w})`;

                            const dateDisplay = document.getElementById('current-date-display');
                            if (dateDisplay) dateDisplay.textContent = disp;

                            // Ensure "day" tab is active
                            document.querySelectorAll('.segment-btn').forEach(b => b.classList.remove('active'));
                            const segBtn = document.getElementById('seg-day');
                            if (segBtn) segBtn.classList.add('active');

                            // [Fix] Double-check clear list containers to absolutely prevent flash
                            const containers = [
                                'record-list-container',
                                'incidentPendingCards',
                                'incidentHistoryCards',
                                'incidentApprovalList'
                            ];
                            containers.forEach(id => {
                                const el = document.getElementById(id);
                                if (el) el.innerHTML = '';
                            });

                            // [Fix] Also hide load more button
                            const lm = document.getElementById('load-more-container');
                            if (lm) lm.classList.add('hidden');

                            // [Fix] Reset badges
                            ['badge-all', 'badge-ÊéíÊ≥ÅE, 'badge - ÊúçËñ¨', 'badge - „Éê„Ç§„Çø„É´', 'badge - È£ü‰∫ÅE, 'badge-„Åù„ÅE‰ªÅE].forEach(id => {
                            const b = document.getElementById(id);
                            if (b) b.textContent = '0';
                        });
                        const pendingCnt = document.getElementById('inc-pending-count');
                        if (pendingCnt) pendingCnt.textContent = '0‰ª∂';
                    }

                    av.classList.remove('hidden');
                    av.style.display = 'flex';
                }

                // 3. Show Header (Explicitly)
                // 3. Show Header (Explicitly)
                const header = document.getElementById('appHeader');
                if (header) {
                    header.classList.remove('hidden');
                    header.style.display = ''; // Reset inline style if any
                }

                // 4. Show Main Content
                const mc = document.getElementById('main-content');
                if (mc) mc.classList.remove('hidden');

                // 5. FAB
                showFab(true);

            } catch (e) {
                console.error('showMainApp error:', e);
            }
        }

            async function doSignin() {
                const office = document.getElementById('signinOffice').value;
                const staff = document.getElementById('staffSelect').value;
                const pin = document.getElementById('pinInput').value;
                const btn = document.getElementById('btnSigninGo');

                // „Éê„É™„ÉÅEÅE„Ç∑„Éß„É≥
                if (!office) return showSuccessModal('„Ç®„É©„Éº', null, '‰∫ãÊ•≠ÊâÄ„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                if (!staff) return showSuccessModal('„Ç®„É©„Éº', null, 'ËÅ∑Âì°„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                if (pin.length !== 4) return showSuccessModal('„Ç®„É©„Éº', null, 'PIN„ÇÅEÊ°ÅÂÅEÂäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');

                setButtonLoading(btn, true);

                google.script.run
                    .withSuccessHandler(res => {
                        setButtonLoading(btn, false);

                        if (res.success) {
                            res.expiresAt = Date.now() + (60 * 60 * 1000);
                            APP_STATE.whoami = res;
                            sessionStorage.setItem('gas_whoami', JSON.stringify(res));

                            // [Fix] Set flag to skip filter restoration (just signed in) - BEFORE showMainApp
                            sessionStorage.setItem('skip_filter_restore', 'true');

                            // -----------------------------------------------------
                            // ÁîªÈù¢ÂàÅEÇäÊõø„ÅÅE(Centralized)
                            // -----------------------------------------------------
                            showMainApp();

                            // Header Name Update
                            const uName = document.getElementById('dropdownUserName');
                            if (uName) uName.textContent = res.name;

                            // Success Modal
                            showSuccessModal('Ë™çË®ºÊàêÂäü', null, '„É≠„Ç∞„Ç§„É≥„Åó„Åæ„Åó„Åü');

                            // [Fix] Remove pre-init class on signin success
                            document.body.classList.remove('pre-init');

                            // Load Data
                            console.log('Starting loadAppData...');
                            loadAppData(office, false); // isReload = false (signin)

                        } else {
                            showSuccessModal('Ë™çË®ºÂ§±ÊïÅE, null, res.message);
                        document.getElementById('pinInput').value = '';
                        }
                    })
                    .withFailureHandler(error => {
                        setButtonLoading(btn, false);
                        showSuccessModal('ÈÄö‰ø°„Ç®„É©„Éº', null, error.message);
                    })
                    .verifyUserByPin(office, staff, pin);
            }

            function clearWhoami() {
                // „Çª„ÉÅEÇ∑„Éß„É≥„ÇØ„É™„Ç¢
                APP_STATE.whoami = null;
                sessionStorage.removeItem('gas_whoami');

                // [Fix] Clear filter state from localStorage
                localStorage.removeItem('filter_viewMode');
                localStorage.removeItem('filter_currentDate');

                // [Fix] Reset DOM elements to prevent flash on next signin
                const dateDisplay = document.getElementById('current-date-display');
                if (dateDisplay) dateDisplay.textContent = '';

                document.querySelectorAll('.segment-btn').forEach(b => b.classList.remove('active'));
                const defaultSeg = document.getElementById('seg-day');
                if (defaultSeg) defaultSeg.classList.add('active'); // Default to day

                const btnCurrent = document.getElementById('btn-current');
                if (btnCurrent) btnCurrent.textContent = '‰ªäÊó•„Å∏';

                // [Fix] Clear list containers to prevent flash of old data
                const containers = [
                    'record-list-container',
                    'incidentPendingCards',
                    'incidentHistoryCards',
                    'incidentApprovalList'
                ];
                containers.forEach(id => {
                    const el = document.getElementById(id);
                    if (el) el.innerHTML = '';
                });

                // [Fix] Also hide load more button
                const lm = document.getElementById('load-more-container');
                if (lm) lm.classList.add('hidden');

                // [Fix] Reset badges
                ['badge-all', 'badge-ÊéíÊ≥ÅE, 'badge - ÊúçËñ¨', 'badge - „Éê„Ç§„Çø„É´', 'badge - È£ü‰∫ÅE, 'badge-„Åù„ÅE‰ªÅE].forEach(id => {
                const b = document.getElementById(id);
                if (b) b.textContent = '0';
            });
            const pendingCnt = document.getElementById('inc-pending-count');
            if (pendingCnt) pendingCnt.textContent = '0‰ª∂';

            // „Ç¢„Éó„É™ÁîªÈù¢„ÇíÈùûË°®Á§∫
            const av = document.getElementById('appView');
            if (av) {
                av.classList.add('hidden');
                av.style.display = 'none';
            }

            // [Fix] Hide header to prevent arrows from showing
            const header = document.getElementById('appHeader');
            if (header) {
                header.classList.add('hidden');
                header.style.display = 'none';
            }

            // FAB„ÇíÈùûË°®Á§∫
            showFab(false);

            // „Çµ„Ç§„É≥„Ç§„É≥ÁîªÈù¢„ÇíË°®Á§∫
            const sv = document.getElementById('signinView');
            if (sv) {
                sv.style.display = 'flex';
                sv.classList.remove('hidden', 'opacity-0');
            }

            // „Éï„Ç©„Éº„É†„Çí„É™„Çª„ÉÅEÉà
            const pinInput = document.getElementById('pinInput');
            if (pinInput) pinInput.value = '';

            // ËÅ∑Âì°„Éó„É´„ÉÄ„Ç¶„É≥„Çí„É™„Çª„ÉÅEÉàÅEà‰∫ãÊ•≠ÊâÄÈÅ∏ÊäûÊôÇ„Å´ÂÜçË™≠„ÅøËæº„Åø„Åï„Çå„ÇãÔºÅE            const staffSel = document.getElementById('staffSelect');
            if (staffSel) {
                staffSel.innerHTML = '<option value="" disabled selected>ËÅ∑Âì°„ÇíÈÅ∏ÊäÅE/option>';
                staffSel.disabled = false; // [Fix] „É≠„Ç∞„Ç¢„Ç¶„ÉàÊôÇ„Å´ÁÑ°ÂäπÂåñ„ÇíËß£Èô§
            }

            // ‰∫ãÊ•≠ÊâÄ„É™„Çπ„Éà„ÇíÂÜçË™≠„ÅøËæº„Åø
            loadOfficeList();
        }

            function loadAppData(office, isReload = false) {
                google.script.run.withSuccessHandler(data => {
                    console.log('[Debug] loadAppData success. Users:', data.users ? data.users.length : 'undefined');
                    try {
                        initFullData(data, isReload); // „Ç¢„Éó„É™„Ç±„Éº„Ç∑„Éß„É≥„ÉÅEÅE„Çø„ÅÆÂàùÊúüÂåÅE(Critical: Unhides main-content)
                    } catch (e) {
                        console.error('[Error] initFullData failed:', e);
                        showSuccessModal('ÂàùÊúüÂåñ„Ç®„É©„Éº', null, e.message);
                    }

                    setTimeout(() => {
                        // Force View Update Logic here too
                        showMainApp();

                        renderWhoamiBadge();
                        switchView('list');


                        // [v37+] Setup event listeners after DOM is ready
                        setupEventListeners();

                        // [v37+] Auto-hide success modal after transition
                        setTimeout(() => {
                            const successModal = document.getElementById('success-modal');
                            if (successModal) {
                                successModal.classList.add('opacity-0');
                                setTimeout(() => successModal.classList.add('hidden'), 300);
                            }
                        }, 1000);

                        // FAB„ÅØ showMainApp „ÅßË°®Á§∫Ê∏à„Åø
                        APP_STATE.isInitialized = true;
                    }, 800);
                }).getInitialDataByOffice(office);
            }

            function initFullData(data, isReload = false) {
                APP_STATE.users = data.users || [];
                APP_STATE.phrases = data.phrases || [];
                APP_STATE.staffs = data.staffs || [];

                // Ë®òÈå≤ËÄÅEÅE„É´„ÉÄ„Ç¶„É≥
                // [v40] Ë®òÈå≤ËÄÅE¨ÅEÅE input readonly „Å´Â§âÊõ¥„Åï„Çå„Åü„Åü„ÇÅ„ÄÅ„Åì„Åì„Åß„ÅÆ„Éó„É´„ÉÄ„Ç¶„É≥ÊßãÁØâ„ÅE‰∏çË¶ÅE
                // Âà©Áî®ËÄÅEÅE„É´„ÉÄ„Ç¶„É≥ (PC/SP)
                [document.getElementById('user-selector-pc'), document.getElementById('user-selector-sp')].forEach(sel => {
                    if (!sel) return;
                    sel.innerHTML = '';
                    APP_STATE.users.forEach(u => sel.add(new Option(u.userName, u.userName)));
                });

                if (APP_STATE.users.length > 0) {
                    if (isReload) {
                        // [Fix] Reload: restore filter state from localStorage
                        const savedViewMode = localStorage.getItem('filter_viewMode');
                        const savedDate = localStorage.getItem('filter_currentDate');

                        APP_STATE.viewMode = savedViewMode || 'day';
                        APP_STATE.currentDate = savedDate ? new Date(savedDate) : new Date();

                        // Update UI
                        document.querySelectorAll('.segment-btn').forEach(b => b.classList.remove('active'));
                        const segBtn = document.getElementById(`seg-${APP_STATE.viewMode}`);
                        if (segBtn) segBtn.classList.add('active');

                        const btnCurrent = document.getElementById('btn-current');
                        if (APP_STATE.viewMode === 'day') btnCurrent.textContent = '‰ªäÊó•„Å∏';
                        else if (APP_STATE.viewMode === 'week') btnCurrent.textContent = '‰ªäÈÄ±„Å∏';
                        else if (APP_STATE.viewMode === 'month') btnCurrent.textContent = '‰ªäÊúà„Å∏';

                        // Pre-calculate display to prevent flash
                        const a = new Date(APP_STATE.currentDate); a.setHours(0, 0, 0, 0);
                        let s = new Date(a); let e = new Date(a); let displayText = "";
                        if (APP_STATE.viewMode === 'day') {
                            displayText = formatDateJP(a);
                        } else if (APP_STATE.viewMode === 'week') {
                            const d = a.getDay();
                            const diff = (d === 0 ? 6 : d - 1);
                            s.setDate(a.getDate() - diff); e = new Date(s); e.setDate(s.getDate() + 6);
                            displayText = `${formatDateJP(s, true)} - ${formatDateJP(e, true)}`;
                        } else if (APP_STATE.viewMode === 'month') {
                            s.setDate(1); e = new Date(s.getFullYear(), s.getMonth() + 1, 0);
                            const y = s.getFullYear(); const m = s.getMonth() + 1; displayText = `${y}Âπ¥${m}ÊúÅE;
                    }
                    document.getElementById('current-date-display').textContent = displayText;
                } else {
                    // [Fix] Signin: ALWAYS use today's date
                    APP_STATE.viewMode = 'day';
                    APP_STATE.currentDate = new Date();

                    // Update UI
                    document.querySelectorAll('.segment-btn').forEach(b => b.classList.remove('active'));
                    const segBtn = document.getElementById('seg-day');
                    if (segBtn) segBtn.classList.add('active');

                    const btnCurrent = document.getElementById('btn-current');
                    btnCurrent.textContent = '‰ªäÊó•„Å∏';

                    const displayText = formatDateJP(APP_STATE.currentDate);
                    document.getElementById('current-date-display').textContent = displayText;
                }

                // Initialize date range and load data
                updateDateRange(true);

                console.log('[Debug] Switching to first user:', APP_STATE.users[0].userName);
                switchUser(APP_STATE.users[0].userName);
                // switchUser calls loadRecords internally
            } else {
                console.warn('[Warning] No users found in this office.');
                document.getElementById('record-list-container').innerHTML = '<div class="p-4 text-center text-red-500 font-bold">Âà©Áî®ËÄÅEÅåÁôªÈå≤„Åï„Çå„Å¶„ÅÅEÅæ„Åõ„Çì</div>';
            }

            // Ë°®Á§∫ÂàÅEÇäÊõø„ÅÅE            const li = document.getElementById('loading-initial');
            const mc = document.getElementById('main-content');
            if (li) li.classList.add('hidden');
            if (mc) mc.classList.remove('hidden');

            // [Fix] Remove pre-init class and clear skip flag
            document.body.classList.remove('pre-init');
            sessionStorage.removeItem('skip_filter_restore');

            // ‰∏ã‰Ωç„Éì„É•„Éº„ÅÆÂàùÊúüÂåÅE            switchView('list');
        }

        function switchUser(name) {
            APP_STATE.currentUserName = name;
            const pc = document.getElementById('user-selector-pc');
            const sp = document.getElementById('user-selector-sp');
            if (pc) pc.value = name;
            if (sp) sp.value = name;
            loadRecords(name);
        }

        function loadRecords(name, isAppend = false) {
            console.log(`[Debug] loadRecords called for user: ${ name }, isAppend: ${ isAppend } `);
            const w = getWhoami();
            console.log(`[Debug] getWhoami result: `, w);
            if (!w || !w.officeSelected) {
                console.error('[Error] loadRecords aborted: Invalid whoami or officeSelected missing.');
                return;
            }

            // Set loading state
            APP_STATE.isLoading = true;
            // [Fix] Removed overlay spinner for list loading
            // if (!isAppend) showLoading(true);

            // Hide Load More button during loading ONLY if not appending
            const lm = document.getElementById('load-more-container');
            if (!isAppend && lm) lm.classList.add('hidden');

            const body = document.getElementById('record-list-container');

            // [Fix] Initialize requestNonce if not exists
            if (!APP_STATE.requestNonce) APP_STATE.requestNonce = 0;
            const reqId = ++APP_STATE.requestNonce;

            if (!isAppend) {
                if (body) body.innerHTML = `< div class="flex justify-center items-center py-20 w-full" > ${ getLoaderHtml() }</div > `;
                APP_STATE.allRecords[name] = [];
                APP_STATE.tokens[name] = null;
                APP_STATE.hasMore[name] = false;
            }

            if (isAppend) {
                // Ensure specific button loading
                const btn = document.getElementById('btn-load-more');
                if (btn) setButtonLoading(btn, true);
            }
            try {
                // Timezone„Åö„Çå„ÇíÈò≤„Åê„Åü„ÇÅ„ÄÅISOString„Åß„ÅØ„Å™„Åè„É≠„Éº„Ç´„É´„ÅÆÊó•‰ªòÊñáÂ≠óÂÅE„ÇíÈÄÅ‰ø°
                const options = {
                    startDate: (APP_STATE.filter && APP_STATE.filter.startDate) ? formatDateISO(APP_STATE.filter.startDate) + ' 00:00:00' : null,
                    endDate: (APP_STATE.filter && APP_STATE.filter.endDate) ? formatDateISO(APP_STATE.filter.endDate) + ' 23:59:59' : null,
                    limit: 500,
                    continuationToken: isAppend ? APP_STATE.tokens[name] : null
                };
                console.log('[Debug] loadRecords: Options prepared:', JSON.stringify(options));
                console.log('[Debug] loadRecords: Calling google.script.run.getRecordsByOffice...');

                google.script.run
                    .withSuccessHandler(res => {
                        // [Fix] Race Condition Check - Only process if this is the latest request
                        if (APP_STATE.requestNonce !== reqId) {
                            console.log('[Debug] Ignoring stale request result');
                            // Reset loading states even for stale requests
                            APP_STATE.isLoading = false;
                            if (isAppend) {
                                APP_STATE.isLoadingMore = false;
                                const btn = document.getElementById('btn-load-more');
                                if (btn) setButtonLoading(btn, false);
                            }
                            return;
                        }

                        console.log('[Debug] loadRecords success callback started. Success:', res ? res.success : 'res is null');
                        APP_STATE.isLoading = false;
                        showLoading(false);

                        if (res && res.success) {
                            if (isAppend) {
                                APP_STATE.isLoadingMore = false;
                                const btn = document.getElementById('btn-load-more');
                                if (btn) setButtonLoading(btn, false);
                                // Append new records to existing ones
                                APP_STATE.allRecords[name] = (APP_STATE.allRecords[name] || []).concat(res.records);
                            } else {
                                APP_STATE.allRecords[name] = res.records;
                                // Clear body before rendering to prevent duplication
                                if (body) body.innerHTML = '';
                            }

                            // Update State with Server Result
                            APP_STATE.hasMore[name] = res.hasMore;
                            APP_STATE.tokens[name] = res.continuationToken;

                            renderTable();
                            console.log('[Debug] loadRecords: renderTable called');

                            // „Éú„Çø„É≥Âà∂Âæ°„É≠„Ç∏„ÉÅEÇØ„ÅØÂâäÈô§ (renderTable„Å∏ÂßîË≠≤)

                        } else {
                            if (isAppend) {
                                APP_STATE.isLoadingMore = false;
                                const btn = document.getElementById('btn-load-more');
                                if (btn) setButtonLoading(btn, false);
                            }
                            handleError(res ? res.message : 'Unknown error');
                        }
                    })
                    .withFailureHandler(err => {
                        APP_STATE.isLoading = false;
                        showLoading(false);
                        if (isAppend) {
                            APP_STATE.isLoadingMore = false;
                            const btn = document.getElementById('btn-load-more');
                            if (btn) setButtonLoading(btn, false);
                        }
                        handleError(err);
                    }).getRecordsByOffice(w.officeSelected, name, options);
            } catch (e) {
                APP_STATE.isLoading = false;
                showLoading(false);
                console.error('[Error] google.script.run failed synchronously:', e);
                handleError(e);
            }
        }

        function loadMore() {
            if (APP_STATE.isLoadingMore) return;
            const name = APP_STATE.currentUserName;
            if (!name || !APP_STATE.hasMore[name]) return;

            APP_STATE.isLoadingMore = true;
            const btn = document.getElementById('btn-load-more');
            const originalText = btn.textContent;

            // [Refactor] Use setButtonLoading
            setButtonLoading(btn, true);
            // btn.textContent = 'Ë™≠„ÅøËæº„Åø‰∏≠...'; // Optional: change text if needed, but existing logic kept text?
            // Existing logic didn't change text, just added loader.
            // setButtonLoading adds spinner.

            loadRecords(name, true);
        }

        function findRecordByRowNumber(rn) {
            // [Fix] Use loose equality (==) because rn comes as string from HTML attribute
            return (APP_STATE.allRecords[APP_STATE.currentUserName] || []).find(r => r.rowNumber == rn);
        }

        function setupEventListeners() {
            document.querySelectorAll('.record-item-tab').forEach(btn => btn.addEventListener('click', (e) => {
                document.querySelectorAll('.record-item-tab').forEach(b => {
                    b.classList.remove('tab-active', 'border-indigo-600', 'text-indigo-600');
                    b.classList.add('border-transparent', 'text-gray-500');
                });
                const t = e.currentTarget;
                t.classList.add('tab-active', 'border-indigo-600', 'text-indigo-600');
                t.classList.remove('border-transparent', 'text-gray-500');

                // „Éï„Ç£„É´„Çø„ÉºÈÅ©Áî®
                APP_STATE.filter.item = t.dataset.item;
                renderTable();
            }));
            document.getElementById('record-item')?.addEventListener('change', (e) => renderDynamicInputs(e.target.value));
            document.getElementById('phrase-manager-search')?.addEventListener('input', (e) => { APP_STATE.phraseManager.search = e.target.value; renderPhraseManagerList(); });
            document.getElementById('user-select-search')?.addEventListener('input', renderUserSelectOptions);
            document.getElementById('output-month')?.addEventListener('change', resetOutputView);
            [document.getElementById('user-selector-pc'), document.getElementById('user-selector-sp')].forEach(sel => {
                sel?.addEventListener('change', (e) => { switchUser(e.target.value); resetOutputView(); });
            });

            // [v40] btnMore toggle logic removed (Toolbar flattened)
        }

        function toggleBodyScroll(lock) { document.body.classList.toggle('no-scroll', lock); }
        const isListView = () => !document.getElementById('view-list').classList.contains('hidden');
        const showFab = (show) => {
            const c = document.getElementById('fab-container');
            if (c) c.classList.toggle('hidden', !show);
        };

        const updateFabState = () => {
            if (!APP_STATE.whoami || !APP_STATE.isInitialized) {
                showFab(false);
                return;
            }

            const isList = !document.getElementById('view-list').classList.contains('hidden');
            const isIncident = !document.getElementById('incident-container').classList.contains('hidden');

            const container = document.getElementById('fab-container');
            const btnRecord = document.getElementById('fab-wrapper-record');
            const btnIncident = document.getElementById('fab-wrapper-incident');

            if (!container) return;

            if (isList) {
                // Top Page: Show Both
                container.classList.remove('hidden');
                if (btnRecord) btnRecord.classList.remove('hidden');
                if (btnIncident) btnIncident.classList.remove('hidden');
            } else if (isIncident) {
                // Incident Page: Show Incident Button Only
                container.classList.remove('hidden');
                if (btnRecord) btnRecord.classList.add('hidden');
                if (btnIncident) btnIncident.classList.remove('hidden');
            } else {
                // Others: Hide Container
                container.classList.add('hidden');
            }
        };

        function switchView(viewName) {
            // ÂÖ®ÁîªÈù¢„Çí‰∏ÄÊó¶Èö†„ÅÅE            const views = ['view-list', 'view-output', 'view-manager', 'incident-container'];
            views.forEach(id => document.getElementById(id)?.classList.add('hidden'));

            // ÂØæË±°ÁîªÈù¢„ÇíË°®Á§∫
            const targetId = viewName === 'incident' ? 'incident-container' : (viewName === 'list' ? 'view-list' : `view - ${ viewName } `);
            const target = document.getElementById(targetId);
            if (target) target.classList.remove('hidden');

            // „É™„Çπ„ÉàÁîªÈù¢„Åã„Å©„ÅÅEÅãÂà§ÂÆÅE            const isList = viewName === 'list';

            // „Éò„ÉÉ„ÉÄ„Éº„Ç≥„É≥„Éà„É≠„Éº„É´„ÅÆË°®Á§∫ÂàÅEõø
            document.getElementById('header-controls-list')?.classList.toggle('hidden', !isList);
            document.getElementById('header-tabs-list')?.classList.toggle('hidden', !isList);

            // ‚òÅEøÆÊ≠£: ÂàùÊúüÂåñÂÆå‰∫ÅE∏à„Åø„ÅÆÂ†¥Âêà„ÅE„ÅøFAB„ÇíË°®Á§∫
            if (APP_STATE.isInitialized) {
                updateFabState();
            }

            if (viewName === 'output') initPdfDateInput();

            // „Çπ„ÇØ„É≠„Éº„É´‰ΩçÁΩÆ„Çí„É™„Çª„ÉÅEÉà
            const wrapper = document.getElementById('main-scroll-wrapper');
            if (wrapper) wrapper.scrollTop = 0;
        }

        function toggleUserDropdown() {
            console.log('toggleUserDropdown called');
            const dropdown = document.getElementById('userDropdown');
            if (!dropdown) return console.error('userDropdown not found');
            const wasHidden = dropdown.classList.contains('hidden');
            dropdown.classList.toggle('hidden');
            console.log('Dropdown hidden state:', dropdown.classList.contains('hidden'));

            // [v37 Feature] Click outside to close
            if (wasHidden) {
                // Just opened, add listener
                setTimeout(() => {
                    document.addEventListener('click', closeDropdownOnClickOutside);
                }, 10);
            } else {
                // Just closed, remove listener
                document.removeEventListener('click', closeDropdownOnClickOutside);
            }
        }


        function formatDateISO(date) {
            if (!date) return null;
            const d = new Date(date);
            if (isNaN(d.getTime())) return null;
            return d.getFullYear() + '-' + String(d.getMonth() + 1).padStart(2, '0') + '-' + String(d.getDate()).padStart(2, '0');
        }

        function closeDropdownOnClickOutside(event) {
            const dropdown = document.getElementById('userDropdown');
            const avatarBtn = document.getElementById('userAvatarBtn');
            if (!dropdown || !avatarBtn) return;

            // Check if click is outside both dropdown and avatar button
            if (!dropdown.contains(event.target) && !avatarBtn.contains(event.target)) {
                dropdown.classList.add('hidden');
                document.removeEventListener('click', closeDropdownOnClickOutside);
            }
        }


        // [Deprecated] Duplicate definitions removed. Use global definition around L4170.
        // function showConfirmDialog...
        // function closeConfirm...

        // [v42] Success Modal (Ê±éÁî®ÂåÅE
        function showSuccessModal(title, staffName, message) {
            console.log('showSuccessModal called:', { title, staffName, message });
            const modal = document.getElementById('success-modal');
            const ttl = document.getElementById('success-modal-title');
            const sfx = document.getElementById('success-modal-suffix');
            const nameEl = document.getElementById('success-staff-name');

            if (!modal) {
                console.error('success-modal element not found!');
                return;
            }

            if (ttl) ttl.textContent = title || 'ÊàêÂäü';
            if (sfx) sfx.style.display = message ? 'none' : 'inline'; // „É°„ÉÅEÇª„Éº„Ç∏„Åå„ÅÇ„ÇãÂ†¥Âêà„ÅE„Äå„Åï„Çì„Äç„ÇíÈùûË°®Á§∫
            if (nameEl) nameEl.textContent = message || staffName || '';

            modal.classList.remove('hidden', 'opacity-0');
            console.log('Modal display initiated');
            setTimeout(() => {
                modal.classList.remove('opacity-0');
                const bar = document.getElementById('loading-bar');
                if (bar) bar.style.width = '100%';
            }, 50);

            // Ëá™Âãï„ÅßÈñâ„Åò„ÇÅE            setTimeout(() => {
                modal.classList.add('opacity-0');
                setTimeout(() => modal.classList.add('hidden'), 300);
            }, 2000);
        }

        function showLoading(show = true) {
            const lo = document.querySelector('.loading-overlay');
            if (!lo) return;
            if (show) lo.classList.remove('hidden');
            else lo.classList.add('hidden');
        }
        function hideLoading() { showLoading(false); }

        function handleError(e) { console.error(e); showSuccessModal('„Ç®„É©„Éº', null, (typeof e === 'string' ? e : e.message)); }

        // [v46 Fix] Standardized Confirm Dialog
        function showConfirmDialog(title, msg, onOk) {
            document.getElementById('confirm-title').textContent = title;
            document.getElementById('confirm-message').textContent = msg;

            const okBtn = document.getElementById('confirm-ok-btn');
            // Clone button to remove existing event listeners
            const newBtn = okBtn.cloneNode(true);
            okBtn.parentNode.replaceChild(newBtn, okBtn);

            newBtn.onclick = onOk;

            document.getElementById('confirm-modal').classList.remove('hidden');
        }

        function closeConfirm() {
            document.getElementById('confirm-modal').classList.add('hidden');
        }

        // [Fix] Debounce timeout for filter changes
        let filterTimeout = null;

        // [Fix] Reload app with current filter state (supports all views)
        function reloadApp() {
            // Determine current view and reload accordingly
            const listView = document.getElementById('view-list');
            const outputView = document.getElementById('view-output');
            const incidentView = document.getElementById('incident-container');

            if (listView && !listView.classList.contains('hidden')) {
                // List view: reload records with current filter
                const name = APP_STATE.currentUserName;
                if (name) {
                    updateDateRange(true); // skipDebounce = true
                }
            } else if (incidentView && !incidentView.classList.contains('hidden')) {
                // Incident view: reload pending, approval, and history lists
                if (typeof loadIncidentPendingList === 'function') loadIncidentPendingList();
                if (typeof loadIncidentApprovalList === 'function') loadIncidentApprovalList();
                if (typeof loadIncidentHistory === 'function') loadIncidentHistory();
            } else if (outputView && !outputView.classList.contains('hidden')) {
                // Output view: no automatic reload needed
                console.log('[Debug] Output view active, no reload action');
            }
        }

        function setGranularity(m) {
            APP_STATE.viewMode = m;
            localStorage.setItem('filter_viewMode', m);
            document.querySelectorAll('.segment-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(`seg - ${ m } `).classList.add('active');
            const b = document.getElementById('btn-current');
            if (m === 'day') b.textContent = '‰ªäÊó•„Å∏';
            else if (m === 'week') b.textContent = '‰ªäÈÄ±„Å∏';
            else if (m === 'month') b.textContent = '‰ªäÊúà„Å∏';
            updateDateRange();
        }
        function setToday() {
            APP_STATE.currentDate = new Date();
            localStorage.setItem('filter_currentDate', APP_STATE.currentDate.toISOString());
            updateDateRange();
        }
        function shiftDate(d) {
            const dt = new Date(APP_STATE.currentDate);
            if (APP_STATE.viewMode === 'day') dt.setDate(dt.getDate() + d);
            else if (APP_STATE.viewMode === 'week') dt.setDate(dt.getDate() + (d * 7));
            else if (APP_STATE.viewMode === 'month') dt.setMonth(dt.getMonth() + d);
            APP_STATE.currentDate = dt;
            localStorage.setItem('filter_currentDate', dt.toISOString());
            updateDateRange();
        }
        function updateDateRange(skipDebounce = false) {
            const a = new Date(APP_STATE.currentDate); a.setHours(0, 0, 0, 0);
            let s = new Date(a); let e = new Date(a); let t = "";
            if (APP_STATE.viewMode === 'day') {
                t = formatDateJP(a);
            } else if (APP_STATE.viewMode === 'week') {
                const d = a.getDay();
                const diff = (d === 0 ? 6 : d - 1);
                s.setDate(a.getDate() - diff); e = new Date(s); e.setDate(s.getDate() + 6);
                t = `${ formatDateJP(s, true) } - ${ formatDateJP(e, true) } `;
            } else if (APP_STATE.viewMode === 'month') {
                s.setDate(1); e = new Date(s.getFullYear(), s.getMonth() + 1, 0);
                const y = s.getFullYear(); const m = s.getMonth() + 1; t = `${ y }Âπ¥${ m } ÊúÅE;
                        }
                        document.getElementById('current-date-display').textContent = t;
                        APP_STATE.filter.startDate = new Date(s.setHours(0, 0, 0, 0));
                        APP_STATE.filter.endDate = new Date(e.setHours(23, 59, 59, 999));
                        document.getElementById('custom-start').value = formatDateISO(APP_STATE.filter.startDate);
                        document.getElementById('custom-end').value = formatDateISO(APP_STATE.filter.endDate);

                        // [Fix] Debounce: Wait 300ms before loading records (skip if requested)
                        if (skipDebounce) {
                            // Immediate load (for initial load and refresh button)
                            if (APP_STATE.currentUserName) {
                                loadRecords(APP_STATE.currentUserName);
                            } else {
                                renderTable();
                            }
                        } else {
                            if (filterTimeout) clearTimeout(filterTimeout);
                            filterTimeout = setTimeout(() => {
                                if (APP_STATE.currentUserName) {
                                    loadRecords(APP_STATE.currentUserName);
                                } else {
                                    renderTable();
                                }
                            }, 300);
                        }
                    }
                    function toggleDetailPanel() { const p = document.getElementById('detail-panel'); const i = document.getElementById('detail-icon'); const h = p.classList.contains('hidden'); if (h) { p.classList.remove('hidden'); i.style.transform = 'rotate(180deg)'; } else { p.classList.add('hidden'); i.style.transform = 'rotate(0deg)'; } }
                    function applyCustomRange() {
                        const s = document.getElementById('custom-start').value;
                        const e = document.getElementById('custom-end').value;
                        if (!s || !e) return;

                        APP_STATE.viewMode = 'custom';
                        document.querySelectorAll('.segment-btn').forEach(b => b.classList.remove('active'));
                        APP_STATE.filter.startDate = new Date(s + 'T00:00:00');
                        APP_STATE.filter.endDate = new Date(e + 'T23:59:59');

                        // [Fix] Debounce: Wait 300ms before loading records
                        if (filterTimeout) clearTimeout(filterTimeout);
                        filterTimeout = setTimeout(() => {
                            if (APP_STATE.currentUserName) {
                                loadRecords(APP_STATE.currentUserName);
                            }
                            document.getElementById('current-date-display').textContent = `${formatDateJP(APP_STATE.filter.startDate, true)} - ${formatDateJP(APP_STATE.filter.endDate, true)}`;
                        }, 300);
                    }
                    function resetToDefault() { setGranularity('day'); setToday(); toggleDetailPanel(); }
                    function formatDateJP(d, s = false) {
                        const y = d.getFullYear(); const m = d.getMonth() + 1; const dt = d.getDate(); const w = ["Êó•", "ÊúÅE, "ÁÅ´", "Ê∞¥", "Êú®", "ÈáÅE, "ÂúÅE][d.getDay()]; return s ? `${m}/${dt}(${w})` : `${y}/${m}/${dt} (${w})`; }
        function formatDateISO(d) { if (!d) return ''; const y = d.getFullYear(); const m = ('0' + (d.getMonth() + 1)).slice(-2); const dt = ('0' + d.getDate()).slice(-2); return `${y}-${m}-${dt}`; }

        function enableDragScroll(containerId) {
                                const ele = document.getElementById(containerId); if (!ele) return;
                                let pos = { top: 0, left: 0, x: 0, y: 0 }; let isDragging = false;
                                ele.addEventListener('mousedown', function (e) { if (e.button !== 0 || e.target.closest('button')) return; isDragging = true; ele.style.cursor = 'grabbing'; pos = { left: ele.scrollLeft, top: ele.scrollTop, x: e.clientX, y: e.clientY }; });
                                window.addEventListener('mousemove', function (e) { if (!isDragging) return; ele.scrollTop = pos.top - (e.clientY - pos.y); ele.scrollLeft = pos.left - (e.clientX - pos.x); });
                                window.addEventListener('mouseup', function () { isDragging = false; ele.style.cursor = 'grab'; });
                            }

        function enableMobileGestures(containerId) {
                                const container = document.getElementById(containerId); const wrapper = container.querySelector('.pdf-content-wrapper'); if (!wrapper) return;
                                let startDist = 0, startScale = 1, startX = 0, startY = 0, lastPanX = 0, lastPanY = 0, isPinching = false;
                                container.addEventListener('touchstart', (e) => { if (e.touches.length === 2) { isPinching = true; startDist = Math.hypot(e.touches[0].pageX - e.touches[1].pageX, e.touches[0].pageY - e.touches[1].pageY); startScale = APP_STATE.currentScale; } else if (e.touches.length === 1) { isPinching = false; startX = e.touches[0].pageX; startY = e.touches[0].pageY; lastPanX = APP_STATE.panX; lastPanY = APP_STATE.panY; } }, { passive: false });
                                container.addEventListener('touchmove', (e) => { e.preventDefault(); if (isPinching && e.touches.length === 2) { const dist = Math.hypot(e.touches[0].pageX - e.touches[1].pageX, e.touches[0].pageY - e.touches[1].pageY); if (startDist > 0) updateMobileView(startScale * (dist / startDist), APP_STATE.panX, APP_STATE.panY); } else if (!isPinching && e.touches.length === 1) { updateMobileView(APP_STATE.currentScale, lastPanX + (e.touches[0].pageX - startX) * 1.5, lastPanY + (e.touches[0].pageY - startY) * 1.5); } }, { passive: false });
                            }

        function updateMobileView(scale, panX, panY) {
                                const container = document.getElementById('mobile-pdf-container'); const wrapper = container.querySelector('.pdf-content-wrapper'); if (!wrapper) return;
                                if (scale < APP_STATE.baseScale) scale = APP_STATE.baseScale; if (scale > 5.0) scale = 5.0;
                                const cw = container.clientWidth, ch = container.clientHeight, ww = wrapper.offsetWidth * scale, wh = wrapper.offsetHeight * scale;
                                if (ww <= cw) panX = (cw - ww) / 2; else { if (panX > 0) panX = 0; if (panX < cw - ww) panX = cw - ww; }
                                if (wh <= ch) panY = (ch - wh) / 2; else { if (panY > 0) panY = 0; if (panY < ch - wh) panY = ch - wh; }
                                APP_STATE.currentScale = scale; APP_STATE.panX = panX; APP_STATE.panY = panY;
                                document.getElementById('zoom-level-mobile').textContent = Math.round((scale / APP_STATE.baseScale) * 100) + '%';
                                wrapper.style.transform = `translate(${panX}px, ${panY}px) scale(${scale})`;
                            }

        function loadPdfDocument() { const pdfData = atob(APP_STATE.pdfData.base64); return pdfjsLib.getDocument({ data: pdfData }).promise.then(pdf => { APP_STATE.pdfDoc = pdf; return pdf; }); }

        function renderAllPages(containerId) {
                                const container = document.getElementById(containerId); container.innerHTML = ''; if (!APP_STATE.pdfDoc) return;
                                // [v33 Fix] Reset scroll pos on re-render
                                container.scrollTop = 0; container.scrollLeft = 0;

                                const isSmallScreen = window.innerWidth < 640;
                                const isFull = containerId === 'mobile-pdf-container';
                                const useMobileLayout = isFull && isSmallScreen;

                                // [v33 Fix] Use separated scale variables
                                const scale = useMobileLayout ? 1.5 : (isFull ? APP_STATE.pdfScaleFull : APP_STATE.pdfScale);

                                const wrapper = document.createElement('div');
                                // [v33 Fix] Specific classes for PC centering and padding
                                wrapper.className = useMobileLayout ? 'pdf-content-wrapper' : (isFull ? 'pdf-full-wrapper' : 'pdf-center-wrapper');
                                container.appendChild(wrapper);

                                for (let i = 1; i <= APP_STATE.pdfDoc.numPages; i++) {
                                    const canvas = document.createElement('canvas'); canvas.className = 'pdf-page-canvas'; wrapper.appendChild(canvas);
                                    APP_STATE.pdfDoc.getPage(i).then(page => {
                                        const viewport = page.getViewport({ scale: scale }); const ctx = canvas.getContext('2d');
                                        canvas.height = viewport.height; canvas.width = viewport.width;
                                        if (!useMobileLayout) { canvas.style.width = viewport.width + "px"; canvas.style.height = viewport.height + "px"; }
                                        page.render({ canvasContext: ctx, viewport: viewport });
                                    });
                                }
                                if (useMobileLayout) {
                                    setTimeout(() => { APP_STATE.baseScale = container.clientWidth / wrapper.scrollWidth; updateMobileView(APP_STATE.baseScale, 0, 0); wrapper.classList.add('loaded'); enableMobileGestures(containerId); }, 200);
                                } else enableDragScroll(containerId);
                            }

        function changePdfZoom(delta) {
                                const isFull = !document.getElementById('mobile-pdf-modal').classList.contains('hidden');
                                if (isFull && window.innerWidth < 640) {
                                    const currentPercent = (APP_STATE.currentScale / APP_STATE.baseScale) * 100;
                                    updateMobileView(((currentPercent + delta) / 100) * APP_STATE.baseScale, APP_STATE.panX, APP_STATE.panY);
                                } else if (isFull) {
                                    // [v33 Fix] Fullscreen PC Zoom
                                    const nextScale = APP_STATE.pdfScaleFull + (delta / 100);
                                    if (nextScale >= 0.25 && nextScale <= 5.0) {
                                        APP_STATE.pdfScaleFull = nextScale;
                                        document.getElementById('zoom-level-mobile').textContent = Math.round(nextScale * 100) + '%';
                                        renderAllPages('mobile-pdf-container');
                                    }
                                } else {
                                    // [v33 Fix] Inline PC Zoom
                                    const nextScale = APP_STATE.pdfScale + (delta / 100);
                                    if (nextScale >= 0.25 && nextScale <= 5.0) {
                                        APP_STATE.pdfScale = nextScale;
                                        document.getElementById('zoom-level').textContent = Math.round(nextScale * 100) + '%';
                                        renderAllPages('pc-pdf-container');
                                    }
                                }
                            }

        function requestPdfGeneration() {
                                const w = getWhoami();
                                if (!w || !w.officeSelected) return showToast('error', '„Çµ„Ç§„É≥„Ç§„É≥„Åó„Å¶„Åè„Å†„Åï„ÅÑ');

                                const ym = document.getElementById('output-month').value;
                                if (!ym) {
                                    showToast('error', 'ÂØæË±°Êúà„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                                    return;
                                }
                                const btn = document.getElementById('btn-generate-pdf');
                                // [Refactor] Use setButtonLoading
                                setButtonLoading(btn, true);
                                const span = btn.querySelector('span');
                                if (span) span.textContent = '„Éó„É¨„Éì„É•„Éº‰ΩúÊÅE‰∏≠';
                                document.getElementById('report-message').classList.add('hidden');
                                // Ensure preview area is hidden initially
                                const previewArea = document.getElementById('report-preview-area');
                                if (previewArea) previewArea.classList.add('hidden');

                                // [v33 Fix] Reset scale logic on recreate
                                APP_STATE.pdfScale = 1.0;
                                APP_STATE.pdfScaleFull = 1.0;
                                const zoomLbl = document.getElementById('zoom-level');
                                if (zoomLbl) zoomLbl.textContent = '100%';
                                const zoomLblMob = document.getElementById('zoom-level-mobile');
                                if (zoomLblMob) zoomLblMob.textContent = '100%';

                                google.script.run.withSuccessHandler(res => {
                                    setButtonLoading(btn, false);
                                    btn.querySelector('span').textContent = '„Éó„É¨„Éì„É•„Éº‰ΩúÊÅE';
                                    if (res && res.base64) {
                                        APP_STATE.pdfData = {
                                            base64: res.base64,
                                            fileName: res.fileName
                                        };
                                        document.getElementById('report-preview-area').classList.remove('hidden');
                                        const dlBtn = document.getElementById('btn-download-pdf');
                                        // Base64„Åã„ÇâÁõ¥Êé•„Çª„ÉÅEÉà
                                        dlBtn.href = "data:application/pdf;base64," + res.base64;
                                        dlBtn.download = res.fileName;
                                        // „ÇØ„É™„ÉÅEÇØÊôÇ„Å´„É≠„Ç∞„ÇíË®òÈå≤„Åó„ÄÅ„Éà„Éº„Çπ„Éà„ÇíË°®Á§∫
                                        dlBtn.onclick = () => {
                                            showToast('download', '„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ„ÇíÈñãÂßã„Åó„Åæ„Åó„Åü');
                                            google.script.run.logPdfDownload(w.officeSelected, APP_STATE.currentUserName, res.fileName, w.name);
                                        };
                                        loadPdfDocument().then(() => {
                                            if (window.innerWidth >= 640) renderAllPages('pc-pdf-container');
                                        });
                                        showToast('create', 'PDF„Çí‰ΩúÊÅE„Åó„Åæ„Åó„Åü„ÄÅEbr>„ÉÄ„Ç¶„É≥„É≠„Éº„ÉâÂèØËÉΩ„Åß„Åô„ÄÅE);
                } else {
                                        showToast('error', res.message);
                                    }
                                }).withFailureHandler(function (e) {
                                    console.error("PDF Preview Error:", e);
                                    setButtonLoading(btn, false);
                                    const span = btn.querySelector('span');
                                    if (span) span.textContent = '„Éó„É¨„Éì„É•„Éº‰ΩúÊÅE';

                                    // „Ç®„É©„Éº„Åå„Ç™„Éñ„Ç∏„Çß„ÇØ„Éà„ÅãÊñÅE≠óÂÅE„ÅãÂà§ÂÆö„Åó„Å¶„É°„ÉÅEÇª„Éº„Ç∏„ÇíÊäΩÂá∫
                                    var errorMsg = "‰∏çÊÅE„Å™„Ç®„É©„Éº";
                                    if (typeof e === 'string') {
                                        errorMsg = e;
                                    } else if (e && e.message) {
                                        errorMsg = e.message;
                                    } else {
                                        try {
                                            errorMsg = JSON.stringify(e);
                                        } catch (ex) {
                                            errorMsg = "Unknown Error Object";
                                        }
                                    }

                                    // "undefined" „Å®„ÅÅEÅÜÊñÅE≠óÂÅE„Å´„Å™„Å£„Å¶„Åó„Åæ„Å£„ÅüÂ†¥Âêà„ÅE„Ç¨„Éº„ÉÅE                if (errorMsg === "undefined" || !errorMsg) {
                                    errorMsg = "„Çµ„Éº„Éê„ÅEÊé•Á∂ö„Ç®„É©„Éº„ÄÅ„Åæ„Åü„ÅEÊ®©Èôê„Åå„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÅE;
                                }

                showToast('error', "„Éó„É¨„Éì„É•„ÉºÂ§±ÊïÅE " + errorMsg);
                            }).generatePdfByOffice(w.officeSelected, APP_STATE.currentUserName, ym, w);
                    }

                    function openFullPreview() {
                        toggleBodyScroll(true);
                        showFab(false); // [Fix] FAB„ÇíÈö†„ÅÅE            const isPC = window.innerWidth >= 640, mob = document.getElementById('mobile-pdf-container');
                        if (isPC) { mob.style.overflow = 'auto'; mob.style.touchAction = 'auto'; mob.style.userSelect = 'none'; mob.style.display = 'block'; mob.style.textAlign = 'center'; }
                        else { mob.style.overflow = 'hidden'; mob.style.touchAction = 'none'; }
                        if (APP_STATE.pdfData) {
                            const btn = document.getElementById('btn-download-pdf-mobile');
                            btn.href = "data:application/pdf;base64," + APP_STATE.pdfData.base64;
                            btn.download = APP_STATE.pdfData.fileName;
                            // [Fix] „ÉÄ„Ç¶„É≥„É≠„Éº„ÉâÊôÇ„ÅÆ„Éà„ÅE„Çπ„ÉàË°®Á§∫
                            btn.onclick = () => showToast('download', '„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ„ÇíÈñãÂßã„Åó„Åæ„ÅÅE);
            }
                        document.getElementById('mobile-pdf-modal').classList.remove('hidden');
                        setTimeout(() => renderAllPages('mobile-pdf-container'), 50);
                    }

                    function closeFullPreview() {
                        toggleBodyScroll(false);
                        document.getElementById('mobile-pdf-modal').classList.add('hidden');

                        // [Fix] „Éó„É¨„Éì„É•„Éº„ÇíÈñâ„Åò„Åü„Å®„Åç„ÄÅ„ÇÇ„ÅóDropbox„Éï„Ç©„É´„ÉÄ„ÅåÈñã„ÅÅEÅ¶„ÅÅEÅ™„Åë„Çå„Å∞FAB„ÇíË°®Á§∫
                        const isDbModalOpen = !document.getElementById('dropbox-modal').classList.contains('hidden');
                        if (!isDbModalOpen) {
                            showFab(true);
                        }
                    }

                    function resetOutputView() { document.getElementById('report-preview-area').classList.add('hidden'); document.getElementById('pc-pdf-container').innerHTML = ''; APP_STATE.pdfData = null; APP_STATE.pdfDoc = null; }



                    // [v41 Fix] ÂºïÊï∞Âæ©Ê¥ªÅEà„Éë„ÇπÊåÅEÆö„ÇíÈñã„Åè„Åü„ÇÅÅEÅE        function openDropboxBrowser(path) {
                    toggleBodyScroll(true);
                    showFab(false);
                    document.getElementById('dropbox-modal').classList.remove('hidden');
                    const container = document.getElementById('db-file-list');
                    container.innerHTML = getLoaderHtml();

                    const w = getWhoami();
                    if (!w || !w.officeSelected) return showToast('error', '„Çµ„Ç§„É≥„Ç§„É≥ÊÉÅE†±„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì');

                    // „Éë„ÇπÊåÅEÆö„Åå„ÅÇ„Çå„Å∞„Åù„Çå„Çí„ÄÅ„Å™„Åë„Çå„Å∞nullÅEà„Çµ„Éº„Éê„ÅEÂÅ¥ÂàùÊúüÂÄ§ÅEâ„ÇíÊ∏°„ÅÅE            const targetPath = path || null;

                    google.script.run.withSuccessHandler(renderDropboxList).withFailureHandler(handleError)
                        .getDropboxFilesForWeb(targetPath, APP_STATE.currentUserName, w.officeSelected);
                }

                function renderDropboxList(result) {
                    const container = document.getElementById('db-file-list'); container.innerHTML = '';
                    if (!result.success) { container.innerHTML = `<div class="text-center py-10 text-red-500 text-sm">${result.message}</div>`; return; }
                    const { folders, files, currentPath, rootPath } = result.data; APP_STATE.dropboxPath = currentPath; APP_STATE.dropboxRootPath = rootPath;
                    document.getElementById('db-current-path').textContent = currentPath.replace(APP_STATE.dropboxPrefix, '') || '/ („É´„Éº„ÉÅE';

                    // ‰∏ä„Å∏Êàª„Çã„ÅE„Çø„É≥
                    // [Fix] rootPath „Å´„Çà„ÇãÂà∂Èôê„ÇíÁ∑©Âíå„Åó„ÄÅcurrentPath „ÅåÁ©∫„Åß„Å™„ÅÅEôê„Çä‰∏ä„Å∏Êàª„Çå„Çã„Çà„ÅÜ„Å´„Åô„Çã
                    // „Çµ„Éº„Éê„ÅEÂÅ¥„Åß officeRoot „Çà„Çä‰∏ä„Å´Ë°å„Åã„Å™„ÅÅEÇà„ÅÅEÅ´Âà∂Âæ°„Åó„Å¶„ÅÅEÇã„Åü„ÇÅ„ÄÅ„Åì„Åì„Åß„ÅØÂçòÁ¥î„Å´Ë¶™„Éë„Çπ„ÇíË®àÁÆó„Åô„ÇÅE            // currentPath „ÅÅEofficeRoot „Å®‰∏ÄËá¥„Åô„ÇãÂ†¥Âêà„ÅE„ÄÅ„Åù„Çå‰ª•‰∏ä‰∏ä„Å´Ë°å„Åã„Å™„ÅÅEÄÅE            if (currentPath !== rootPath) {
                    const parentPath = currentPath.substring(0, currentPath.lastIndexOf('/')) || '/';

                    // Ë¶™„Éë„Çπ„ÅÅErootPath „Çà„ÇäÁü≠„ÅÅEºà‰∏ä‰Ωç„Å´„ÅÇ„ÇãÅEâÂ†¥Âêà„Åß„ÇÇ„ÄÅ„Çµ„Éº„Éê„ÅE„ÅåË®±ÂèØ„Åô„Çå„Å∞ÁßªÂãïÂèØËÉΩ„Å®„Åô„Çã„Åå„ÄÅE                // UI‰∏ä„ÅE„Äå‰∫ãÊ•≠ÊâÄ„Éï„Ç©„É´„ÉÄ„Äç„Çà„Çä‰∏ä„ÅEË¶ã„Åõ„Å™„ÅÅEñπ„ÅåÂÆâÂÅE„Åã„ÇÇ„Åó„Çå„Å™„ÅÅEÄÅE                // „É¶„Éº„Ç∂„ÉºË¶ÅÊúõ„ÄåÂà©Áî®ËÄÅEÇà„Çä‰∏ä„Å´Ë°å„Åë„Å™„ÅÅEÄÅE ‰∫ãÊ•≠ÊâÄ„Éï„Ç©„É´„ÉÄ„Åæ„Åß„ÅØË°å„Åç„Åü„ÅÑ„ÄÅE                const up = document.createElement('div'); up.className = 'flex items-center p-3 border-b cursor-pointer text-blue-600 font-bold hover:bg-gray-50';
                    up.innerHTML = `üìÅ .. (‰∏ä„Å∏)`; up.onclick = () => openDropboxBrowser(parentPath);
                    container.appendChild(up);
                }

                // „Éï„Ç©„É´„ÉÄ‰∏ÄË¶ß
                folders.forEach(f => {
                    const div = document.createElement('div'); div.className = 'flex items-center p-3 border-b db-item cursor-pointer';
                    div.innerHTML = `üìÅ <span class="ml-2 font-bold text-gray-700">${f.name}</span>`;
                    div.onclick = () => openDropboxBrowser(f.path);
                    container.appendChild(div);
                });

                // „Äê‰øÆÊ≠£ÁÆÅEâÄ„Äë„Éï„Ç°„Ç§„É´‰∏ÄË¶ß„ÅÆUIÊîπÂñÅE            files.forEach(f => {
                const div = document.createElement('div');
                // flex„É¨„Ç§„Ç¢„Ç¶„Éà„Åß„ÄÅ‰∏≠Ë∫´„ÇíÂ∑¶Âè≥„Å´ÈÖçÁΩÆ„ÄÇ„Ç¢„Ç§„ÉÅEÉ†Èñì„ÅEÈöôÈñì„ÇíÁ¢∫‰øù„ÄÅE                div.className = 'flex items-center justify-between p-3 border-b db-item cursor-pointer gap-3';

                div.innerHTML = `
                    <div class="min-w-0 flex-grow"> <!-- min-w-0„Åå„Å™„ÅÅEÅ®truncate„ÅåÂäπ„Åç„Åæ„Åõ„Çì -->
                        <div class="flex items-center text-sm font-medium text-gray-800">
                            <span class="shrink-0 mr-2">üìÑ</span>
                            <span class="truncate">${f.name}</span> <!-- Èï∑„ÅÅEêçÂâç„ÇíÁúÅÁï• -->
                        </div>
                        <div class="text-[10px] text-gray-400 mt-1 ml-6">
                            ${f.updated} | ${f.size}
                        </div>
                    </div>
                    <div class="shrink-0"> <!-- „Éú„Çø„É≥„ÅåÊΩ∞„Çå„Å™„ÅÅEÇà„ÅÅEÅ´Âõ∫ÂÆÅE-->
                        <span class="px-3 py-1.5 bg-blue-50 text-blue-600 text-xs font-bold rounded-lg border border-blue-100 whitespace-nowrap">
                            Ë°®Á§∫
                        </span>
                    </div>
                `;
                div.onclick = () => openDropboxFilePreview(f.path, f.name);
                container.appendChild(div);
            });
        }

            function openDropboxFilePreview(path, name) {
                showToast('info', '„Éï„Ç°„Ç§„É´„ÇíË™≠„ÅøËæº„Çì„Åß„ÅÅEÅæ„ÅÅE..');
                google.script.run.withSuccessHandler(res => {
                    if (res.success) {
                        APP_STATE.pdfData = { base64: res.data, fileName: name };

                        // [Fix] „Éó„É¨„Éì„É•„ÉºÂÄçÁéá„ÇÅE00%„Å´„É™„Çª„ÉÅEÉà
                        APP_STATE.pdfScaleFull = 1.0;
                        const zoomLabel = document.getElementById('zoom-level-mobile');
                        if (zoomLabel) zoomLabel.textContent = '100%';

                        // [Fix] „Éï„Ç©„É´„ÉÄ„ÇíÈñâ„Åò„Å™„ÅÅEÇà„ÅÅEÅ´„Åì„Åì„Çí„Ç≥„É°„É≥„Éà„Ç¢„Ç¶„Éà„Åæ„Åü„ÅEÂâäÈô§
                        // closeDropboxBrowser();

                        loadPdfDocument().then(openFullPreview);
                    } else {
                        showToast('error', res.message);
                    }
                }).getDropboxFileForPreviewWeb(path);
            }

            function closeDropboxBrowser() {
                document.getElementById('dropbox-modal').classList.add('hidden');
                // [Fix] „É™„Çπ„ÉàÁîªÈù¢„Åß„ÄÅ„Åã„Å§‰ªñ„ÅE„É¢„Éº„ÉÄ„É´„ÅåÈñã„ÅÅEÅ¶„ÅÅEÅ™„ÅÅE†¥Âêà„ÅE„ÅøFAB„ÇíË°®Á§∫
                if (!document.getElementById('view-list').classList.contains('hidden')) {
                    showFab(true);
                }
                toggleBodyScroll(false);
            }

            let currentTrashTab = 'record';

            function openTrashModal() {
                toggleBodyScroll(true);
                showFab(false);
                document.getElementById('trash-modal').classList.remove('hidden');
                switchTrashTab('record');
            }

            function closeTrashModal() {
                document.getElementById('trash-modal').classList.add('hidden');
                updateFabState();
                toggleBodyScroll(false);
            }

            function switchTrashTab(tab) {
                currentTrashTab = tab;
                // Update UI
                const btnRec = document.getElementById('tab-trash-record');
                const btnInc = document.getElementById('tab-trash-incident');
                if (tab === 'record') {
                    btnRec.className = 'py-2 text-sm font-bold text-indigo-600 border-b-2 border-indigo-600';
                    btnInc.className = 'py-2 text-sm font-bold text-gray-400 border-b-2 border-transparent hover:text-gray-600';
                } else {
                    btnRec.className = 'py-2 text-sm font-bold text-gray-400 border-b-2 border-transparent hover:text-gray-600';
                    btnInc.className = 'py-2 text-sm font-bold text-indigo-600 border-b-2 border-indigo-600';
                }
                loadTrashList();
            }

            function loadTrashList() {

                if (!APP_STATE.whoami) return;
                const c = document.getElementById('trash-list-container');
                if (!c) return;
                c.innerHTML = `<div class="flex justify-center items-center py-10 w-full">${getLoaderHtml()}</div>`;

                const w = getWhoami();
                if (!w || !w.officeSelected) return showSuccessModal('„Ç®„É©„Éº', null, '„Çµ„Ç§„É≥„Ç§„É≥ÊÉÅE†±„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì');

                const isRecord = (currentTrashTab === 'record');

                const onSuccess = (r) => {
                    c.innerHTML = '';
                    if (!r || r.length === 0) {
                        c.innerHTML = '<div class="text-center py-10 text-gray-400 text-sm bg-white rounded-lg border">„Ç¥„ÉüÁÆ±„ÅØÁ©∫„Åß„ÅÅE/div>';
                        return;
                    }
                    r.forEach(x => {
                        const d = document.createElement('div');
                        d.className = 'bg-white p-3 rounded-lg border shadow-sm mb-3 flex justify-between items-start';

                        const meta = isRecord
                            ? `${x.recordDate}`
                            : `${x.status || 'ÂâäÈô§Ê∏ÅE}`; // Trash doesn't typically have status but Incident trash might.Default to Deleted.

                        const deleteInfo = `ÂâäÈô§: ${x.deleteDate}`;

                        const head = isRecord
                            ? `${x.user} | ${x.item}`
                            : `${x.user} | ${x.type} (${x.place || ''})`; // Incident: Type (Place)

                        const recorderInfo = `Ë®òÈå≤ËÄÅE ${x.recorder || '(‰∏çÊÅE)'}`;

                        const content = x.content || '';

                        d.innerHTML = `
                        <div class="min-w-0 flex-1 pr-4">
                            <!-- Row 1: Status/DeleteDate | RecordDate -->
                            <div class="text-xs text-gray-400 font-bold mb-1 flex items-center gap-2">
                                <span class="bg-gray-100 px-2 py-0.5 rounded">${deleteInfo}</span>
                                <span>${meta}</span>
                            </div>
                            <!-- Row 2: Target | Category -->
                            <div class="text-sm font-bold text-gray-800 break-words leading-tight mb-1">${head}</div>
                            <!-- Row 3: Recorder -->
                            <div class="text-xs text-gray-500 font-bold mb-2">${recorderInfo}</div>
                            <!-- Row 4: Content -->
                            <div class="text-xs text-gray-500 break-words whitespace-pre-wrap bg-gray-50 p-2 rounded">${content}</div>
                        </div>
                        <button onclick="restoreTrashItem(${x.trashRowIndex})" class="shrink-0 text-emerald-600 bg-emerald-50 px-3 py-1.5 rounded-lg text-xs font-bold transition whitespace-nowrap border border-emerald-100">Âæ©ÂÖÅE/button>
                    `;
                        c.appendChild(d);
                    });
                };

                const onFailure = (err) => {
                    c.innerHTML = '<div class="text-center py-10 text-red-500 text-sm">Ë™≠„ÅøËæº„ÅøÂ§±ÊïÅE/div>';
                    handleError(err);
                };

                if (isRecord) {
                    google.script.run.withSuccessHandler(onSuccess).withFailureHandler(onFailure).getTrashRecords(w.officeSelected);
                } else {
                    google.script.run.withSuccessHandler(onSuccess).withFailureHandler(onFailure).getIncidentTrashRecords(w.officeSelected);
                }
            }

            function restoreTrashItem(idx) {
                const w = getWhoami();
                if (!w) return;
                showSuccessModal('Âæ©ÂÖÅEÅEÁêÅE∏≠', null, '„ÉÅEÅE„Çø„ÇíÂæ©ÂÖÅEÅó„Å¶„ÅÅEÅæ„ÅÅE..');

                const isRecord = (currentTrashTab === 'record');

                const onSuccess = (res) => {
                    showSuccessModal('Âæ©ÂÖÅEÆå‰∫ÅE, null, res);
                loadTrashList(); // Reload trash list
                    // Reload Main Data
                    if (isRecord) {
                        if (APP_STATE.currentUserName) loadRecords(APP_STATE.currentUserName);
                    } else {
                        loadIncidentPendingList();
                        loadIncidentHistory();
                    }
                };

                if (isRecord) {
                    google.script.run.withSuccessHandler(onSuccess).withFailureHandler(handleError).restoreFromTrash(w.officeSelected, idx);
                } else {
                    google.script.run.withSuccessHandler(onSuccess).withFailureHandler(handleError).restoreIncidentFromTrash(w.officeSelected, idx);
                }
            }



            function openRecordModal(mode, rowNum) {
                toggleBodyScroll(true); // Lock
                showFab(false);

                // ‰øùÂ≠ò„ÅE„Çø„É≥„ÅÆÂàùÊúüÂåÅE            const submitBtn = document.getElementById('modal-submit-btn');
                const submitLoader = document.getElementById('submit-loader');
                const submitText = document.getElementById('submit-text');
                if (submitBtn) submitBtn.disabled = false;
                if (submitLoader) {
                    submitLoader.classList.add('hidden');
                    submitLoader.classList.remove('loader-ring', 'ml-2');
                }
                if (submitText) submitText.textContent = '‰øùÂ≠ÅE;

                document.getElementById('record-form').reset();
                document.getElementById('current-mode').value = mode;
                document.getElementById('record-row-number').value = rowNum || '';

                // Ë®òÈå≤ËÄÅEÅEËá™Âãï„Çª„ÉÅEÉà„Å®Âõ∫ÂÆÅE            const recInp = document.getElementById('recorder-select');
                const w = getWhoami();
                if (recInp && w) {
                    recInp.value = w.name;
                }

                const isNew = mode === 'new';
                document.getElementById('single-user-display').classList.toggle('hidden', isNew);
                document.getElementById('multi-user-section').classList.toggle('hidden', !isNew);
                document.getElementById('dynamic-input-area').classList.add('hidden');
                if (isNew) {
                    APP_STATE.selectedUsers = [APP_STATE.currentUserName]; document.getElementById('selected-users-display').textContent = APP_STATE.currentUserName;
                    const now = new Date(); now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
                    document.getElementById('record-date').value = now.toISOString().slice(0, 16);
                } else {
                    const rec = findRecordByRowNumber(rowNum);
                    if (rec) {
                        document.getElementById('single-user-display').textContent = APP_STATE.currentUserName;
                        document.getElementById('record-date').value = rec['Êó•‰ªÅE] ? rec['Êó•‰ªÅE].split('/').join('-').replace(' ', 'T') : '';
                        document.getElementById('record-item').value = rec['È†ÅEõÆ'];
                        document.getElementById('record-content').value = rec['ÁµåÈÅéÂÜÅEÆπ„ÉªÊßòÂ≠ÅE];
                    if (rec['Ë®òÈå≤ËÄÅE] && recInp) recInp.value = rec['Ë®òÈå≤ËÄÅE];
                        renderDynamicInputs(rec['È†ÅEõÆ'], rec.raw);
                    }
                }
                document.getElementById('record-modal').classList.remove('hidden');
            }
            function closeRecordModal() {
                toggleBodyScroll(false); // Unlock
                document.getElementById('record-modal').classList.add('hidden'); showFab(true);
            }

            function handleRecordSubmission() {
                const w = getWhoami();
                if (!w || !w.officeSelected) return showToast('error', '„Çµ„Ç§„É≥„Ç§„É≥„Åó„Å¶„Åè„Å†„Åï„ÅÑ');

                const rec = document.getElementById('recorder-select').value; if (!rec) return showToast('error', 'Ë®òÈå≤ËÄÅEÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                const cat = document.getElementById('record-item').value, raw = getRawData();
                if ((cat === 'ÊéíÊ≥ÅE && !raw.detail1) || (cat === 'È£ü‰∫ÅE && !raw.detail1 && !raw.detail2)) return showToast('error', 'Ë©≥Á¥∞„ÇíÂÅEÂäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                const mode = document.getElementById('current-mode').value, dateVal = document.getElementById('record-date').value.replace('T', ' ').split('-').join('/');
                const data = {
                    'Êó•‰ªÅE: dateVal, 'È†ÅEõÆ': cat, 'ÁµåÈÅéÂÜÅEÆπ„ÉªÊßòÂ≠ÅE: document.getElementById('record-content').value, 'Ë®òÈå≤ËÄÅE: rec, 'raw': raw };
            const btn = document.getElementById('modal-submit-btn');
                    const submitText = document.getElementById('submit-text');
                    // const submitLoader = document.getElementById('submit-loader');

                    // [Refactor] Use setButtonLoading
                    setButtonLoading(btn, true);
            if(submitText) submitText.textContent = '‰øùÂ≠ò‰∏≠...';

                    const runner = google.script.run.withSuccessHandler(res => {
                        setButtonLoading(btn, false);
                        // document.getElementById('submit-loader').classList.add('hidden'); // Removed
                        closeRecordModal();
                        showToast('success', mode === 'new' ? 'Ë®òÈå≤„Çí‰øùÂ≠ò„Åó„Åæ„Åó„Åü' : '‰øÆÊ≠£„Çí‰øùÂ≠ò„Åó„Åæ„Åó„Åü'); // „É°„ÉÅEÇª„Éº„Ç∏„ÇíÈÅ©Ê≠£ÂåÅE                showFab(true); // Âøµ„ÅÆ„Åü„ÇÅÂÜçË°®Á§∫
                        loadRecords(APP_STATE.currentUserName);
                    }).withFailureHandler(err => {
                        setButtonLoading(btn, false);
                        const sl = document.getElementById('submit-loader'); // Legacy cleanup if element exists
                        if (sl) sl.classList.add('hidden');

                        handleError(err);
                    });

                    if(mode === 'new') {
                        if (APP_STATE.selectedUsers.length === 0) return (btn.disabled = false, showToast('error', 'Âà©Áî®ËÄÅEÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ'));
                runner.addRecordByOffice(APP_STATE.whoami.officeSelected, data, APP_STATE.selectedUsers, APP_STATE.whoami);
            } else {
                runner.editRecordByOffice(APP_STATE.whoami.officeSelected, parseInt(document.getElementById('record-row-number').value), data, APP_STATE.whoami);
            }
        }

            function getRawData() {
                const cat = document.getElementById('record-item').value, data = {};
                if (cat === 'ÊéíÊ≥ÅE) data.detail1 = document.querySelector('input[name = "detail-input"]:checked')?.value || "";
            else if (cat === 'ÊúçËñ¨') data.detail1 = document.getElementById('detail-input-text')?.value || "";
                else if (cat === '„Éê„Ç§„Çø„É´') ['temp', 'bph', 'bpl', 'pulse', 'spo2', 'weight'].forEach(k => data[k] = document.getElementById(`v-${k}`).value);
                else if (cat === 'È£ü‰∫ÅE) { data.detail1 = document.getElementById('v - meal').value; data.detail2 = document.getElementById('v - water').value; }
            else if (cat === '„Åù„ÅE‰ªÅE) data.detail1 = document.getElementById('detail - input - select')?.value || "";
                return data;
            }

            function renderDynamicInputs(cat, rd = {}) {
                const d = document.getElementById('dynamic-input-area'); d.innerHTML = ''; d.classList.remove('hidden');
                if (cat === 'ÊéíÊ≥ÅE) d.innerHTML = `<span class="block text-xs font-bold text-gray-500 mb-1">ÊéíÊ≥ÅEå∫ÂàÅE/span><div class="flex gap-2">${['Â§ß', 'Â∞ÅE, 'ÁÑ°'].map(v => `<label class="flex-1 text-center cursor-pointer"><input type="radio" name="detail-input" value="${v}" class="peer sr-only" ${rd.detail1 === v ? 'checked' : ''}><div class="p-3 rounded-lg border border-gray-300 peer-checked:bg-indigo-600 peer-checked:text-white hover:bg-gray-50 text-sm font-bold transition">${v}</div></label>`).join('')
            }</div > `;
            else if (cat === 'ÊúçËñ¨') d.innerHTML = `< label for= "detail-input-text" class= "block text-xs font-bold text-gray-500 mb-1" > ÊúçËñ¨ÈáÅE / label > <input type="text" id="detail-input-text" class="w-full p-3 border rounded-lg text-sm" placeholder="ÂÖ®ÈáÅE value=" ${rd.detail1 || ''}">`;
            else if (cat === '„Éê„Ç§„Çø„É´') d.innerHTML = `<div class="grid grid-cols-2 gap-3">${['temp:‰ΩìÊ∏©(‚ÑÅE', 'pulse:ËÑàÊãç', 'bph:Ë°ÄÂúß(‰∏ÅE', 'bpl:Ë°ÄÂúß(‰∏ÅE', 'spo2:SPO2(%)', 'weight:‰ΩìÈáç(kg)'].map(f => { const [k, l] = f.split(':'); const step = (k === 'temp' || k === 'weight') ? '0.1' : '1'; return `<div><label for="v-${k}" class="text-xs font-bold text-gray-500">${l}</label><input type="number" step="${step}" id="v-${k}" class="w-full p-2.5 border border-gray-300 rounded-lg text-sm" value="${rd[k] || ''}" onblur="if(this.step=='1' && this.value) this.value=Math.round(this.value)"></div>` }).join('')}</div>`;
            else if (cat === 'È£ü‰∫ÅE) d.innerHTML = `<div class="grid grid-cols-2 gap-3"><div><label for="v-meal" class="text-xs font-bold text-gray-500">ÊëÇÂèñÁéÅE%)</label><input type="number" id="v-meal" class="w-full p-2.5 border rounded-lg text-sm" value="${rd.detail1 || ''}"></div><div><label for="v-water" class="text-xs font-bold text-gray-500">Ê∞¥ÂàÅEml)</label><input type="number" id="v-water" class="w-full p-2.5 border rounded-lg text-sm" value="${rd.detail2 || ''}"></div></div>`;
            else if (cat === '„Åù„ÅE‰ªÅE) d.innerHTML = `<label for="detail-input-select" class="block text-xs font-bold text-gray-500 mb-1">È†ÅEõÆ</label><select id="detail-input-select" class="w-full p-3 border rounded-lg text-sm"><option value="">ÈÅ∏ÊäÅE/option>${OTHER_OPTIONS.map(v => `<option value="${v}" ${rd.detail1 === v ? 'selected' : ''}>${v}</option>`).join('')}</select>`;
            else d.classList.add('hidden');
        }

            function openUserSelectModal() {
                toggleBodyScroll(true);
                renderUserSelectOptions();
                document.getElementById('user-select-modal').classList.remove('hidden');
            }
            function closeUserSelectModal() {
                toggleBodyScroll(false);
                document.getElementById('user-select-modal').classList.add('hidden');
            }
            function renderUserSelectOptions() {
                const c = document.getElementById('user-select-list'), s = document.getElementById('user-select-search').value.toLowerCase(); c.innerHTML = '';
                APP_STATE.users.filter(u => u.userName.toLowerCase().includes(s)).forEach(u => {
                    const sel = APP_STATE.selectedUsers.includes(u.userName), d = document.createElement('label');
                    d.className = `flex items-center p-3 rounded-lg border cursor-pointer hover:bg-indigo-50 ${sel ? 'bg-indigo-50 border-indigo-200' : 'bg-white border-gray-200'}`;
                    d.innerHTML = `<input type="checkbox" value="${u.userName}" class="h-4 w-4 text-indigo-600 rounded" ${sel ? 'checked' : ''} onchange="updateSelectedUsers(this)"><span class="ml-2 text-sm font-medium text-gray-700">${u.userName}</span>`;
                    c.appendChild(d);
                });
            }
            function updateSelectedUsers(cb) { if (cb.checked) { if (!APP_STATE.selectedUsers.includes(cb.value)) APP_STATE.selectedUsers.push(cb.value); } else { APP_STATE.selectedUsers = APP_STATE.selectedUsers.filter(u => u !== cb.value); } renderUserSelectOptions(); }
            function confirmUserSelection() { document.getElementById('selected-users-display').textContent = APP_STATE.selectedUsers.length === 0 ? '(Êú™ÈÅ∏ÊäÅE' : APP_STATE.selectedUsers.slice(0, 3).join(', ') + (APP_STATE.selectedUsers.length > 3 ? ' ‰ªÅE..' : ''); closeUserSelectModal(); }

            // ==========================================
            // Helper Functions (renderTableÁî®)
            // ==========================================
            function escapeHtml(unsafe) {
                if (unsafe == null) return "";
                return String(unsafe)
                    .replace(/&/g, "&amp;")
                    .replace(/</g, "&lt;")
                    .replace(/>/g, "&gt;")
                    .replace(/"/g, "&quot;")
                    .replace(/'/g, "&#039;");
            }

            function copyText(text) {
                if (!text) return;
                navigator.clipboard.writeText(text).then(() => {
                    showToast('success', '„ÉÅEÇ≠„Çπ„Éà„Çí„Ç≥„Éî„ÅE„Åó„Åæ„Åó„Åü');
                }).catch(err => {
                    console.error('Copy failed:', err);
                    showToast('error', '„Ç≥„Éî„ÅE„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
                });
            }

            // editRecord„É©„ÉÅEÉë„Éº (Êó¢Â≠ò„ÅEopenRecordModal„ÇíÂëº„Å≥Âá∫„ÅÅE
            function editRecord(rowId) {
                openRecordModal('edit', rowId);
            }

            // ==========================================
            // ‰øÆÊ≠£ÁâÅErenderTable: PC„ÅØ„ÉÅEÅE„Éñ„É´„ÄÅ„Çπ„Éû„ÅE„ÅØ„Ç´„Éº„Éâ„ÅßË°®Á§∫
            // ==========================================
            // Update Badge Counts
            function updateCategoryBadges(records) {
                const counts = {
                    'all': records.length, 'ÊéíÊ≥ÅE: 0, 'ÊúçËñ¨': 0, '„Éê„Ç§„Çø„É´': 0, 'È£ü‰∫ÅE: 0, '„Åù„ÅE‰ªÅE: 0 };
            records.forEach(r => {
                        const c = r['È†ÅEõÆ'];
                        if (counts.hasOwnProperty(c)) counts[c]++;
                        else counts['„Åù„ÅE‰ªÅE]++;
            });
                    Object.keys(counts).forEach(k => {
                        const el = document.getElementById('badge-' + k);
                        if (el) el.textContent = counts[k];
                    });
                }

                function renderTable(records) {
                    const name = APP_STATE.currentUserName;

                    // 1. „ÉÅEÅE„ÇøÂèñÂæóÔºàÂºïÊï∞„Åå„Å™„ÅÅE†¥Âêà„ÅEState„Åã„ÇâÂèñÂæóÔºÅE            let displayRecords = records;
                    if (!displayRecords) {
                        if (name && APP_STATE.allRecords[name]) {
                            displayRecords = APP_STATE.allRecords[name];
                        } else {
                            displayRecords = [];
                        }
                    }

                    // Update Badges based on ALL available records for this period (before filtering)
                    updateCategoryBadges(displayRecords);


                    // 2. „ÇØ„É©„Ç§„Ç¢„É≥„ÉàÂÅE„Éï„Ç£„É´„Çø„ÉºÈÅ©Áî® (È†ÅEõÆ„Éï„Ç£„É´„Çø„Éº)
                    const filterItem = (APP_STATE.filter && APP_STATE.filter.item) ? APP_STATE.filter.item : 'all';
                    if (filterItem && filterItem !== 'all') {
                        displayRecords = displayRecords.filter(r => r['È†ÅEõÆ'] === filterItem);
                    }

                    const container = document.getElementById('record-list-container');
                    container.innerHTML = '';
                    container.classList.remove('hidden'); // Ensure container is visible

                    if (!displayRecords || displayRecords.length === 0) {
                        container.innerHTML = '<div class="text-center text-gray-500 py-8">Ë®òÈå≤„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</div>';
                        toggleLoadMoreButton(false);
                        return;
                    }

                    // --- 1. PCÁî®„ÉÅEÅE„Éñ„É´Ë°®Á§∫ (md‰ª•‰∏ä„ÅßË°®Á§∫) ---
                    const tableHTML = document.createElement('div');
                    // Remove Tailwind visibility classes, use Custom Robust Class
                    tableHTML.className = 'w-full overflow-x-auto mb-4 responsive-table-view';
                    tableHTML.innerHTML = `
                <table class="min-w-full bg-white border border-gray-200 divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-32">Êó•ÊôÅE/th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider min-w-[120px]">È†ÅEõÆ„ÉªË©≥Á¥∞</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ÁµåÈÅéÂÜÅEÆπ</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-24">Ë®òÈå≤ËÄÅE/th>
                            <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider w-32">Êìç‰ΩÅE/th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200" id="pc-table-body"></tbody>
                </table>
            `;

                    // --- 2. „Çπ„Éû„ÅEÁî®„Ç´„Éº„ÉâË°®Á§∫ (mdÊú™Ê∫Ä„ÅßË°®Á§∫) ---
                    const mobileHTML = document.createElement('div');
                    // Remove Tailwind visibility classes, use Custom Robust Class
                    mobileHTML.className = 'space-y-4 responsive-card-view';
                    mobileHTML.id = 'mobile-card-list';

                    const tbody = tableHTML.querySelector('#pc-table-body');

                    displayRecords.forEach(record => {
                        const timestamp = record['Êó•‰ªÅE];
                const category = record['È†ÅEõÆ'];
                        const detail = record['Ë©≥Á¥∞'];
                        const recorder = record['Ë®òÈå≤ËÄÅE];
                const rowId = record.rowNumber || record.id;
                        const tags = record.tags || '';
                        const dateObj = timestamp ? new Date(timestamp) : new Date();
                        const dateStr = dateObj.toLocaleDateString('ja-JP') + ' ' + dateObj.toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit' });

                        // PCË°ÅE                const tr = document.createElement('tr');
                        tr.className = 'hover:bg-gray-50 transition-colors';

                        // ÁµåÈÅéÂÜÅEÆπ„ÅÆÁúÅÁï•„É≠„Ç∏„ÉÅEÇØ
                        const content = record['ÁµåÈÅéÂÜÅEÆπ„ÉªÊßòÂ≠ÅE] || '';
                        let contentHtml = escapeHtml(content);
                        const maxLen = 40;
                        if (content.length > maxLen) {
                            contentHtml = escapeHtml(content.substring(0, maxLen)) + '... ' +
                                `<button onclick="openTextDetail('${rowId}')" class="text-indigo-600 hover:underline text-xs font-bold ml-1">Ë©≥Á¥∞„ÇíË¶ã„Çã</button>`;
                        } else if (!content) {
                            contentHtml = '<span class="text-gray-300">-</span>';
                        }

                        // Ë©≥Á¥∞„Éê„ÉÉ„Ç∏„ÅÆ„Çπ„Çø„Ç§„É´ÂàÅEÅë
                        let detailBadgeClass = "bg-gray-100 text-gray-600";
                        if (category === 'ÊéíÊ≥ÅE) detailBadgeClass = "bg-indigo-50 text-indigo-700";
                else if (category === '„Éê„Ç§„Çø„É´') detailBadgeClass = "bg-pink-50 text-pink-700";
                        else if (category === 'È£ü‰∫ÅE) detailBadgeClass = "bg-emerald-50 text-emerald-700";
                else if (category === 'ÊúçËñ¨') detailBadgeClass = "bg-blue-50 text-blue-700";
                        else if (category === '„Åù„ÅE‰ªÅE) detailBadgeClass = "bg-purple-50 text-purple-700";

                // Vital Custom Display Helper
                const getVitalHtml = (rec) => {
                                if (!rec.raw) return escapeHtml(rec['Ë©≥Á¥∞']);
                                const r = rec.raw;
                                const items = [];
                                const makeBadge = (text, type) => {
                                    let c = 'bg-emerald-50 text-emerald-700'; // Normal
                                    if (type === 'red') c = 'bg-red-50 text-red-700';
                                    else if (type === 'orange') c = 'bg-orange-50 text-orange-700';
                                    else if (type === 'blue') c = 'bg-blue-50 text-blue-700';
                                    return `<span class="${c} font-bold px-1.5 py-0.5 rounded">${text}</span>`;
                                };

                                // Temp
                                if (r.temp) {
                                    const v = parseFloat(r.temp);
                                    let type = 'green';
                                    if (v >= 37.5) type = 'red';
                                    else if (v >= 37.0) type = 'orange';
                                    items.push(makeBadge(`ÁÜ±: ${r.temp}`, type));
                                }
                                // BP
                                if (r.bph || r.bpl) {
                                    const h = Math.round(parseFloat(r.bph || 0));
                                    const l = Math.round(parseFloat(r.bpl || 0));
                                    const hVal = isNaN(h) ? (r.bph || '') : h;
                                    const lVal = isNaN(l) ? (r.bpl || '') : l;
                                    let type = 'green';
                                    if (h >= 140 || l >= 90) type = 'red';
                                    else if (h < 90) type = 'blue';
                                    items.push(makeBadge(`BP: ${hVal}/${lVal}`, type));
                                }
                                // Pulse
                                if (r.pulse) {
                                    const v = Math.round(parseFloat(r.pulse));
                                    const vVal = isNaN(v) ? r.pulse : v;
                                    let type = 'green';
                                    if (v > 100) type = 'red';
                                    else if (v < 50) type = 'blue';
                                    items.push(makeBadge(`ËÑÅE ${vVal}`, type));
                                }
                                // SpO2
                                if (r.spo2) {
                                    const v = Math.round(parseFloat(r.spo2));
                                    const vVal = isNaN(v) ? r.spo2 : v;
                                    let type = 'green';
                                    if (v < 90) type = 'red';
                                    else if (v < 94) type = 'orange';
                                    items.push(makeBadge(`SpO2: ${vVal}`, type));
                                }
                                // Weight
                                if (r.weight) {
                                    items.push(makeBadge(`ÈáÅE ${r.weight}`, 'green'));
                                }

                                if (items.length === 0) return escapeHtml(rec['Ë©≥Á¥∞']);

                                // Flex Layout: Natural wrapping based on content width
                                return `<div class="flex flex-wrap gap-x-2 gap-y-1 text-xs leading-5">
                              ${items.join('')}
                            </div>`;
                            };

                        let detailContent = "";
                        if (category === '„Éê„Ç§„Çø„É´') {
                            detailContent = getVitalHtml(record);
                        } else {
                            if (detail) detailContent = `<span class="px-2 py-0.5 rounded text-xs font-bold ${detailBadgeClass}">${escapeHtml(detail)}</span>`;
                        }

                        tr.innerHTML = `
                    <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-900">${dateStr}</td>
                    <td class="px-4 py-4 whitespace-nowrap text-sm align-top">
                        <div class="flex flex-col gap-1">
                            <span class="font-bold text-gray-700 text-xs">${category}</span>
                            ${detailContent ? (category === '„Éê„Ç§„Çø„É´' ? detailContent : `<div>${detailContent}</div>`) : ''}
                        </div>
                    </td>
                    <td class="px-4 py-4 text-sm text-gray-600 max-w-md break-words align-top">
                        ${contentHtml}
                    </td>
                    <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-500 align-top">${escapeHtml(recorder)}</td>
                    <td class="px-4 py-4 whitespace-nowrap text-right text-sm font-medium align-top">
                        <button onclick="copyRecord('${rowId}')" class="text-teal-600 hover:text-teal-800 mx-1 p-1 hover:bg-teal-50 rounded" title="„Ç≥„Éî„ÅE"><i class="fas fa-copy"></i></button>
                        <button onclick="editRecord('${rowId}')" class="text-indigo-600 hover:text-indigo-800 mx-1 p-1 hover:bg-indigo-50 rounded" title="Á∑®ÈõÅE><i class="fas fa-edit"></i></button>
                        <button onclick="deleteRecord('${rowId}')" class="text-red-600 hover:text-red-800 mx-1 p-1 hover:bg-red-50 rounded" title="ÂâäÈô§"><i class="fas fa-trash-alt"></i></button>
                    </td>
                `;
                        tbody.appendChild(tr);

                        // „Çπ„Éû„ÅE„Ç´„Éº„ÉÅE                const card = document.createElement('div');
                        card.className = 'bg-white p-4 rounded-lg shadow border border-gray-100';
                        card.innerHTML = `
                    <div class="flex justify-between items-start mb-2">
                        <span class="text-sm text-gray-500">${dateStr}</span>
                        <span class="px-2 py-1 text-xs font-bold rounded bg-gray-100 text-gray-700">${category}</span>
                    </div>
                    <div class="text-gray-800 mb-2 font-medium">
                        ${tags ? `<span class="text-blue-600 text-xs mr-1">[${tags}]</span>` : ''}
                        ${detailContent || ''}
                    </div>
                    ${content ? `<div class="text-gray-600 text-sm mb-3 bg-gray-50 p-2 rounded">${contentHtml}</div>` : ''}
                    <div class="flex justify-between items-center border-t pt-2 mt-2">
                        <span class="text-xs text-gray-400">Ë®òÈå≤: ${escapeHtml(recorder)}</span>
                        <div class="flex space-x-3">
                            <button onclick="copyText('${escapeHtml(detail || '')} ${escapeHtml(content || '')}')" class="text-gray-400"><i class="fas fa-copy"></i></button>
                            <button onclick="editRecord('${rowId}')" class="text-blue-500"><i class="fas fa-edit"></i></button>
                            <button onclick="deleteRecord('${rowId}')" class="text-red-500"><i class="fas fa-trash-alt"></i></button>
                        </div>
                    </div>
                `;
                        mobileHTML.appendChild(card);
                    });

                    container.appendChild(tableHTML);
                    container.appendChild(mobileHTML);

                    // 3. Load More„Éú„Çø„É≥„ÅÆÂà∂Âæ°
                    // State„ÅÆÂÖ®„É¨„Ç≥„Éº„ÉâÊï∞„ÇíÁ¢∫Ë™ç„Åó„ÄÅE00‰ª∂‰ª•‰∏ä„Åã„Å§hasMore„Éï„É©„Ç∞„ÅåÁ´ã„Å£„Å¶„ÅÅEÇãÂ†¥Âêà„ÅE„ÅøË°®Á§∫
                    const totalCount = (APP_STATE.allRecords[name] || []).length;
                    const hasMore = APP_STATE.hasMore[name] === true;
                    const shouldShow = hasMore && totalCount >= 500;

                    // „Éï„Ç£„É´„ÇøÈÅ©Áî®‰∏≠„ÅØ„Éú„Çø„É≥„ÇíÂÅE„Åï„Å™„ÅÅEºà„Åæ„Åü„ÅEÂÖ®‰ª∂„É≠„Éº„ÉâÊ∏à„ÅøÊâ±„ÅÅEÅ´„Åô„ÇãÅEâÈÅãÁî®„ÇÇËÄÅEÅà„Çâ„Çå„Çã„Åå„ÄÅE            // „Åì„Åì„Åß„ÅØ„Äå„Éá„Éº„Çø„Åå„Åæ„Å†„Çµ„Éº„Éê„ÅE„Å´„ÅÇ„Çã„Å™„ÇâÂÅE„Åô„Äç„É≠„Ç∏„ÉÅEÇØ„Å´„Åô„Çã
                    toggleLoadMoreButton(shouldShow);
                }

                function toggleLoadMoreButton(show) {
                    const container = document.getElementById('load-more-container');
                    if (container) {
                        if (show) container.classList.remove('hidden');
                        else container.classList.add('hidden');
                    }
                }

                function openTextDetail(rn) {
                    const rec = findRecordByRowNumber(rn); if (rec) {
                        showTextDetail(rec['ÁµåÈÅéÂÜÅEÆπ„ÉªÊßòÂ≠ÅE]); } }
        function copyRecord(rn) {
                                const r = findRecordByRowNumber(rn); if (!r) return; openRecordModal('new'); setTimeout(() => {
                                    document.getElementById('record-item').value = r['È†ÅEõÆ']; renderDynamicInputs(r['È†ÅEõÆ'], r.raw); document.getElementById('record-content').value = r['ÁµåÈÅéÂÜÅEÆπ„ÉªÊßòÂ≠ÅE]; }, 50); }
        function deleteRecord(rn) {
                                        showConfirmDialog('ÂâäÈô§', '„Åì„ÅEË®òÈå≤„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÅEü\nÅEà„Ç¥„ÉüÁÆ±„Å∏ÁßªÂãï„Åó„Åæ„ÅôÔºÅE, () => {
                const btn = document.getElementById('confirm-ok-btn');
                                        setButtonLoading(btn, true);
                                        // Do not change text to keep spinner

                                        const w = getWhoami();
                                        if (!w || !w.officeSelected) return showToast('error', '„Çµ„Ç§„É≥„Ç§„É≥ÊÉÅE†±‰∏çË∂≥');

                                        google.script.run.withSuccessHandler(res => {
                                            closeConfirm(); // Success -> Close
                                            showToast('success', res || 'ÂâäÈô§„Åó„Åæ„Åó„Åü');
                                            // Reload
                                            const name = APP_STATE.currentUserName;
                                            if (name) loadRecords(name);
                                        }).withFailureHandler(err => {
                                            setButtonLoading(btn, false); // Fail -> Enable button
                                            handleError(err);
                                        }).deleteRecordByOffice(w.officeSelected, rn, w);
                                    }, true); // manualClose = true
                            }


        // [v43 Feature] Dynamic Phrase Manager
        function openPhraseManagerModal(targetId = 'record-content', defaultCategory = 'ÊéíÊ≥ÅE) {
            toggleBodyScroll(true);
                        APP_STATE.phraseTargetId = targetId; // ‰øùÂ≠òÂÅEID„Çí„Çª„ÉÅEÉà
                        APP_STATE.phraseManager.category = defaultCategory;

                        // „Ç´„ÉÅEÇ¥„É™„Çø„Éñ„ÅEÈÅ∏ÊäûÁä∂ÊÖãÊõ¥Êñ∞ÅEà„ÇÇ„Åó„Çø„Éñ„Åå„ÅÇ„Çå„Å∞ÅEÅE            // renderPhraseCategoryTabs„ÅßÂÜçÊèèÁîª„Åï„Çå„Çã„ÅE„Åß„Åì„Åì„Åß„ÅØ„É¢„ÉÅEÉ´Êõ¥Êñ∞„ÅÆ„Åø„ÅßOK

                        renderPhraseCategoryTabs();
                        renderPhraseManagerList();
                        document.getElementById('phrase-manager-modal').classList.remove('hidden');
                    }

                    function closePhraseManagerModal() {
                        toggleBodyScroll(false);
                        document.getElementById('phrase-manager-modal').classList.add('hidden');
                    }
                    function renderPhraseCategoryTabs() {
                        const c = document.getElementById('phrase-category-tabs'); c.innerHTML = '';
                        CATEGORIES.forEach(cat => {
                            const b = document.createElement('button');
                            b.className = `px-4 py-2 text-sm font-bold rounded-lg whitespace-nowrap transition ${APP_STATE.phraseManager.category === cat ? 'bg-indigo-600 text-white' : 'bg-gray-100 text-gray-600'}`;
                            b.textContent = cat;
                            b.onclick = () => { APP_STATE.phraseManager.category = cat; renderPhraseCategoryTabs(); renderPhraseManagerList(); };
                            c.appendChild(b);
                        });
                    }
                    function renderPhraseManagerList() {
                        const c = document.getElementById('phrase-manager-list'); c.innerHTML = '';
                        const filtered = APP_STATE.phrases.filter(p => p.Âå∫ÂàÅE === APP_STATE.phraseManager.category && p.ÂÜÅEÆπ.toLowerCase().includes(APP_STATE.phraseManager.search.toLowerCase()));
                        if (filtered.length === 0) return c.innerHTML = '<div class="p-4 text-center text-gray-400">„Å™„ÅÅE/div>';
                        filtered.forEach(p => {
                            const d = document.createElement('div');
                            d.className = 'flex justify-between items-center bg-white p-3 mb-2 rounded border hover:bg-gray-50 transition';
                            const safe = p.ÂÜÅEÆπ.replace(/'/g, "\\'");
                            d.innerHTML = `<div class="text-sm cursor-pointer flex-grow mr-2" onclick="insertPhraseToForm('${safe}')">${p.ÂÜÅEÆπ}</div>
                               <div class="flex gap-2 shrink-0">
                                   <button onclick="openEditPhraseModal('${safe}', '${p.Âå∫ÂàÅE')" class="text-blue-500 border px-2 py-1 rounded text-xs">Á∑®ÈõÅE/button>
                                < button onclick = "deletePhrase('${safe}')" class="text-red-500 border px-2 py-1 rounded text-xs" > ÂâäÈô§</button >
                               </div > `;
                c.appendChild(d);
            });

            // [v33 Fix] Force Reflow for Phrase List (Pointer Events)
            if (c) {
                c.scrollTop = 0;
                // c.style.pointerEvents = 'none'; // Lock interaction only
            }

            setTimeout(() => {
                if (c) {
                    void c.offsetHeight;
                    c.style.pointerEvents = 'auto'; // Unlock interaction
                }
            }, 200); // 200ms delay
        }
        function insertPhraseToForm(t) { const a = document.getElementById('record-content'); a.value += (a.value ? '\n' : '') + t; closePhraseManagerModal(); }
        function addNewPhrase() { const t = document.getElementById('new-phrase-input').value.trim(); if (!t) return; google.script.run.withSuccessHandler(() => { APP_STATE.phrases.push({ Âå∫ÂàÅE APP_STATE.phraseManager.category, ÂÜÅEÆπ: t }); document.getElementById('new-phrase-input').value = ''; renderPhraseManagerList(); showToast('success', 'ËøΩÂä†ÂÆå‰∫ÅE); }).addPhraseToMaster(APP_STATE.phraseManager.category, t); }
        function deletePhrase(t) { showConfirmDialog('ÂâäÈô§', `ÂÆöÂûãÊñÅEÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÅEü`, () => google.script.run.withSuccessHandler(() => {
                                    APP_STATE.phrases = APP_STATE.phrases.filter(p => !(p.Âå∫ÂàÅE === APP_STATE.phraseManager.category && p.ÂÜÅEÆπ === t)); renderPhraseManagerList(); showToast('success', 'ÂâäÈô§ÂÆå‰∫ÅE); }).updatePhrase(t, null, APP_STATE.phraseManager.category, true)); }
        function openEditPhraseModal(t, c) { document.getElementById('edit-phrase-old-text').value = t; document.getElementById('edit-phrase-category').value = c; document.getElementById('edit-phrase-input').value = t; document.getElementById('phrase-edit-modal').classList.remove('hidden'); }
        function submitEditPhrase() {
                                            const old = document.getElementById('edit-phrase-old-text').value, neo = document.getElementById('edit-phrase-input').value.trim(), cat = document.getElementById('edit-phrase-category').value; google.script.run.withSuccessHandler(() => {
                                                const p = APP_STATE.phrases.find(x => x.Âå∫ÂàÅE === cat && x.ÂÜÅEÆπ === old); if (p) p.ÂÜÅEÆπ = neo; renderPhraseManagerList(); document.getElementById('phrase-edit-modal').classList.add('hidden'); showToast('success', 'Êõ¥Êñ∞ÂÆå‰∫ÅE); }).updatePhrase(old, neo, cat, false); }

        function saveToDropbox() {
                                                        if (!APP_STATE.pdfData) return;

                                                        // ÁèæÂú®„ÅÆ„É≠„Ç∞„Ç§„É≥ÊÉÅE†±„ÇíÂèñÂæÅE            const w = getWhoami();
                                                        if (!w || !w.officeSelected) return showToast('error', '‰∫ãÊ•≠ÊâÄÊÉÅE†±„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì');

                                                        const btn = document.getElementById('btn-save-dropbox');
                                                        // [Refactor] Use setButtonLoading
                                                        setButtonLoading(btn, true);
                                                        btn.querySelector('span').textContent = 'Dropbox„Å∏‰øùÂ≠ò‰∏≠';

                                                        google.script.run
                                                            .withSuccessHandler(res => {
                                                                setButtonLoading(btn, false);
                                                                btn.querySelector('span').textContent = 'Dropbox„Å∏‰øùÂ≠ÅE;
                                                                showToast(res.success ? 'success' : 'error', res.message);
                                                            })
                                                            .withFailureHandler(err => {
                                                                setButtonLoading(btn, false);
                                                                btn.querySelector('span').textContent = 'Dropbox„Å∏‰øùÂ≠ÅE;
                                                                handleError(err);
                                                            })
                                                            // ‰øÆÊ≠£: Á¨¨1ÂºïÊï∞„Å´ w.officeSelected (‰∫ãÊ•≠ÊâÄÂêÅE„ÄÅÁ¨¨5ÂºïÊï∞„Å´ w.name (ÂÆüË°åËÄÅE „ÇíËøΩÂä†
                                                            .saveToDropboxFromWebapp(w.officeSelected, APP_STATE.currentUserName, APP_STATE.pdfData.base64, APP_STATE.pdfData.fileName, w.name);
                                                    }

        // --- Phase 3.1 Incident Logic ---

        function openIncidentModal() {
                                                        toggleBodyScroll(true);
                                                        showFab(false);
                                                        // „Éû„Çπ„Çø„ÉÅEÅE„Çø„ÅÆ„Çª„ÉÅEÉà
                                                        const recSel = document.getElementById('inc-recorder');
                                                        const userSel = document.getElementById('inc-user');
                                                        recSel.innerHTML = '';
                                                        userSel.innerHTML = '';

                                                        // ËÅ∑Âì°„É™„Çπ„ÉÅE            APP_STATE.staffs.forEach(s => {
                                                        const o = document.createElement('option');
                                                        o.value = s; o.text = s;
                                                        recSel.appendChild(o);
                                                    });

                                                // --- ‰øÆÊ≠£ÁÆÅEâÄ: „Åì„Åì„Åã„Çâ ---
                                                // „ÄåÂ§ñÈÉ®„Äç„Ç™„Éó„Ç∑„Éß„É≥„ÇíÂÅEÈ†≠„Å´ËøΩÂä†
                                                const extOption = document.createElement('option');
                                                extOption.value = 'Â§ñÈÉ®';
                                                extOption.text = 'Â§ñÈÉ® (ËøëÈö£„Éª„Åù„ÅE‰ªÅE';
                                                extOption.style.fontWeight = 'bold'; // ÁõÆÁ´ã„Åü„Åõ„Çã
                                                extOption.style.color = '#d97706'; // Â∞ë„ÅóËâ≤„ÇíÂ§â„Åà„ÇãÔºà‰ªªÊÑèÔºÅE            userSel.appendChild(extOption);
                                                // --- ‰øÆÊ≠£ÁÆÅEâÄ: „Åì„Åì„Åæ„Åß ---

                                                // Âà©Áî®ËÄÅEÉ™„Çπ„ÉÅE(„Éû„Çπ„Çø„Åã„Çâ)
                                                APP_STATE.users.forEach(u => {
                                                    const o = document.createElement('option');
                                                    o.value = u.userName; o.text = u.userName;
                                                    userSel.appendChild(o);
                                                });

                                                // Êó•ÊôÇÂÅEÊúüÂÄ§
                                                const now = new Date();
                                                now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
                                                document.getElementById('inc-date').value = now.toISOString().slice(0, 16);

                                                // ÈÅ∏Êäû‰∏≠„ÅÆÂà©Áî®ËÄÅEÅå„ÅÅEÇå„Å∞„Çª„ÉÅEÉàÅEà„Åü„Å†„ÅóÂ§ñÈÉ®‰ª•Â§ñ„ÅEÂ†¥ÂêàÔºÅE            if (APP_STATE.currentUserName) {
                                                userSel.value = APP_STATE.currentUserName;
                                            }

            document.getElementById('incident-modal').classList.remove('hidden');
                                        }

        function closeIncidentModal() {
                                            toggleBodyScroll(false);
                                            document.getElementById('incident-modal').classList.add('hidden');
                                            showFab(true);
                                        }

        function submitIncident() {
                                            const w = getWhoami();
                                            if (!w) return;

                                            const form = {
                                                recorder: document.getElementById('inc-recorder').value,
                                                user: document.getElementById('inc-user').value,
                                                occurDate: document.getElementById('inc-date').value,
                                                type: document.getElementById('inc-type').value,
                                                place: document.getElementById('inc-place').value,
                                                situation: document.getElementById('inc-situation').value,
                                                cause: document.getElementById('inc-cause').value,
                                                response: document.getElementById('inc-response').value,
                                                prevention: document.getElementById('inc-prevention').value
                                            };

                                            if (!form.recorder || !form.user || !form.occurDate || !form.situation) {
                                                showToast('error', 'ÂøÅE†àÈ†ÅEõÆÅEÅEÅEâ„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                                                return;
                                            }

                                            const btn = document.getElementById('inc-submit-btn');
                                            const btnText = document.getElementById('btn-save-simple-inc-text');
                                            // const btnLoader = document.getElementById('btn-save-simple-inc-loader'); // Removed

                                            const originalText = btnText.textContent;
                                            // [Refactor] Use setButtonLoading
                                            setButtonLoading(btn, true);
                                            btnText.textContent = '‰øùÂ≠ò‰∏≠';

                                            google.script.run
                                                .withSuccessHandler(res => {
                                                    setButtonLoading(btn, false);
                                                    btnText.textContent = originalText;
                                                    closeIncidentModal();
                                                    showToast('success', res);
                                                    document.getElementById('incident-form').reset();
                                                })
                                                .withFailureHandler(err => {
                                                    setButtonLoading(btn, false);
                                                    btnText.textContent = originalText;
                                                    handleError(err);
                                                })
                                                .addIncidentByOffice(APP_STATE.whoami.officeSelected, form, APP_STATE.whoami);
                                        }
        // [v33 Fix] Text Detail Modal Helper
        function showTextDetail(content) {
                                            toggleBodyScroll(true);
                                            document.getElementById('text-detail-content').textContent = content;
                                            document.getElementById('text-detail-modal').classList.remove('hidden');
                                        }
        function closeTextDetailModal() {
                                            toggleBodyScroll(false);
                                            document.getElementById('text-detail-modal').classList.add('hidden');
                                        }

        function closePhraseEditModal() {
                                            // Á∑®ÈõÅEÉ¢„Éº„ÉÄ„É´„ÅØ„Éï„É¨„Éº„Ç∫ÁÆ°ÁêÅEÉ¢„Éº„ÉÄ„É´„ÅÆ‰∏ä„Å´Âá∫„Çã„Åì„Å®„ÇÇ„ÅÇ„Çã„Åå„ÄÅ„Å®„Çä„ÅÇ„Åà„ÅöÂçò‰Ωì„ÅßÈñâ„Åò„Åü„Å®„Åç„ÅE„Çπ„ÇØ„É≠„Éº„É´Ëß£Èô§„Åõ„Åö„ÄÅË¶™Ê¨°Á¨¨...
                                            // „Å®ÊÄù„ÅÑ„Åç„ÇÑ„ÄÅË¶™„ÅåÈñã„ÅÅEÅ¶„ÅÅEÇå„Å∞„Åù„Å°„Çâ„Åßbody„Çπ„ÇØ„É≠„Éº„É´„ÅØÂà∂Âæ°„Åï„Çå„Å¶„ÅÅEÇã„Åπ„Åç„ÄÅE            // „Åó„Åã„ÅóÁèæÁä∂„ÅÆÂÆüË£ÅEÅß„ÅØ„ÄÅË¶™„ÅåÈñã„ÅÅEÅü„Åæ„ÅæÁ∑®ÈõÅEÉ¢„Éº„ÉÄ„É´„ÅåÈñã„Åè„ÄÅE            // Á∑®ÈõÅEÉ¢„Éº„ÉÄ„É´„ÅåÈñâ„Åò„Å¶„ÇÇË¶™„ÅØÈñã„ÅÑ„Åü„Åæ„Åæ„Å™„ÅÆ„Åß„ÄÅ„Åì„Åì„Åß toggleBodyScroll(false) „Åó„Å¶„ÅØ„ÅÅEÅë„Å™„ÅÅEèØËÉΩÊÄß„Åå„ÅÇ„Çã„ÄÅE            // ÂÆâÂÅE„ÅÆ„Åü„ÇÅ„ÄÅ„Åì„Åì„ÅE‰Ωï„ÇÇ„Åó„Å™„ÅÅEÅß„Åä„ÅèÅEàË¶™„ÅåÈñâ„Åò„ÇãÊôÇ„Å´Ëß£Èô§„Åï„Çå„ÇãÔºâ„ÄÅE            // „Åü„Å†„Åó„ÄÅÁ∑®ÈõÅEÉ¢„Éº„ÉÄ„É´„Å†„ÅëÈñã„Åè„Ç±„Éº„Çπ„Åå„Å™„ÅÅEÅ™„Çâ„Åì„Çå„Åß„Çà„ÅÑ„ÄÅE
                                            // ...„ÅÅEÇÑ„ÄÅÁ∑®ÈõÅEÉ¢„Éº„ÉÄ„É´„ÅØÂçòÁã¨„Åß„ÅØ„Å™„ÅèË¶™„É¢„Éº„ÉÄ„É´„Åã„ÇâÂëº„Å∞„Çå„Çã„ÄÅE            // „Åó„Åã„Åó„ÄÅbody„ÅÆ„Çπ„ÇØ„É≠„Éº„É´„É≠„ÉÅEÇØ„ÅØ„Äå‰Ωï„Åã„ÅåÈñã„ÅÅEÅ¶„ÅÅEÇãÈôê„ÇäON„Äç„Åß„ÅÇ„Çã„Åπ„Åç„ÄÅE            // ÂçòÁ¥î„Å™„Éà„Ç∞„É´„Å†„Å®„Éê„ÉÉ„ÉÅEÇ£„É≥„Ç∞„Åô„Çã„ÄÅE            // Á∞°ÊòìÁöÑ„Å™„Ç´„Ç¶„É≥„Çø„Å´„Åô„Çã„Åã„ÄÅ„ÇÇ„Åó„Åè„ÅØ„ÄåÁ∑®ÈõÅEÉ¢„Éº„ÉÄ„É´„ÅØËÉåÊôØ„Çπ„ÇØ„É≠„Éº„É´„ÇíÊ∞ó„Å´„Åó„Å™„ÅÅEºàË¶™„Åå„É≠„ÉÅEÇØ„Åó„Å¶„Çã„Åã„ÇâÔºâ„Äç„Å®„Åô„Çã„ÄÅE            document.getElementById('phrase-edit-modal').classList.add('hidden');
                                        }

        // --- Phase 3.2 Manager Logic ---

        // Ë™çË®ºÁä∂ÊÖã„ÅEÁÆ°ÁêÅE        let AUTH_STATE = {
            isAuthenticated: false,
                                        role: null,
                                        pin: null // ÊâøË™çÂÆüË°åÊôÇ„Å´ÂÜçÈÄÅ‰ø°„Åô„Çã„Åü„ÇÅ‰∏ÄÊôÇ‰øùÊåÅÅEà„Çª„Ç≠„É•„É™„ÉÅEÇ£„É™„Çπ„ÇØÂèóÂÆπÅEÅE        };

        function openPinModal(targetAction) {
                                            // Already handled in unified ByOffice flow
                                            if (targetAction === 'manager') {
                                                openIncidentSection('approval');
                                            }
                                        }

        // Legacy Manager/PIN logic removed. 
        // Flow is now integrated into Incident Wizard (ByOffice).


        // Mobile Menu
        function toggleMobileMenu() {
                                            const menu = document.getElementById('mobile-menu');
                                            const overlay = document.getElementById('mobile-menu-overlay');
                                            if (!menu || !overlay) return;
                                            const isHidden = menu.classList.contains('-translate-x-full');
                                            if (isHidden) {
                                                menu.classList.remove('-translate-x-full');
                                                overlay.classList.remove('hidden');
                                                setTimeout(() => overlay.classList.remove('opacity-0'), 10);
                                            } else {
                                                menu.classList.add('-translate-x-full');
                                                overlay.classList.add('opacity-0');
                                                setTimeout(() => overlay.classList.add('hidden'), 300);
                                            }
                                        }

        // ‚ñº‚ñº‚ñº „É°„Éã„É•„ÉºÂ§ñ„Çø„ÉÅEÅE„ÅßÈñâ„Åò„ÇãÂÅEÁêÅE‚ñº‚ñº‚ñº
        document.addEventListener('click', function (event) {
                                            const menu = document.getElementById('mobile-menu');
                                            // Select button by action attribute or specific container class if no ID
                                            const btn = document.querySelector('button[onclick="toggleMobileMenu()"]');

                                            // Ë¶ÅÁ¥†„ÅåÂ≠òÂú®„Åó„Å™„ÅÅE†¥Âêà„ÅE„Çπ„Ç≠„ÉÅEÅE„Åô„Çã„Ç¨„Éº„ÉâÁØÄ„ÇíËøΩÂä†
                                            if (menu && btn) {
                                                // „É°„Éã„É•„Éº„ÅåÈñã„ÅÅEÅ¶„ÅÅEÅ¶„ÄÅ„Åã„Å§„É°„Éã„É•„ÉºÂ§ñÔºÅEÅE„Çø„É≥Â§ñ„Çí„ÇØ„É™„ÉÅEÇØ„Åó„ÅüÂ†¥ÂêÅE                if (!menu.classList.contains('hidden') &&
                                                !menu.contains(event.target) &&
                                                    !btn.contains(event.target)) {
                                        menu.classList.add('hidden');
                                    }
            }
        });

                        // Â±•Ê≠¥Ë°®Á§∫Áî®Èñ¢Êï∞ („É¢„Éê„Ç§„É´„É°„Éã„É•„Éº„Åã„ÇâÂëº„Å∞„Çå„Çã)
                        function openIncidentViewer() {
                            toggleMobileMenu();
                            openIncidentSection('history');
                        }


                        // Staff Management
                        function openStaffModal() {
                            toggleBodyScroll(true);
                            document.getElementById('staff-modal').classList.remove('hidden');
                            renderStaffList();
                        }
                        function closeStaffModal() {
                            toggleBodyScroll(false);
                            document.getElementById('staff-modal').classList.add('hidden');
                        }
                        function renderStaffList() {
                            const c = document.getElementById('staff-list-body');
                            c.innerHTML = '<tr><td colspan="4" class="text-center py-4">Ë™≠„ÅøËæº„Åø‰∏≠...</td></tr>';
                            const w = getWhoami();
                            if (!w) return;
                            google.script.run.withSuccessHandler(list => {
                                c.innerHTML = '';
                                list.forEach(s => {
                                    const tr = document.createElement('tr');
                                    tr.innerHTML = `
                < td class="p-2 border" > ${s.name}</td >
                        <td class="p-2 border"><span class="blur-sm hover:blur-none cursor-pointer transition">${s.pin}</span></td>
                        <td class="p-2 border">${s.role === 'manager' ? 'ÁÆ°ÁêÅEÄÅE : '‰∏ÄËà¨'}</td>
                                        < td class="p-2 border text-center" >
                                            <button onclick="deleteStaff('${s.name}')" class="text-red-600 text-xs font-bold border border-red-200 bg-red-50 px-2 py-1 rounded">ÂâäÈô§</button>
                        </td >
                                        `;
                    tr.querySelector('td:first-child').onclick = () => populateStaffForm(s);
                    c.appendChild(tr);
                });
            }).getStaffList(w.name, w.pin);
        }
        function populateStaffForm(staff) {
            document.getElementById('staff-name').value = staff.name;
            document.getElementById('staff-pin').value = staff.pin;
            document.getElementById('staff-role').value = staff.role;
            document.getElementById('staff-office').value = staff.office;
        }
        function saveStaff() {
            const data = {
                name: document.getElementById('staff-name').value,
                pin: document.getElementById('staff-pin').value,
                role: document.getElementById('staff-role').value,
                office: document.getElementById('staff-office').value
            };
            if (!data.name || !data.pin) return showToast('error', 'ÂêçÂâç„Å®PIN„ÅØÂøÅE†à„Åß„ÅÅE);

            const w = getWhoami();
            if (!w) return;
            google.script.run.withSuccessHandler(res => {
                showToast('success', res);
                document.getElementById('staff-form').reset();
                renderStaffList();
            }).upsertStaff(w.name, w.pin, data);
        }
        function deleteStaff(name) {
            if (!confirm(name + ' „Åï„Çì„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÅEÅE)) return;
            const w = getWhoami();
            if (!w) return;
            google.script.run.withSuccessHandler(res => {
                showToast('success', res);
                renderStaffList();
            }).deleteStaff(w.name, w.pin, name);
        }



        // -----------------------------------------------------------
        // Ë™çË®º„Éª„É¶„Éº„Ç∂„ÉºÁä∂ÊÖÅE        // -----------------------------------------------------------
        function getWhoami() {
            if (APP_STATE.whoami) {
                if (APP_STATE.whoami.expiresAt && Date.now() > APP_STATE.whoami.expiresAt) {
                    clearWhoami(); return null;
                }
                return APP_STATE.whoami;
            }
            return null;
        }

        function clearWhoami() {
            APP_STATE.whoami = null;
            APP_STATE.isInitialized = false; // ÂàùÊúüÂåñ„Éï„É©„Ç∞„Çí„É™„Çª„ÉÅEÉà
            sessionStorage.removeItem('gas_whoami');
            renderWhoamiBadge();

            // Âç≥Â∫ß„Å´FAB„ÇíÈö†„ÅÅE            showFab(false);

            // [v40] PDF„Éó„É¨„Éì„É•„Éº„Å®„Çª„ÉÅEÇ∑„Éß„É≥„ÉÅEÅE„Çø„ÅÆÂÆåÂÅE„É™„Çª„ÉÅEÉà
            resetOutputView();
            APP_STATE.allRecords = {};
            APP_STATE.users = [];
            APP_STATE.phrases = [];
            APP_STATE.staffs = [];
            APP_STATE.selectedUsers = [];
            APP_STATE.currentUserName = null;

            location.hash = '#signin';
            if (location.hash === '#signin') window.dispatchEvent(new Event('hashchange'));

            // „Çµ„Ç§„É≥„Ç§„É≥ÁîªÈù¢„ÅÆ„ÉÅEÅE„Çø„ÇíÂÅEÂèñÂæóÔºàÂÅE„Çµ„Ç§„É≥„Ç§„É≥ÊôÇ„ÅEÂ§±ÊïóÂØæÁ≠ñÔºÅE            // „Çµ„Ç§„É≥„Ç§„É≥ÁîªÈù¢„ÅÆ„ÉÅEÅE„Çø„ÇíÂÅEÂèñÂæóÔºàÂÅE„Çµ„Ç§„É≥„Ç§„É≥ÊôÇ„ÅEÂ§±ÊïóÂØæÁ≠ñÔºÅE            loadOfficeList();
            setupSigninListeners(); // [Fix] Ensure listeners are active

            // [v37+] Reset signin screen state
            setTimeout(() => {
                const officeSel = document.getElementById('signinOffice');
                if (officeSel) officeSel.value = '';

                const staffSel = document.getElementById('staffSelect');
                if (staffSel) {
                    staffSel.innerHTML = '<option value="">‰∫ãÊ•≠ÊâÄ„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ</option>';
                    staffSel.value = '';
                    staffSel.disabled = true;
                }

                const pinInput = document.getElementById('pinInput');
                if (pinInput) pinInput.value = '';

                const err = document.getElementById('signin-error');
                if (err) err.classList.add('hidden');

                const btn = document.getElementById('btnSigninGo');
                if (btn) {
                    btn.disabled = false;
                    btn.innerHTML = '<span>„Çµ„Ç§„É≥„Ç§„É≥</span> <i class="fas fa-arrow-right"></i>';
                }

                const staffName = document.getElementById('success-staff-name');
                if (staffName) staffName.textContent = '';

                const successModal = document.getElementById('success-modal');
                if (successModal) {
                    successModal.classList.add('hidden', 'opacity-0');
                    const progress = document.getElementById('loading-bar');
                    if (progress) progress.style.width = '0%';
                }
            }, 100);
        }

        // [v36 Feature] User Switch Modal Logic
        function openUserSwitchModal() {
            const modal = document.getElementById('user-switch-modal');
            const select = document.getElementById('switch-staff-select');
            const pin = document.getElementById('switch-pin-input');

            select.innerHTML = '<option value="" disabled selected>ÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ</option>';
            const w = getWhoami();
            if (APP_STATE.staffs && APP_STATE.staffs.length > 0) {
                // [v37+] Exclude current user and filter empty
                const validStaffs = APP_STATE.staffs.filter(s => s && /[^\s\u3000]/.test(String(s)));
                const uniqueStaffs = [...new Set(validStaffs)];

                uniqueStaffs.filter(s => !w || s !== w.name).forEach(s => select.add(new Option(s, s)));
            } else if (w) {
                // Fallback: if no staffs list, show current user (though they can't switch to themselves)
                select.add(new Option(w.name, w.name));
            }

            pin.value = '';
            modal.classList.remove('hidden');
            const drop = document.getElementById('userDropdown');
            if (drop) drop.classList.add('hidden');

            // [v37 Feature] Enter key support
            pin.focus();
            pin.onkeydown = (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    submitUserSwitch();
                }
            };
        }

        function closeUserSwitchModal() {
            document.getElementById('user-switch-modal').classList.add('hidden');
        }

        function submitUserSwitch() {
            const w = getWhoami();
            const staffName = document.getElementById('switch-staff-select').value;
            const pin = document.getElementById('switch-pin-input').value;

            if (!staffName) return showToast('error', 'ËÅ∑Âì°„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
            if (!pin || pin.length < 4) return showToast('error', 'PIN„Ç≥„Éº„Éâ„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');

            const office = w ? w.officeSelected : document.getElementById('signinOffice').value; // „Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ
            if (!office) return showToast('error', '‰∫ãÊ•≠ÊâÄÊÉÅE†±„Åå‰∏çÊÅE„Åß„Åô„ÄÇÂÅE„É≠„Ç∞„Ç§„É≥„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÅE);

            // [Refactor] Button loading state
            const submitBtn = document.querySelector('#user-switch-modal button[onclick="submitUserSwitch()"]');
            setButtonLoading(submitBtn, true);

            // showLoading(); // Overlay replaced by button spinner

            google.script.run.withSuccessHandler(auth => {
                // hideLoading();
                setButtonLoading(submitBtn, false);

                if (auth && auth.success) {
                    APP_STATE.whoami = auth;
                    sessionStorage.setItem('gas_whoami', JSON.stringify(auth));
                    showToast('success', auth.name + ' „Å´ÂàÅEÇäÊõø„Åà„Åæ„Åó„Åü');
                    closeUserSwitchModal();
                    renderWhoamiBadge();
                    renderManagerCards();

                    // [v45 Fix] Reload Incident Lists on Switch
                    loadIncidentPendingList();
                    if (auth.role === 'manager') {
                        loadIncidentApprovalList();
                        document.getElementById('tabIncidentApprove').classList.remove('hidden');
                    } else {
                        // Hide Approval Section/Tab if demoted to Staff
                        document.getElementById('incidentApprovalSection').classList.add('hidden');
                        document.getElementById('tabIncidentApprove').classList.add('hidden');
                        // If we were on approval tab, switch to pending
                        if (document.getElementById('incidentApprovalSection').classList.contains('active')) { // 'active' check might differ
                            switchIncidentTab('pending');
                        } else if (!document.getElementById('incidentApprovalSection').classList.contains('hidden')) {
                            // Just to be safe if 'active' class isn't used for visibility logic alone
                            switchIncidentTab('pending');
                        }
                    }
                } else {
                    showToast('error', 'Ë™çË®º„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + (auth ? auth.message : '‰∏çÊÅE„Å™„Ç®„É©„Éº'));
                }
            }).verifyUserByPin(office, staffName, pin);
        }

        // [v35 Fix] Hash Change Listener for Navigation
        window.addEventListener('hashchange', () => {
            console.log('Hash changed:', location.hash);
            if (location.hash === '#signin') {
                const sv = document.getElementById('signinView');
                const av = document.getElementById('appView');
                if (sv && av) {
                    sv.style.removeProperty('display'); // Remove display:none !important
                    sv.classList.remove('hidden', 'opacity-0');
                    av.classList.add('hidden');
                    // Reset Inputs
                    document.getElementById('pinInput').value = '';
                    APP_STATE.pinInput = '';
                }
            }
        });

        function renderWhoamiBadge() {
            const w = getWhoami();
            const b = document.getElementById('whoamiBadge');
            const bm = document.getElementById('whoamiBadgeMobile');
            const dn = document.getElementById('dropdownUserName');
            const da = document.getElementById('dropdownAvatar');
            const headerAvatar = document.getElementById('headerAvatarInitials');

            if (!w) {
                if (dn) dn.textContent = 'Êú™„É≠„Ç∞„Ç§„É≥';
                return;
            }

            // [v37 Feature] Google-style Avatar
            // ÂêçÂâç„Åã„Çâ„ÄåÂßì„Äç„ÅEÂÖàÈ†≠ÊñÅE≠ó„ÇíÂèñÂæóÔºàÂÅEÂçäËßí„Çπ„Éö„ÅE„Çπ„ÅßÂàÅEâ≤ÅEÅE            let initial = w.name.charAt(0);
            const parts = w.name.replace('„ÄÄ', ' ').split(' ');
            if (parts.length > 0 && parts[0]) {
                initial = parts[0].charAt(0);
            }

            // Ëâ≤„ÅÆÊ±∫ÂÆÅE(ÂêçÂâç„ÅÆ„Éè„ÉÉ„Ç∑„É•Á≠â„ÅßÊ±∫„ÇÅ„Çã„ÅÆ„ÇÇËâØ„ÅÅEÅå„ÄÅ‰∏ÄÊó¶Âõ∫ÂÆö„Åß„Ç§„É≥„ÉÅEÇ£„Ç¥/„Ç®„É°„É©„É´„Éâ„ÅÇ„Åü„Çä)
            // ËÅ∑Âì°„Åî„Å®„Å´„Å™„Çì„Å®„Å™„ÅèËâ≤„ÇíÂ§â„Åà„Çã„Åü„ÇÅ„ÄÅÂêçÂâç„ÅEÈï∑„ÅïÁ≠â„ÅßÂàÅE≤ÅE            const colors = ['bg-indigo-500', 'bg-emerald-500', 'bg-blue-500', 'bg-purple-500', 'bg-pink-500', 'bg-teal-500'];
            const colorIndex = w.name.length % colors.length;
            const bgClass = colors[colorIndex];

            // „Éò„ÉÉ„ÉÄ„Éº„Ç¢„Éê„Çø„Éº„ÅÆÊõ¥Êñ∞ (UserAvatarBtn„ÅÆ‰∏≠Ë∫´)
            const fab = document.getElementById('userAvatarBtn');
            if (fab) {
                // ÁîªÂÉè„Åß„ÅØ„Å™„Åè„Ç§„Éã„Ç∑„É£„É´ÂÜÅEÇíË°®Á§∫
                fab.innerHTML = `< div class="w-8 h-8 rounded-full ${bgClass} text-white flex justify-center items-center text-sm font-bold shadow-sm" > ${ initial }</div > `;
            }

            // „Éâ„É≠„ÉÅEÅE„ÉÄ„Ç¶„É≥ÂÜÅEÅEÊõ¥Êñ∞
            if (dn) dn.textContent = w.name;
            if (da) {
                da.innerHTML = `< div class="w-10 h-10 rounded-full ${bgClass} text-white flex justify-center items-center text-lg font-bold shadow-md" > ${ initial }</div > `;
            }

            // „ÉÅEÇ≠„Çπ„Éà„Éê„ÉÅEÇ∏ÅEàÊÆã„ÅôÂ†¥ÂêàÔºÅE            const txt = `${ w.officeSelected } / ${w.name}`;
                                    if (b) b.textContent = `Ë™çË®º: ${txt}`;
                                    if (bm) bm.textContent = txt;

                                    // Ê®©Èôê„Å´„Çà„Çã„É°„Éã„É•„ÉºÂà∂Âæ° & „ÉÅEÅE„Çø„É™„É≠„Éº„ÉÅE            const approveTab = document.getElementById('tabIncidentApprove');
                                    const isManager = (w.role === 'manager');

                                    if (isManager) {
                                        approveTab?.classList.remove('hidden');
                                    } else {
                                        approveTab?.classList.add('hidden');
                                    }

                                    // [v49] Auto-reload current tab on user switch (Security & Consistency)
                                    // Checks visible section and re-triggers switchIncidentTab to reload data with new user context.
                                    if (typeof switchIncidentTab === 'function') {
                                        const pSec = document.getElementById('incidentPendingSection');
                                        const hSec = document.getElementById('incidentHistorySection');
                                        const aSec = document.getElementById('incidentApprovalSection');

                                        if (aSec && !aSec.classList.contains('hidden')) {
                                            // If on Approval tab: Reload if Manager, otherwise Fallback to Pending
                                            if (isManager) switchIncidentTab('approval');
                                            else switchIncidentTab('pending');
                                        } else if (hSec && !hSec.classList.contains('hidden')) {
                                            switchIncidentTab('history'); // Reload History
                                        } else if (pSec && !pSec.classList.contains('hidden')) {
                                            switchIncidentTab('pending'); // Reload Pending
                                        }
                                    }
                                }

        // -----------------------------------------------------------
        // ‰∫ãÊïÖÂ†±Âëä„ÅE„Éí„É§„É™„Éè„ÉÉ„ÉÅE(Incident Logic)
        // -----------------------------------------------------------
        // -----------------------------------------------------------
        // ‰∫ãÊïÖÂ†±Âëä„ÅE„Éí„É§„É™„Éè„ÉÉ„ÉÅE(Incident Logic - Rearchitected)
        // -----------------------------------------------------------
        function switchIncidentTab(tab) {
                                        ['pending', 'history', 'approval'].forEach(t => {
                                            const btn = document.getElementById('tabIncident' + (t.charAt(0).toUpperCase() + t.slice(1)));
                                            if (btn) {
                                                const isActive = t === tab;
                                                btn.classList.toggle('border-indigo-600', isActive);
                                                btn.classList.toggle('text-indigo-600', isActive);
                                                btn.classList.toggle('bg-white', isActive);
                                                btn.classList.toggle('border-transparent', !isActive);
                                                btn.classList.toggle('text-gray-500', !isActive);
                                                btn.classList.toggle('bg-transparent', !isActive);
                                            }
                                        });

                                        document.getElementById('incidentPendingSection')?.classList.toggle('hidden', tab !== 'pending');
                                        document.getElementById('incidentHistorySection')?.classList.toggle('hidden', tab !== 'history');
                                        document.getElementById('incidentApprovalSection')?.classList.toggle('hidden', tab !== 'approval');

                                        if (tab === 'pending') loadIncidentPendingList();
                                        if (tab === 'history') loadIncidentHistory();
                                        if (tab === 'approval') loadIncidentApprovalList();
                                    }

        // Helper to get form data
        function getIncidentFormData() {
                                        return {
                                            recorder: document.getElementById('inc-simple-recorder').value,
                                            user: document.getElementById('inc-simple-user').value,
                                            occurDate: document.getElementById('inc-simple-occur').value,
                                            type: document.getElementById('inc-simple-type').value,
                                            place: document.getElementById('inc-simple-place').value,
                                            situation: document.getElementById('inc-simple-situation').value,
                                            cause: document.getElementById('inc-simple-cause').value,
                                            response: document.getElementById('inc-simple-response').value,
                                            prevention: document.getElementById('inc-simple-prevention').value,
                                            status: 'Êú™ÊâøË™ÅE
                                        };
                                    }

        // Change Detection Logic
        function checkIncidentChange() {
                                        const btn = document.getElementById('btn-save-simple-inc');
                                        const btnText = document.getElementById('btn-save-simple-inc-text');
                                        if (!btn) return;

                                        if (APP_STATE.pendingEditRowId) {
                                            // Edit Mode: Compare with snapshot
                                            const current = JSON.stringify(getIncidentFormData());
                                            const isChanged = (current !== APP_STATE.incidentSnapshot);

                                            if (!isChanged) {
                                                btn.disabled = true;
                                                btn.classList.add('opacity-50', 'cursor-not-allowed');
                                                if (btnText) btnText.textContent = 'Â§âÊõ¥„Å™„ÅÅE;
                                            } else {
                                                btn.disabled = false;
                                                btn.classList.remove('opacity-50', 'cursor-not-allowed');
                                                if (btnText) btnText.textContent = 'Â§âÊõ¥„Çí‰øùÂ≠ÅE;
                                            }
                                        } else {
                                            // New Mode: Always enabled (validation on click)
                                            btn.disabled = false;
                                            btn.classList.remove('opacity-50', 'cursor-not-allowed');
                                            if (btnText) btnText.textContent = 'Â†±Âëä„Çí‰øùÂ≠ÅE;
                                        }
                                    }

        function attachIncidentChangeListeners() {
                                        const ids = ['inc-simple-recorder', 'inc-simple-user', 'inc-simple-occur', 'inc-simple-type', 'inc-simple-place', 'inc-simple-situation', 'inc-simple-cause', 'inc-simple-response', 'inc-simple-prevention'];
                                        ids.forEach(id => {
                                            const el = document.getElementById(id);
                                            if (el) {
                                                el.oninput = checkIncidentChange;
                                                el.onchange = checkIncidentChange;
                                            }
                                        });
                                    }

        async function saveIncident() {
                                        const w = getWhoami();
                                        if (!w) return;

                                        // HTMLÂÜÅEÅEÂêÅEID „Åã„ÇâÁõ¥Êé•ÂÄ§„ÇíÂèñÂæó„Åó„Åæ„ÅÅE            const data = getIncidentFormData();

                                        // „Éê„É™„ÉÅEÅE„Ç∑„Éß„É≥ÅEàÂÅEÂäõ„ÉÅ„Çß„ÉÅEÇØÅEÅE            if (!data.user) return showToast('error', 'ÂØæË±°Âà©Áî®ËÄÅEÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                                        if (!data.situation) return showToast('error', 'Áä∂Ê≥Å„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');

                                        // UI Loading Control
                                        // UI Loading Control
                                        const btn = document.getElementById('btn-save-simple-inc');
                                        const btnText = document.getElementById('btn-save-simple-inc-text');
                                        // const btnLoader = document.getElementById('btn-save-simple-inc-loader');

                                        // [Refactor] Use setButtonLoading
                                        setButtonLoading(btn, true);
                                        if (btnText) btnText.textContent = '‰øùÂ≠ò‰∏≠...';

                                        // ÊàêÂäüÊôÇ„ÅE„Ç≥„Éº„É´„Éê„ÉÉ„ÇØÅEàÂÅEÈÄöÔºÅE            const onSuccess = (res) => {
                                        setButtonLoading(btn, false);
                                        if (btnText) btnText.textContent = 'Â†±Âëä„Çí‰øùÂ≠ÅE;
                                        onIncidentSaved(res);
                                    };

                                // Â§±ÊïóÊôÇ„ÅÆ„Ç≥„Éº„É´„Éê„ÉÉ„ÇØÅEàÂÅEÈÄöÔºÅE            const onFailure = (err) => {
                                setButtonLoading(btn, false);
                                if (btnText) btnText.textContent = 'Â†±Âëä„Çí‰øùÂ≠ÅE;
                                handleError(err);
                            };

                            // Á∑®ÈõÅEÅãÊñ∞Ë¶è„Åã„ÇíÂà§ÂÆö„Åó„Å¶„Çµ„Éº„Éê„ÅE„Å∏ÈÄÅ‰ø°
                            if (APP_STATE.pendingEditRowId) {
                                // Êó¢Â≠ò„Éá„Éº„Çø„ÅÆÊõ¥Êñ∞
                                google.script.run
                                    .withSuccessHandler(onSuccess)
                                    .withFailureHandler(onFailure)
                                    .updateIncidentByOffice(w.officeSelected, APP_STATE.pendingEditRowId, data, w);
                            } else {
                                // Êñ∞Ë¶è„Éá„Éº„Çø„ÅÆËøΩÂä†
                                google.script.run
                                    .withSuccessHandler(onSuccess)
                                    .withFailureHandler(onFailure)
                                    .addIncidentByOffice(w.officeSelected, data, w);
                            }
                        }

                        function onIncidentSaved(res) {
                            hideLoading();
                            showToast('success', '‰øùÂ≠ò„Åó„Åæ„Åó„Åü');

                            // Á∑®ÈõÅEÉ¢„Éº„Éâ„Å†„Å£„ÅüÂ†¥Âêà„ÄÅË©≥Á¥∞ÁîªÈù¢„Çí„É™„Éï„É¨„ÉÅEÇ∑„É•„Åó„Å¶ÂÜçË°®Á§∫
                            if (APP_STATE.pendingEditRowId) {
                                // ËøîÂç¥„Åï„Çå„ÅüÊúÄÊñ∞„ÉÅEÅE„Çø(res)„Çí‰Ωø„Å£„Å¶Ë©≥Á¥∞„ÇíÊèèÁîªÅEà„Çµ„Éº„Éê„ÅEÂÜçÂèñÂæó‰∏çË¶ÅEºÅE                const detailPanel = document.getElementById('incidentDetailPanel');
                                if (detailPanel) {
                                    detailPanel.classList.remove('hidden');
                                    // res„Åå„Ç™„Éñ„Ç∏„Çß„ÇØ„Éà„Å™„Çâ„Åù„ÅÆ„Åæ„ÅæË°®Á§∫„ÄÅ„Å™„Åë„Çå„Å∞ID„ÅßÂÜçÂèñÂæÅE                    if (res && typeof res === 'object' && !res.error) {
                                    viewIncidentDetail(res);
                                } else {
                                    viewIncidentDetail(APP_STATE.pendingEditRowId);
                                }
                            }
                            // [Fix] „É™„Çπ„Éà„ÇíÊõ¥Êñ∞ÅEàÁ∑®ÈõÅEæå„ÄÅÂØæÂøúÂæÅEÅ°„Å™„Å©„ÅåÂè§„ÅÅEÅü„ÇÅEºÅE                if (!document.getElementById('incidentPendingSection').classList.contains('hidden')) loadIncidentPendingList();
                            if (!document.getElementById('incidentApprovalSection').classList.contains('hidden')) loadIncidentApprovalList();
                            if (!document.getElementById('incidentHistorySection').classList.contains('hidden')) loadIncidentHistory();

                            // Á∑®ÈõÅEä∂ÊÖã„ÇØ„É™„Ç¢
                            APP_STATE.pendingEditRowId = null;
                            // Á∑®ÈõÅEÉ¢„Éº„ÉÄ„É´„ÇíÈñâ„Åò„Çã
                            closeIncidentSimpleModal();
                        } else {
                            // Êñ∞Ë¶è‰ΩúÊÅE„ÅÆÂ†¥ÂêÅE                closeIncidentSimpleModal();
                            switchView('incident');
                            switchIncidentTab('pending');
                        }
                    }

                    function loadIncidentPendingList() {
                        const w = getWhoami();
                        if (!w) return;

                        const container = document.getElementById('incidentPendingCards');
                        if (container) container.innerHTML = `<div class="flex justify-center items-center py-10 w-full">${getLoaderHtml()}</div>`;

                        console.log('[Debug] loadIncidentPendingList started for:', w.name, 'Office:', w.officeSelected);

                        google.script.run.withSuccessHandler(response => {
                            // „Çµ„Éº„Éê„ÅE„Åã„Çâ„ÅÆ„É¨„Çπ„Éù„É≥„ÇπÊßãÈÄ†„Çí„ÉÅ„Çß„ÉÅEÇØ
                            console.log('[Debug] Full Response from server:', response);

                            // Êñ∞„Åó„ÅÑÂΩ¢ÂºÅE{ data: [...] } „Åã„ÄÅÂè§„ÅÅEΩ¢ÂºÅE[ ... ] „Åã„ÇíÊüîËªü„Å´Âèó„ÅëÂèñ„Çã
                            const data = (response && response.data) ? response.data : (Array.isArray(response) ? response : []);
                            const debug = (response && response.debug) ? response.debug : null;

                            console.log('[Debug] Data Extracted:', data.length, 'items');
                            if (debug) console.log('[Debug] Server Debug Info:', debug);

                            container.innerHTML = '';

                            // ÂêçÂâçÊØîËºÅEî®„ÅÆÊ≠£Ë¶èÂåñÈñ¢Êï∞ (ÂÖ®ËßíÂçäËßí„Çπ„Éö„ÅE„ÇπÈô§Âéª, Â∞èÊñáÂ≠óÂåñ)
                            const norm = s => (s || '').toString().replace(/[\s\u3000]+/g, '').toLowerCase();
                            const userNameNorm = norm(w.name);
                            console.log('[Debug] Normalized Login User:', userNameNorm);

                            // Ëá™ÂàÅEÅEÊú™ÊâøË™ÅEor Â∑ÆÊàª„Åó„ÅE„ÅøÊäΩÂá∫
                            const pending = (data || []).filter((i, idx) => {
                                // [v47] Filter Logic
                                // Manager: Shows ALL 'Returned' incidents (to track all corrections).
                                // Staff: Shows OWN 'Unapproved' + 'Returned' incidents.
                                const isManager = (w.role === 'manager');

                                if (isManager) {
                                    return (i.status === 'Â∑ÆÊàª„ÅÅE || i.status === 'Â∑ÆÊàª');
                                } else {
                                    // Staff Logic
                                    const rNorm = norm(i.recorder);
                                    const recorderMatch = (rNorm === userNameNorm);
                                    return recorderMatch && (i.status === 'Êú™ÊâøË™ÅE || i.status === 'Â∑ÆÊàª„ÅÅE || i.status === 'Â∑ÆÊàª');
                        }
                });

                    console.log('[Debug] Final Filtered Pending List size:', pending.length);

                    if (pending.length === 0) {
                        container.innerHTML = '<div class="text-center py-20 text-gray-400 bg-gray-50 rounded-xl border-2 border-dashed border-gray-100">ÂØæÂøúÂæÅEÅ°„ÅÆÂ†±ÂëäÊõ∏„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì</div>';
                        return;
                    }

                    pending.forEach(item => {
                        const card = document.createElement('div');
                        card.className = 'incident-card flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 hover:border-indigo-300 cursor-pointer transition';

                        // Debug: Log rowId check
                        if (!item.rowId) console.warn('[Debug] Missing rowId for item:', item);

                        card.onclick = () => {
                            console.log('[Debug] Card Clicked! Passing full item object');
                            // [Fix] Yield to main thread and pass full object
                            setTimeout(() => viewIncidentDetail(item), 0);
                        };

                        const isReturned = (item.status === 'Â∑ÆÊàª„ÅÅE || item.status === 'Â∑ÆÊàª');
                        const targetUser = item.user || item.userName || '(ÂØæË±°ËÄÅE∏çÊÅE)';

                        // Unified Card Layout
                        card.innerHTML = `
                        <div class="flex-1 min-w-0">
                            <!-- Row 1: Status | Date -->
                            <div class="flex items-center gap-2 mb-1">
                                <span class="status-badge ${isReturned ? 'status-returned' : 'status-pending'}">${item.status}</span>
                                <span class="text-[10px] font-bold text-gray-400">${(item.occurDate || '').toString().replace('T', ' ')}</span>
                            </div>
                            <!-- Row 2: Target | Category -->
                            <div class="text-sm font-bold text-gray-800 truncate mb-1">${targetUser} / ${item.type}</div>
                            <!-- Row 3: Recorder -->
                            <div class="text-xs text-gray-500 font-bold mb-1">Ë®òÈå≤ËÄÅE ${item.recorder || '(‰∏çÊÅE)'}</div>
                            <!-- Row 4: Content (Situation) -->
                            <p class="text-xs text-gray-500 line-clamp-2 bg-gray-50 p-2 rounded">${item.situation || ''}</p>
                            ${isReturned ? (item.returnReason ? `
                                <div class="mt-2 p-2 bg-red-50 border border-red-200 rounded text-xs text-red-700">
                                    <div class="flex items-start gap-1">
                                        <i class="fas fa-exclamation-circle mt-0.5 shrink-0"></i>
                                        <div class="flex-1 font-bold break-words">
                                            Â∑ÆÊàª„ÅóÁêÜÁî±: ${item.returnReason}
                                        </div>
                                    </div>
                                    ${item.returnedAt ? `<div class="text-right text-red-400 text-[10px] mt-1 font-normal">${item.returnedAt}</div>` : ''}
                                </div>
                            ` : `<p class="text-[10px] text-red-500 font-bold mt-1 bg-red-50 p-1 rounded"><i class="fas fa-comment-dots mr-1"></i>Â∑ÆÊàª„ÅóÁêÜÁî±: ‰øÆÊ≠£„ÅåÂøÅE¶Å„Åß„ÅÅE/p>`) : ''}
                        </div>
                        <div class="flex gap-2 shrink-0 ml-2">
                             <i class="fas fa-chevron-right text-gray-300"></i>
                        </div>
                    `;
                        container.appendChild(card);
                    });
                }).getIncidentsByOfficeV2(w.officeSelected);
            }

            async function editIncident(itemOrRowId) {
                const w = getWhoami();
                if (!w) return;

                // [Fix] Shared logic for processing the item to edit
                const proceedWithItem = (item) => {
                    if (!item) return showToast('„ÉÅEÅE„Çø„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì', 'error');

                    // Ëá™ÂàÅEÅEË®òÈå≤„ÅãÂà§ÂÆöÔºàÊ≠£Ë¶èÂåñ„Åó„Å¶ÊØîËºÅEºÅE                const norm = s => (s || '').toString().replace(/[\s\u3000]+/g, '').toLowerCase();
                    const isMyRecord = norm(item.recorder) === norm(w.name);
                    const rowId = item.rowId;

                    // „Ç∑„É≥„Éó„É´„Éï„Ç©„Éº„É†„Å´ÂÄ§„Çí„Çª„ÉÅEÉà„Åó„Å¶Èñã„ÅèÂá¶ÁêÅE                const proceedToEdit = () => {
                    // Ë©≥Á¥∞„Éë„Éç„É´„ÅåÈñã„ÅÅEÅ¶„ÅÅEÇå„Å∞Èö†„ÅôÔºàÈáç„Å™„ÇäÈò≤Ê≠¢ÅEÅE                    document.getElementById('incidentDetailPanel').classList.add('hidden');

                    // „Ç∑„É≥„Éó„É´„Éï„Ç©„Éº„É†„ÇíÈñã„ÅÅE(openIncidentSimpleModal„ÅÆÂÜÅEÆπ„Çí„ÅE„Éº„Çπ„Å´)
                    openIncidentSimpleModal();

                    // Á∑®ÈõÅEØæË±°„ÅÆË°åID„Çí‰øùÊåÅ
                    APP_STATE.pendingEditRowId = rowId;

                    // „Ç∑„É≥„Éó„É´„Éï„Ç©„Éº„É†ÂÜÅEÅEÂêÅE¶ÅÁ¥†„Å´ÂÄ§„Çí„Çª„ÉÅEÉà (ID„ÅØÈñ¢Êï∞ÂÜÅEÅEÂÆöÁæ©„Å´Âêà„Çè„Åõ„Çã)
                    document.getElementById('inc-simple-recorder').value = item.recorder || '';
                    document.getElementById('inc-simple-user').value = item.userName || item.user || '';

                    // Êó•ÊôÇ„ÅEÂ§âÊèõ (YYYY/MM/DD HH:mm -> YYYY-MM-DDTHH:mm)
                    if (item.occurDate) {
                        const datePart = item.occurDate.replace(/\//g, '-').replace(' ', 'T');
                        document.getElementById('inc-simple-occur').value = datePart;
                    }

                    document.getElementById('inc-simple-type').value = item.type || '';
                    document.getElementById('inc-simple-place').value = item.place || '';
                    document.getElementById('inc-simple-situation').value = item.situation || '';
                    document.getElementById('inc-simple-cause').value = item.cause || '';
                    document.getElementById('inc-simple-response').value = item.response || '';
                    document.getElementById('inc-simple-prevention').value = item.prevention || '';

                    // „Çπ„Éä„ÉÉ„Éó„Ç∑„Éß„ÉÅEÉàÊõ¥Êñ∞
                    APP_STATE.incidentSnapshot = JSON.stringify(getIncidentFormData());
                    checkIncidentChange();
                };

                // [v50] Skip PIN for Manager edit (User request: Edit button shouldn't prompt PIN like Approval)
                // Manager role is already verified by login.
                if (isMyRecord || w.role === 'manager') {
                    // Ëá™ÂàÅEÅEË®òÈå≤„ÄÅ„Åæ„Åü„ÅEÁÆ°ÁêÅEÄÅEÅ™„ÇâÂç≥Á∑®ÈõÅE                    proceedToEdit();
                } else {
                    // ‰∏ÄËà¨ËÅ∑Âì°„Åå‰ªñ‰∫∫„ÅÆË®òÈå≤„ÇíÁ∑®ÈõÅEÅó„Çà„ÅÜ„Å®„Åó„ÅüÂ†¥ÂêàÔºàÂü∫Êú¨„ÅÇ„Çä„Åà„Å™„ÅÅEÅåÂøµ„ÅÆ„Åü„ÇÅÅEÅE                    authenticateAction(() => {
                    showToast('ÁÆ°ÁêÅEÄÅE™çË®ºÊàêÂäü', 'success');
                    proceedToEdit();
                });
            }
            };

            // [Fix] Check if object passed directly
            if (typeof itemOrRowId === 'object' && itemOrRowId !== null) {
                console.log('[Debug] editIncident using passed object');
                // No loading needed
                proceedWithItem(itemOrRowId);
            } else {
                // Fetch from server (Old behavior)
                console.log('[Debug] editIncident fetching by ID:', itemOrRowId);
                showLoading();
                google.script.run.withSuccessHandler(response => {
                    hideLoading();
                    const data = (response && response.data) ? response.data : (Array.isArray(response) ? response : []);
                    const item = data.find(i => String(i.rowId) === String(itemOrRowId));
                    proceedWithItem(item);
                }).getIncidentsByOfficeV2(w.officeSelected);
            }
        }

            function closeConfirm() {
                document.getElementById('confirm-modal').classList.add('hidden');
            }

            // Helper for custom confirmation
            function showConfirmDialog(title, message, onOk, manualClose = false) {
                document.getElementById('confirm-title').textContent = title;
                document.getElementById('confirm-message').textContent = message;

                const okBtn = document.getElementById('confirm-ok-btn');
                // Remove old listeners by cloning
                const newBtn = okBtn.cloneNode(true);
                okBtn.parentNode.replaceChild(newBtn, okBtn);

                // Reset button state (Critical fix for "stuck" processing buttons)
                newBtn.disabled = false;
                // [Fix] Wrap text in span for setButtonLoading compatibility
                newBtn.innerHTML = '<span>OK</span>';
                newBtn.className = "px-6 py-2 bg-indigo-600 text-white font-bold rounded-lg hover:bg-indigo-700 transition";

                newBtn.addEventListener('click', () => {
                    if (!manualClose) closeConfirm();
                    if (onOk) onOk();
                });

                document.getElementById('confirm-modal').classList.remove('hidden');
            }

            function deleteIncident(rowId) {
                showConfirmDialog('ÂâäÈô§Á¢∫Ë™ÅE, '„Åì„ÅEÂ†±ÂëäÊõ∏„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÅEü\nÅEà„Ç¥„ÉüÁÆ±„Å∏ÁßªÂãï„Åó„Åæ„ÅôÔºÅE, () => {
                    const btn = document.getElementById('confirm-ok-btn');
                    // [Refactor] Use setButtonLoading (Text is handled by spinner CSS/logic)
                    setButtonLoading(btn, true);

                    const w = getWhoami();
                    google.script.run.withSuccessHandler((res) => {
                        closeConfirm();
                        showToast('success', res || '„Ç¥„ÉüÁÆ±„Å∏ÁßªÂãï„Åó„Åæ„Åó„Åü');
                        document.getElementById('incidentDetailPanel').classList.add('hidden');
                        toggleBodyScroll(false);

                        // Context-aware reload
                        if (!document.getElementById('incidentHistorySection').classList.contains('hidden')) {
                            loadIncidentHistory();
                        } else if (!document.getElementById('incidentApprovalSection').classList.contains('hidden')) {
                            loadIncidentApprovalList();
                        } else {
                            loadIncidentPendingList();
                        }
                    }).withFailureHandler((err) => {
                        setButtonLoading(btn, false);
                        handleError(err);
                    }).deleteIncidentByOffice(w.officeSelected, rowId, w);
                }, true); // manualClose = true
            }


            async function viewIncidentDetail(itemOrRowId) {
                console.log('[Debug] viewIncidentDetail called with:', itemOrRowId, 'Type:', typeof itemOrRowId);
                const w = getWhoami();

                // [Fix] Show loading ONLY if we need to fetch from server
                const needsFetch = (typeof itemOrRowId === 'string' || typeof itemOrRowId === 'number');
                if (needsFetch) showLoading();

                const callback = (item) => {
                    try {
                        console.log('[Debug] viewIncidentDetail callback received item:', item);
                        if (needsFetch) hideLoading();

                        // „Çµ„Éº„Éê„ÅEÂÅ¥„Åã„Çâ„ÅÆÊòéÁ§∫ÁöÅEÅ™„Ç®„É©„Éº„Éè„É≥„Éâ„É™„É≥„Ç∞
                        if (item && item._error) {
                            console.error('[Debug] Server returned error:', item);
                            showToast(`„ÉÅEÅE„ÇøÂèñÂæó„Ç®„É©„Éº: ${item._error}`, 'error');
                            return;
                        }

                        if (!item) {
                            console.error('[Debug] Item is null/undefined');
                            return;
                        }

                        const panel = document.getElementById('incidentDetailPanel');
                        const content = document.getElementById('incidentDetailContent');
                        const footer = document.getElementById('incidentDetailFooter');

                        if (!panel || !content) {
                            console.error('Ë©≥Á¥∞„Éë„Éç„É´„ÅÆË¶ÅÁ¥†„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì');
                            return showToast('ÁîªÈù¢„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü', 'error');
                        }

                        console.log('[Debug] Showing panel...');
                        panel.classList.remove('hidden');
                        // „Çπ„ÇØ„É≠„Éº„É´‰ΩçÁΩÆ„Çí„Éà„ÉÅEÅE„Å´„É™„Çª„ÉÅEÉà
                        if (content) content.scrollTop = 0;
                        toggleBodyScroll(true); // „Çπ„ÇØ„É≠„Éº„É´Âõ∫ÂÆÅE                    if (footer) footer.classList.remove('hidden');

                        // „Ç≥„É≥„ÉÅEÉ≥„ÉÅEîüÊàÅE                    console.log('[Debug] Generating HTML content...');
                        // Use requestAnimationFrame to ensure smooth rendering
                        requestAnimationFrame(() => {
                            content.innerHTML = `
                        <div class="bg-indigo-50/50 p-4 rounded-xl border border-indigo-100 flex justify-between items-start mb-4">
                            <div>
                                <p class="text-[10px] font-bold text-indigo-400 uppercase tracking-widest">Â†±ÂëäÁ®ÆÂà•</p>
                                <h4 class="text-lg font-bold text-indigo-800">${item.type}</h4>
                            </div>
                            <div class="text-right">
                                <p class="text-[10px] font-bold text-indigo-400 uppercase tracking-widest">Áô∫ÁîüÊó•ÊôÅE/p>
                                <p class="text-sm font-bold text-indigo-800">${(item.occurDate || '').replace('T', ' ')}</p>
                            </div>
                        </div>
                        ${item.place ? `
                        <div class="bg-white p-3 rounded-lg border border-gray-100 shadow-sm mb-4">
                            <p class="text-[10px] text-gray-400 font-bold mb-1">Â†¥ÊâÄ</p>
                            <p class="text-sm font-bold text-gray-800">${item.place}</p>
                        </div>` : ''}
                        <div class="grid grid-cols-2 gap-4 mb-4">
                            <div class="bg-white p-3 rounded-lg border border-gray-100 shadow-sm">
                                <p class="text-[10px] text-gray-400 font-bold mb-1">ÂØæË±°ËÄÅE/p>
                                <p class="text-sm font-bold">${item.userName || item.user} ÊßÅE/p>
                            </div>
                            <div class="bg-white p-3 rounded-lg border border-gray-100 shadow-sm">
                                <p class="text-[10px] text-gray-400 font-bold mb-1">Ë®òÈå≤ËÄÅE/p>
                                <p class="text-sm font-bold">${item.recorder}</p>
                            </div>
                        </div>
                        <div class="bg-white p-4 rounded-xl border border-gray-100 shadow-sm mb-4">
                            <h5 class="text-[10px] font-bold text-gray-400 block mb-2 tracking-widest">Áä∂Ê≥Å„ÅEÁµåÈÅé</h5>
                            <p class="text-sm text-gray-800 whitespace-pre-wrap leading-relaxed">${item.situation || ''}</p>
                        </div>
                        ${item.cause ? `
                        <div class="bg-white p-4 rounded-xl border border-gray-100 shadow-sm mb-4">
                            <h5 class="text-[10px] font-bold text-gray-400 block mb-2 tracking-widest">ÂéüÂõ†</h5>
                            <p class="text-sm text-gray-800 whitespace-pre-wrap leading-relaxed">${item.cause}</p>
                        </div>` : ''}
                        ${item.response ? `
                        <div class="bg-white p-4 rounded-xl border border-gray-100 shadow-sm mb-4">
                            <h5 class="text-[10px] font-bold text-gray-400 block mb-2 tracking-widest">ÂØæÂøÅE/h5>
                            <p class="text-sm text-gray-800 whitespace-pre-wrap leading-relaxed">${item.response}</p>
                        </div>` : ''}
                        <div class="bg-blue-50/50 p-4 rounded-xl border border-blue-100">
                            <h5 class="text-[10px] font-bold text-blue-400 block mb-2 tracking-widest">ÂÜçÁô∫Èò≤Ê≠¢Á≠ÅE/h5>
                            <p class="text-sm text-blue-800 whitespace-pre-wrap font-medium">${item.prevention || '(Êú™Ë®òÂÅE)'}</p>
                        </div>
                    `;
                        });

                        // „Éï„ÉÉ„Çø„Éº„Éú„Çø„É≥Âà∂Âæ°
                        const btnEdit = document.getElementById('btnEdit');
                        const btnDelete = document.getElementById('btnDelete');
                        const btnApprove = document.getElementById('btnApprove');
                        const btnReturn = document.getElementById('btnReturn');

                        // ÂàùÊúüÂåñÔºöÂÅE„Å¶Èö†„ÅÅE                    [btnEdit, btnDelete, btnApprove, btnReturn].forEach(b => b && b.classList.add('hidden'));

                        // Ê®©ÈôêÂà§ÂÆÅE                    // ÂêçÂâçÊØîËºÅEî®„ÅÆÊ≠£Ë¶èÂåñÈñ¢Êï∞ (ÂÖ®ËßíÂçäËßí„Çπ„Éö„ÅE„ÇπÈô§Âéª, Â∞èÊñáÂ≠óÂåñ)
                        const norm = s => (s || '').toString().replace(/[\s\u3000]+/g, '').toLowerCase();
                        const myName = norm(w.name);
                        const recName = norm(item.recorder);
                        const isMyRecord = (myName === recName);
                        const isManager = (w.role === 'manager');

                        const isPending = (item.status === 'Êú™ÊâøË™ÅE || item.status === 'Â∑ÆÊàª„ÅÅE || item.status === 'Â∑ÆÊàª');
                        const isApproved = (item.status === 'ÊâøË™çÊ∏ÅE);

                    // „Éú„Çø„É≥„ÅÆË°®Á§∫Âà§ÂÆÅE                    // 1. Êú™ÊâøË™ç„ÅEÂ∑ÆÊàª„Åó„ÅEÂ†¥ÂêÅE                    if (isPending) {
                        if (isMyRecord) {
                            // Ëá™ÂàÅEÅEË®òÈå≤„Å™„ÇâÁ∑®ÈõÅEÅEÂâäÈô§OK
                            if (btnEdit) {
                                btnEdit.classList.remove('hidden');
                                btnEdit.onclick = () => {
                                    editIncident(item);
                                };
                            }
                            if (btnDelete) {
                                btnDelete.classList.remove('hidden');
                                btnDelete.onclick = () => deleteIncident(item.rowId);
                            }
                        }
                        if (isManager) {
                            // [v46] Manager: Approve/Return for 'Unapproved' only.
                            // 'Returned' items (in Pending tab) allow Edit/Delete only.
                            const isUnapproved = (item.status === 'Êú™ÊâøË™ÅE);

                            if (isUnapproved) {
                                if (btnApprove) {
                                    btnApprove.classList.remove('hidden');
                                    btnApprove.onclick = () => approveIncident(item.rowId);
                                }
                                if (btnReturn) {
                                    btnReturn.classList.remove('hidden');
                                    btnReturn.onclick = () => returnIncident(item.rowId);
                                }
                            }
                            // ÁÆ°ÁêÅEÄÅEÇÇÁ∑®ÈõÅEÅEÂâäÈô§ÂèØËÉΩ„Å´„Åô„ÇãÅEàÈÅãÁî®ÊüîËªüÊÄß„ÅÆ„Åü„ÇÅ„ÄÅ„Çπ„ÉÅEÅE„Çø„ÇπÂïè„Çè„ÅöÔºÅE                            if (btnEdit) {
                            btnEdit.classList.remove('hidden');
                            btnEdit.onclick = () => editIncident(item);
                        }
                        if (btnDelete) {
                            btnDelete.classList.remove('hidden');
                            btnDelete.onclick = () => deleteIncident(item.rowId);
                        }
                    }
                    }
                // 2. ÊâøË™çÊ∏à„ÅEÂ†¥ÂêÅE                    else if (isApproved) {
                if (isManager) {
                    // [New] ÁÆ°ÁêÅEÄÅEÅEÊâøË™çÊ∏à„Åß„ÇÇÁ∑®ÈõÅEÅEÂâäÈô§„ÉªÂ∑ÆÊàª„Åó„ÅåÂèØËÉΩÅEàË™§ÊâøË™çÂØæÂøúÔºÅE                            if (btnEdit) {
                    btnEdit.classList.remove('hidden');
                    btnEdit.onclick = () => editIncident(item);
                }
                if (btnDelete) {
                    btnDelete.classList.remove('hidden');
                    btnDelete.onclick = () => deleteIncident(item.rowId);
                }
                if (btnReturn) {
                    btnReturn.classList.remove('hidden');
                    btnReturn.onclick = () => returnIncident(item.rowId);
                }
            }
                        // ‰∏ÄËà¨ËÅ∑Âì°„ÅØÈñ≤Ë¶ß„ÅÆ„ÅøÅEà„ÅE„Çø„É≥„Å™„ÅóÔºÅE                    }
                } catch (e) {
                console.error('[Error] viewIncidentDetail render failed:', e);
                showToast('Ë©≥Á¥∞Ë°®Á§∫‰∏≠„Å´„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü: ' + e.message, 'error');
            }
            };

            if (needsFetch) {
                google.script.run.withSuccessHandler(callback).getIncidentByIdV3(w.officeSelected, String(itemOrRowId));
            } else {
                callback(itemOrRowId);
            }
        }

            // viewIncidentDetailForApproval „ÅØ viewIncidentDetail „Å´Áµ±Âêà„Åï„Çå„Åü„Åü„ÇÅÂâäÈô§






            // [v43 Fix] PIN Auth for Approve (New Function)
            function approveIncident(rowId) {
                console.log('[Debug] approveIncident called with rowId:', rowId);
                // [v51] Keep modal open until approval finishes
                authenticateAction((pin) => {
                    console.log('[Debug] approveIncident callback triggered. PIN length:', pin ? pin.length : 0);
                    const w = getWhoami();
                    if (!w) {
                        console.error('[Error] approveIncident: Whoami is null');
                        closePinModal();
                        return;
                    }

                    // Keep spinner on PIN button
                    const pinBtn = document.getElementById('btn-pin-auth-submit');

                    console.log('[Debug] Calling approveIncidentByOffice...');
                    // [Fix] Remove showLoading() to keep PIN modal visible and active
                    google.script.run.withSuccessHandler(() => {
                        console.log('[Debug] approveIncidentByOffice Success');
                        setButtonLoading(pinBtn, false);
                        closePinModal(); // Close manually on success

                        showToast('success', 'ÊâøË™ç„Åó„Åæ„Åó„Åü');
                        document.getElementById('incidentDetailPanel').classList.add('hidden');
                        loadIncidentApprovalList();
                    }).withFailureHandler((err) => {
                        console.error('[Error] approveIncidentByOffice Failed:', err);
                        setButtonLoading(pinBtn, false);
                        // Do not close modal on error, show error in it?
                        // Or close and show toast. Let's close and show toast as usual.
                        closePinModal();
                        handleError(err);
                    }).approveIncidentByOffice(w.officeSelected, rowId, w, pin);
                }, false); // autoClose = false
            }

            // [v43 Fix] Global PIN Auth Helper
            function authenticateAction(callback, autoClose = true) {
                // callback(pin)
                const w = getWhoami();
                if (!w) return showToast('error', '„Çµ„Ç§„É≥„Ç§„É≥„Åó„Å¶„Åè„Å†„Åï„ÅÑ');

                console.log('[Debug] authenticateAction setting callback. AutoClose:', autoClose);
                APP_STATE.authCallback = callback;
                APP_STATE.authAutoClose = autoClose; // Store option

                document.getElementById('pin-modal-input').value = '';
                document.getElementById('pin-modal-error').classList.add('hidden');
                document.getElementById('pin-modal').classList.remove('hidden');
                setTimeout(() => document.getElementById('pin-modal-input').focus(), 100);
            }

            function closePinModal() {
                document.getElementById('pin-modal').classList.add('hidden');
                APP_STATE.authCallback = null;
                APP_STATE.authAutoClose = true; // Reset

                // Reset button state just in case
                const btn = document.getElementById('btn-pin-auth-submit');
                setButtonLoading(btn, false);
            }

            function submitPinAuth() {
                const pin = document.getElementById('pin-modal-input').value;
                if (!pin || pin.length < 4) return;

                console.log('[Debug] submitPinAuth starting...');
                const w = getWhoami();
                const btn = document.getElementById('btn-pin-auth-submit');
                // [Refactor] Use setButtonLoading without overriding textContent
                setButtonLoading(btn, true);

                google.script.run.withSuccessHandler(res => {
                    console.log('[Debug] verifyPinOnly result:', res);
                    // IF autoClose is false, we KEEP loading state until callback finishes (or callback handles it)
                    // But specifically for verifyPinOnly, we are done with VERIFICATION.
                    // The expected behavior:
                    // 1. Verify PIN -> Success
                    // 2. If AutoClose: Close modal, Stop spinner.
                    // 3. If ManualClose: Keep modal open, Keep spinner rotating?
                    //    Yes, let the callback assume control of the UI.

                    if (res && res.success) {
                        if (res.role !== 'manager') {
                            setButtonLoading(btn, false);
                            document.getElementById('pin-modal-error').classList.remove('hidden');
                            document.getElementById('pin-modal-error').textContent = 'ÁÆ°ÁêÅEÄÅE®©Èôê„Åå„ÅÇ„Çä„Åæ„Åõ„Çì';
                            return;
                        }

                        // Execute callback
                        const callback = APP_STATE.authCallback;
                        const shouldAutoClose = (APP_STATE.authAutoClose !== false); // Default true

                        if (callback) {
                            console.log('[Debug] Executing authCallback...');
                            callback(pin);
                        } else {
                            console.error('[Error] APP_STATE.authCallback is missing!');
                        }

                        if (shouldAutoClose) {
                            setButtonLoading(btn, false);
                            closePinModal();
                        } else {
                            // Manual close mode: LEAVE spinner running and modal open.
                            // Callback is responsible for closing.
                            console.log('[Debug] AutoClose disabled. Keeping modal open.');
                        }

                    } else {
                        setButtonLoading(btn, false);
                        document.getElementById('pin-modal-error').classList.remove('hidden');
                        document.getElementById('pin-modal-error').textContent = res ? res.message : 'PIN„ÅåÊ≠£„Åó„Åè„ÅÇ„Çä„Åæ„Åõ„Çì';
                    }
                }).withFailureHandler(err => {
                    console.error('[Error] verifyPinOnly failed:', err);
                    setButtonLoading(btn, false);
                    handleError(err);
                }).verifyPinOnly(w.name, pin);
            }

            function loadIncidentApprovalList() {
                const w = getWhoami();
                if (!w) return;
                const list = document.getElementById('incidentApprovalList');

                if (list) list.innerHTML = `<div class="flex justify-center items-center py-10 w-full">${getLoaderHtml()}</div>`;

                google.script.run.withSuccessHandler(response => {
                    const data = (response && response.data) ? response.data : (Array.isArray(response) ? response : []);

                    if (list) list.innerHTML = '';
                    const pending = (data || []).filter(r => r.status === 'Êú™ÊâøË™ÅE);

                // „Éê„ÉÉ„Ç∏Êõ¥Êñ∞
                const badge = document.getElementById('inc-pending-count');
                    if (badge) badge.textContent = `${pending.length}‰ª∂`;

                    if (pending.length === 0) {
                        list.innerHTML = '<p class="text-center text-gray-400 py-10 text-xs">ÊâøË™çÂæÅEÅ°„ÅÆË®òÈå≤„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì</p>';
                        return;
                    }
                    pending.forEach(r => {
                        const row = document.createElement('div');
                        row.className = 'p-4 border-b hover:bg-gray-50 cursor-pointer flex justify-between items-center';
                        // Unified Card Layout
                        row.innerHTML = `
                        <div class="flex-1 min-w-0">
                            <!-- Row 1: Status | Date (Status is Pending implicit) -->
                            <div class="flex items-center gap-2 mb-1">
                                <span class="bg-indigo-100 text-indigo-700 text-[10px] font-bold px-2 py-0.5 rounded-full">Êú™ÊâøË™ÅE/span>
                                <div class="text-xs text-gray-400 font-bold">${(r.occurDate || '').toString().replace('T', ' ')}</div>
                            </div>
                            <!-- Row 2: Target | Category -->
                            <div class="text-sm font-bold text-gray-800 mb-1">
                                ${r.userName} / ${r.type}
                            </div>
                            <!-- Row 3: Recorder -->
                            <div class="text-xs text-gray-500 font-bold mb-1">Ë®òÈå≤ËÄÅE ${r.recorder}</div>
                             <!-- Row 4: Content (Situation) -->
                            <p class="text-xs text-gray-500 line-clamp-2 bg-gray-50 p-2 rounded">${r.situation || ''}</p>
                        </div>
                        <div class="flex gap-2 shrink-0 ml-2">
                             <i class="fas fa-chevron-right text-gray-300"></i>
                        </div>
                    `;
                        row.onclick = () => {
                            setTimeout(() => viewIncidentDetail(r), 0);
                        };
                        list.appendChild(row);
                    });
                }).getIncidentsByOfficeV2(w.officeSelected);
            }



            // [v47 Fix] Return Operation (using return-modal)
            function returnIncident(rowId) {
                APP_STATE.pendingReturnRowId = rowId;
                document.getElementById('return-reason').value = '';
                document.getElementById('return-pin').value = '';
                document.getElementById('return-modal-error').classList.add('hidden');

                toggleBodyScroll(true);
                showFab(false);
                document.getElementById('return-modal').classList.remove('hidden');
                setTimeout(() => document.getElementById('return-reason').focus(), 100);
            }

            function closeReturnModal() {
                toggleBodyScroll(false);
                document.getElementById('return-modal').classList.add('hidden');
                // Restore FAB if needed
                updateFabState();
                APP_STATE.pendingReturnRowId = null;
            }

            function submitReturn() {
                const reason = document.getElementById('return-reason').value;
                const pin = document.getElementById('return-pin').value;

                if (!reason) {
                    document.getElementById('return-modal-error').textContent = 'Â∑ÆÊàª„ÅóÁêÜÁî±„ÇíÂÅEÂäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ';
                    document.getElementById('return-modal-error').classList.remove('hidden');
                    return;
                }
                if (!pin || pin.length < 4) {
                    document.getElementById('return-modal-error').textContent = 'PIN„Ç≥„Éº„Éâ„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ';
                    document.getElementById('return-modal-error').classList.remove('hidden');
                    return;
                }

                const w = getWhoami();
                const rowId = APP_STATE.pendingReturnRowId;
                if (!w || !rowId) return;

                const btn = document.getElementById('btn-return-submit');
                const txt = document.getElementById('return-submit-text');

                const originalText = txt.textContent;
                setButtonLoading(btn, true);
                txt.textContent = 'ÂÆüË°å‰∏≠...';
                document.getElementById('return-modal-error').classList.add('hidden');

                google.script.run.withSuccessHandler(res => {
                    setButtonLoading(btn, false);
                    txt.textContent = originalText;

                    // Server returns string message on success
                    closeReturnModal();
                    showToast('success', typeof res === 'string' ? res : 'Ë®òÈå≤„ÇíÂ∑Æ„ÅóÊàª„Åó„Åæ„Åó„Åü');
                    document.getElementById('incidentDetailPanel').classList.add('hidden');
                    loadIncidentApprovalList();
                }).withFailureHandler(err => {
                    setButtonLoading(btn, false);
                    txt.textContent = originalText;
                    const msg = (typeof err === 'string' ? err : err.message) || '';
                    if (msg.includes('PIN') || msg.includes('Ê®©ÈôÅE) || msg.includes('Ë™çË®º') || msg.includes('Manager')) {
                    document.getElementById('return-modal-error').textContent = msg.replace(/^Error:\s*/i, '');
                    document.getElementById('return-modal-error').classList.remove('hidden');
                } else {
                    handleError(err);
                }
            }).returnIncidentByOffice(w.officeSelected, rowId, w, pin, reason);
        }
            function initPdfDateInput() {
                const el = document.getElementById('output-month');
                if (el && !el.value) {
                    const now = new Date();
                    const y = now.getFullYear();
                    const m = String(now.getMonth() + 1).padStart(2, '0');
                    el.value = `${y}-${m}`;
                }
            }

            // -----------------------------------------------------------
            // „ÉÅEÅE„É´„Éê„ÅE„Éª„É¨„Çπ„Éù„É≥„Ç∑„ÉÅE(Removed for Flat UI)
            // -----------------------------------------------------------
            // function rebalanceToolbar() { ... } Removed
            // window.addEventListener('resize', rebalanceToolbar); Removed

            // --- Routing (Simple) ---
            function route() {
                const h = window.location.hash || '#signin';
                if (h === '#signin') {
                    document.getElementById('signinView').classList.remove('hidden');
                    document.getElementById('appView').classList.add('hidden');
                } else {
                    document.getElementById('signinView').classList.add('hidden');
                    document.getElementById('appView').classList.remove('hidden');
                    renderWhoamiBadge();
                }
            }
            window.addEventListener('hashchange', route);

            // [v35 Fix] Restored loadIncidentHistory
            // [v52 Feature] History Pagination & Caching
            function loadIncidentHistory(useCache = false) {
                const w = getWhoami();
                if (!w) return;
                const container = document.getElementById('incidentHistoryCards');
                if (!container) return console.error('History container not found');

                // --- Cache Logic ---
                // If cache requested and data exists, skip fetch
                if (useCache && APP_STATE.history && APP_STATE.history.allData) {
                    console.log('[Debug] Using cached history data');
                    applyIncidentHistoryFilterAndRender();
                    return;
                }

                // [Fix] Unified Spinner with centering wrapper
                container.innerHTML = `<div class="flex justify-center items-center py-20 w-full col-span-full">${getLoaderHtml()}</div>`;

                // Remove grid temporarily for centering (though col-span-full helps, flex is safer for true center)
                container.classList.remove('grid', 'grid-cols-1', 'md:grid-cols-2');
                container.classList.add('flex', 'justify-center');

                console.log('[Debug] loadIncidentHistory started for Office:', w.officeSelected);

                google.script.run.withSuccessHandler(response => {
                    // Restore grid layout
                    container.classList.remove('flex', 'justify-center');
                    container.classList.add('grid', 'grid-cols-1', 'md:grid-cols-2');
                    const data = (response && response.data) ? response.data : response;
                    const debug = (response && response.debug) ? response.debug : null;

                    console.log('[Debug] History data received:', data ? data.length : 0, 'items');
                    if (debug) console.log('[Debug] Server Metadata:', debug);

                    // Init Cache Step
                    const all = data || [];
                    // Base filter logic (Exclude Pending/Returned) - Keep consistent with previous logic
                    // History shows 'Approved' only
                    const baseFiltered = all.filter(item => {
                        return item.status !== 'Êú™ÊâøË™ÅE && item.status !== 'Â∑ÆÊàª„ÅÅE && item.status !== 'Â∑ÆÊàª';
                    }).sort((a, b) => new Date(b.occurDate) - new Date(a.occurDate));

                    APP_STATE.history = {
                        allData: baseFiltered, // Sorted & Base Filtered
                        filtered: [],          // After UI Filter
                        limit: 50,
                        rendered: 0
                    };

                    applyIncidentHistoryFilterAndRender();

                }).getIncidentsByOfficeV2(w.officeSelected);
            }

            function applyIncidentHistoryFilterAndRender() {
                if (!APP_STATE.history) return;

                const container = document.getElementById('incidentHistoryCards');
                container.innerHTML = '';

                // „Éï„Ç£„É´„Çø„ÉºÈÅ©Áî®
                const from = document.getElementById('hist-from').value;
                const to = document.getElementById('hist-to').value;
                const type = document.getElementById('hist-type').value;
                const user = document.getElementById('hist-user').value;

                let result = APP_STATE.history.allData; // Already sorted & base filtered

                if (from) result = result.filter(i => new Date(i.occurDate) >= new Date(from));
                if (to) {
                    const toDate = new Date(to);
                    toDate.setHours(23, 59, 59, 999);
                    result = result.filter(i => new Date(i.occurDate) <= toDate);
                }
                if (type) result = result.filter(i => i.type === type);
                if (user) {
                    const normUser = user.toString().toLowerCase().trim();
                    result = result.filter(i => {
                        const targetUser = (i.user || i.userName || '').toLowerCase();
                        return targetUser.includes(normUser);
                    });
                }

                console.log('[Debug] Filtered History List size:', result.length);

                // Update State
                APP_STATE.history.filtered = result;
                APP_STATE.history.rendered = 0; // Reset rendered count

                if (result.length === 0) {
                    // [v52 Feature] Server-side Pagination for Incident History
                    // Replaces previous Client-side pagination logic
                    function loadIncidentHistory(isAppend = false) {
                        const w = getWhoami();
                        if (!w) return;
                        const container = document.getElementById('incidentHistoryCards');
                        if (!container) return console.error('History container not found');

                        // --- State Initialization ---
                        if (!APP_STATE.history || !isAppend) {
                            // Determine filters from DOM inputs
                            const filters = {
                                from: document.getElementById('hist-from').value,
                                to: document.getElementById('hist-to').value,
                                type: document.getElementById('hist-type').value,
                                user: document.getElementById('hist-user').value
                            };

                            APP_STATE.history = {
                                limit: 50,
                                offset: 0,
                                filters: filters,
                                items: [], // Client cache of loaded items
                                hasMore: true,
                                loading: false
                            };

                            // Clear Container on Initial Load
                            if (!isAppend) {
                                // Show full page spinner
                                container.innerHTML = `<div class="flex justify-center items-center py-20 w-full col-span-full">${getLoaderHtml()}</div>`;
                                // Centering
                                container.classList.remove('grid', 'grid-cols-1', 'md:grid-cols-2');
                                container.classList.add('flex', 'justify-center');
                            }
                        } else {
                            // Is Append mode
                            if (APP_STATE.history.loading) return; // Prevent double fetch

                            // Show small spinner at bottom?
                            // For now, simpler to just wait or show button spinner
                            const btn = document.getElementById('btn-hist-load-more');
                            if (btn) {
                                btn.innerHTML = `<i class="fas fa-spinner fa-spin mr-2"></i>ì«Ç›çûÇ›íÜ...`;
                                btn.disabled = true;
                            }
                        }

                        APP_STATE.history.loading = true;

                        const h = APP_STATE.history;
                        console.log('[Debug] Fetching History:', h.offset, h.limit, h.filters);

                        google.script.run.withSuccessHandler(response => {
                            const data = response.data || [];
                            const hasMore = response.hasMore || false;
                            const debug = response.debug;

                            console.log('[Debug] History Fetched:', data.length, debug);

                            APP_STATE.history.items = APP_STATE.history.items.concat(data);
                            APP_STATE.history.offset += data.length;
                            APP_STATE.history.hasMore = hasMore;
                            APP_STATE.history.loading = false;

                            // Render Logic
                            const isInitial = (!isAppend);

                            if (isInitial) {
                                container.innerHTML = '';
                                // Restore grid layout
                                container.classList.remove('flex', 'justify-center');
                                container.classList.add('grid', 'grid-cols-1', 'md:grid-cols-2');

                                if (data.length === 0) {
                                    container.innerHTML = '<div class="text-center py-20 text-gray-400 bg-gray-50 rounded-xl border-2 border-dashed border-gray-100 col-span-full">èåèÇ…àÍívÇ∑ÇÈóöóÇÕÇ†ÇËÇ‹ÇπÇÒ</div>';
                                    return;
                                }
                            } else {
                                // Remove "Load More" button container
                                const btnContainer = document.getElementById('btn-hist-load-more-container');
                                if (btnContainer) btnContainer.remove();
                            }

                            // Render appended items
                            data.forEach(item => {
                                const card = createIncidentHistoryCard(item); // Helper Function
                                container.appendChild(card);
                            });

                            // Check "Load More"
                            if (hasMore) {
                                const moreDiv = document.createElement('div');
                                moreDiv.id = 'btn-hist-load-more-container';
                                moreDiv.className = 'col-span-full flex justify-center py-6';
                                // Note: Argument needs to be true for Append
                                moreDiv.innerHTML = `<button id="btn-hist-load-more" onclick="loadIncidentHistory(true)" class="bg-white border border-gray-300 text-gray-600 font-bold py-2 px-6 rounded-full shadow-sm hover:bg-gray-50 transition flex items-center gap-2">
                                            <span>Ç‡Ç¡Ç∆å©ÇÈ</span>
                                            <i class="fas fa-chevron-down text-xs"></i>
                                          </button>`;
                                container.appendChild(moreDiv);
                            }

                        }).getIncidentHistory(w.officeSelected, h.limit, h.offset, h.filters);
                    }

                    function createIncidentHistoryCard(item) {
                        const card = document.createElement('div');
                        card.className = 'flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 p-4 bg-white border border-gray-100 rounded-xl hover:border-indigo-300 transition cursor-pointer shadow-sm';
                        card.onclick = () => {
                            setTimeout(() => viewIncidentDetail(item), 0);
                        };

                        const statusClass = item.status === 'è≥îFçœ' ? 'bg-emerald-100 text-emerald-700' : ((item.status === 'ç∑ñﬂÇµ' || item.status === 'ç∑ñﬂ') ? 'bg-red-100 text-red-700' : 'bg-gray-100 text-gray-700');
                        const targetUser = item.user || item.userName || '(ëŒè€é“ïsñæ)';

                        card.innerHTML = `
                <div class="flex-1 min-w-0">
                    <div class="flex items-center gap-2 mb-1">
                        <span class="text-[10px] font-bold px-2 py-0.5 rounded-full ${statusClass}">${item.status}</span>
                        <span class="text-[10px] font-bold text-gray-400">${(item.occurDate || '').toString().replace('T', ' ')}</span>
                    </div>
                    <h4 class="text-sm font-bold text-gray-800 truncate mb-1">${targetUser} / ${item.type}</h4>
                    <div class="text-xs text-gray-500 font-bold mb-1">ãLò^é“: ${item.recorder || '(ïsñæ)'}</div>
                    <p class="text-xs text-gray-500 line-clamp-2 bg-gray-50 p-2 rounded">${item.situation || ''}</p>
                </div>
                <div class="text-xs text-gray-400 shrink-0 ml-2">
                    <i class="fas fa-chevron-right"></i>
                </div>
            `;
                        return card;
                    }
                    if (draft.user) document.getElementById('inc-simple-user').value = draft.user;
                    if (draft.occur) document.getElementById('inc-simple-occur').value = draft.occur;
                    if (draft.type) document.getElementById('inc-simple-type').value = draft.type;
                    if (draft.place) document.getElementById('inc-simple-place').value = draft.place;
                    if (draft.situation) document.getElementById('inc-simple-situation').value = draft.situation;
                    if (draft.cause) document.getElementById('inc-simple-cause').value = draft.cause;
                    if (draft.response) document.getElementById('inc-simple-response').value = draft.response;
                    if (draft.prevention) document.getElementById('inc-simple-prevention').value = draft.prevention;
                    showToast('‰∏ãÊõ∏„Åç„ÇíÂæ©ÂÖÅEÅó„Åæ„Åó„Åü', 'info');
                }
            } catch (e) {
                console.error('Draft load failed:', e);
            }
        }

            function discardDraft() {
                try {
                    const w = getWhoami();
                    if (w) localStorage.removeItem('incident_draft_' + w.name);
                } catch (e) { console.error(e); }
            }

            function openIncidentSimpleModal() {
                const w = getWhoami();
                if (!w) return showSuccessModal('„Ç®„É©„Éº', null, '„Çµ„Ç§„É≥„Ç§„É≥„Åó„Å¶„Åè„Å†„Åï„ÅÑ');

                // „ÄêÈáçË¶Å„ÄëÊñ∞Ë¶è‰ΩúÊÅE„É¢„Éº„Éâ„Å®„Åó„Å¶ÂàùÊúüÂåÅE            APP_STATE.pendingEditRowId = null;
                APP_STATE.incidentSnapshot = null;

                // Ë®òÈå≤ËÄÅEÅEÂãï„Çª„ÉÅEÉà
                document.getElementById('inc-simple-recorder').value = w.name;

                // Êó•ÊôÇËÅEÂãï„Çª„ÉÅEÉà
                const now = new Date();
                now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
                document.getElementById('inc-simple-occur').value = now.toISOString().slice(0, 16);

                // Âà©Áî®ËÄÅEÅE„É´„ÉÄ„Ç¶„É≥ÁîüÊÅE
                const uSel = document.getElementById('inc-simple-user');
                uSel.innerHTML = '<option value="" disabled selected>Âà©Áî®ËÄÅEÇíÈÅ∏ÊäÅE/option>';
                if (APP_STATE.users) {
                    APP_STATE.users.forEach(u => uSel.add(new Option(u.userName, u.userName)));
                }
                // Â§ñÈÉ®Âà©Áî®ËÄÅEÇ™„Éó„Ç∑„Éß„É≥
                const ext = document.createElement('option');
                ext.value = 'Â§ñÈÉ®'; ext.text = 'Â§ñÈÉ® (ËøëÈö£„Éª„Åù„ÅE‰ªÅE'; ext.style.color = 'orange';
                uSel.appendChild(ext);

                if (APP_STATE.currentUserName) {
                    uSel.value = APP_STATE.currentUserName;
                }

                // „Éï„Ç©„Éº„É†„ÅÆ„É™„Çª„ÉÅEÉà
                document.getElementById('inc-simple-place').value = '';
                document.getElementById('inc-simple-situation').value = '';
                document.getElementById('inc-simple-cause').value = '';
                document.getElementById('inc-simple-response').value = '';
                document.getElementById('inc-simple-prevention').value = '';
                document.getElementById('inc-simple-type').selectedIndex = 0; // „Éí„É§„É™„Éè„ÉÉ„Éà„Åå„ÉÅEÉï„Ç©„É´„ÉÅE
                // „Éú„Çø„É≥Áä∂ÊÖã„É™„Çª„ÉÅEÉà
                const btn = document.getElementById('btn-save-simple-inc');
                const btnText = document.getElementById('btn-save-simple-inc-text');
                const btnLoader = document.getElementById('btn-save-simple-inc-loader');
                if (btn) btn.disabled = false;
                if (btnText) btnText.textContent = "Â†±Âëä„Çí‰øùÂ≠ÅE;
                if (btnLoader) btnLoader.classList.add('hidden');

                // Ë°®Á§∫
                toggleBodyScroll(true);
                showFab(false);
                const simpleModal = document.getElementById('incident-simple-modal');
                simpleModal.classList.remove('hidden');
                // „Çπ„ÇØ„É≠„Éº„É´‰ΩçÁΩÆ„É™„Çª„ÉÅEÉà
                const container = simpleModal.querySelector('.overflow-y-auto');
                if (container) container.scrollTop = 0;

                // „É™„Çπ„Éä„ÅEÁôªÈå≤„Å®Áä∂ÊÖã„ÉÅ„Çß„ÉÅEÇØ
                attachIncidentChangeListeners();
                checkIncidentChange();

                // [v43] Auto-load draft
                setTimeout(loadDraft, 300); // UIÂÆâÂÆöÂæå„Å´„É≠„Éº„ÉÅE        }

                function closeIncidentSimpleModal() {
                    toggleBodyScroll(false);
                    document.getElementById('incident-simple-modal').classList.add('hidden');
                    // FAB„ÇíÂÅEË°®Á§∫ÅEà„Éà„ÉÅEÅEÁîªÈù¢„Å™„Å©„ÅßÊ∂à„Åà„Åü„Åæ„Åæ„Å´„Å™„Çã„ÅE„ÇíÈò≤„ÅêÔºÅE            updateFabState();
                }




                // Global export for onclick attributes (Incident Logic & Common)
                // [v45 Fix] Explicit Definition of switchIncidentTab (Missing/Broken)
                function switchIncidentTab(tab) {
                    // 1. Hide all sections
                    const sections = ['incidentPendingSection', 'incidentHistorySection', 'incidentApprovalSection'];
                    sections.forEach(id => {
                        const el = document.getElementById(id);
                        if (el) el.classList.add('hidden');
                    });

                    // 2. Reset Tab Styles
                    const tabs = ['tabIncidentPending', 'tabIncidentHistory', 'tabIncidentApprove'];
                    tabs.forEach(id => {
                        const el = document.getElementById(id);
                        if (el) {
                            el.classList.remove('border-indigo-600', 'text-indigo-600');
                            el.classList.add('border-transparent', 'text-gray-500');
                        }
                    });

                    // 3. Activate Target
                    let targetSecId = '', targetTabId = '';
                    if (tab === 'pending') { targetSecId = 'incidentPendingSection'; targetTabId = 'tabIncidentPending'; }
                    else if (tab === 'history') { targetSecId = 'incidentHistorySection'; targetTabId = 'tabIncidentHistory'; }
                    else if (tab === 'approval') { targetSecId = 'incidentApprovalSection'; targetTabId = 'tabIncidentApprove'; }

                    if (targetSecId) document.getElementById(targetSecId).classList.remove('hidden');
                    if (targetTabId) {
                        const el = document.getElementById(targetTabId);
                        if (el) {
                            el.classList.add('border-indigo-600', 'text-indigo-600');
                            el.classList.remove('border-transparent', 'text-gray-500');
                        }
                    }

                    // 4. Load Data
                    if (tab === 'pending') loadIncidentPendingList();
                    else if (tab === 'history') loadIncidentHistory();
                    else if (tab === 'approval') loadIncidentApprovalList();
                }

                window.switchIncidentTab = switchIncidentTab;
                window.openIncidentSection = () => { switchView('incident'); switchIncidentTab('pending'); };

                // --- ‰∫ãÊïÖÂ†±ÂëäÔºö„Ç∑„É≥„Éó„É´„Éï„Ç©„Éº„É†Èñ¢ÈÄ£ ---
                window.openIncidentSimpleModal = openIncidentSimpleModal;
                window.closeIncidentSimpleModal = closeIncidentSimpleModal;
                window.editIncident = editIncident;
                window.deleteIncident = deleteIncident;
                window.saveIncident = saveIncident;
                window.viewIncidentDetail = viewIncidentDetail; // Â±•Ê≠¥Èñ≤Ë¶ßÁî®

                // --- ‰∫ãÊïÖÂ†±ÂëäÔºöÊâøË™çÈñ¢ÈÄ£ ---
                window.loadIncidentApprovalList = loadIncidentApprovalList;

                window.approveIncident = approveIncident;
                window.returnIncident = returnIncident;
                window.closeIncidentDetailPanel = () => {
                    document.getElementById('incidentDetailPanel').classList.add('hidden');
                    toggleBodyScroll(false);
                };

                // --- „Åù„ÅE‰ªñÂÅEÈÄÅE---
                window.loadIncidentHistory = loadIncidentHistory;
                window.toggleUserDropdown = toggleUserDropdown;
                window.openUserSwitchModal = openUserSwitchModal;
                window.closeUserSwitchModal = closeUserSwitchModal;
                window.submitUserSwitch = submitUserSwitch;
                window.loadOfficeList = loadOfficeList;
                window.switchView = switchView;
                window.reloadApp = reloadApp;
                window.openRecordModal = openRecordModal;
                window.closeRecordModal = closeRecordModal;
                window.handleRecordSubmission = handleRecordSubmission;
                window.openUserSelectModal = openUserSelectModal;
                window.closeUserSelectModal = closeUserSelectModal;
                window.confirmUserSelection = confirmUserSelection;
                window.copyRecord = copyRecord;
                window.openTextDetail = openTextDetail;
                window.deleteRecord = deleteRecord;
                window.openPhraseManagerModal = openPhraseManagerModal;
                window.closePhraseManagerModal = closePhraseManagerModal;
                window.insertPhraseToForm = insertPhraseToForm;
                window.addNewPhrase = addNewPhrase;
                window.deletePhrase = deletePhrase;
                window.openEditPhraseModal = openEditPhraseModal;
                window.submitEditPhrase = submitEditPhrase;
                window.saveToDropbox = saveToDropbox;
                window.openDropboxBrowser = openDropboxBrowser;
                window.closeDropboxBrowser = closeDropboxBrowser;
                window.openDropboxFilePreview = openDropboxFilePreview;
                window.openTrashModal = openTrashModal;
                window.closeTrashModal = closeTrashModal;
                // window.restoreRecord = restoreRecord; // Deleted
                window.switchTrashTab = switchTrashTab; // Added
                window.restoreTrashItem = restoreTrashItem; // Added
                window.requestPdfGeneration = requestPdfGeneration;
                window.changePdfZoom = changePdfZoom;
                window.openFullPreview = openFullPreview;
                window.closeFullPreview = closeFullPreview;
                window.showToast = showToast;
                window.setGranularity = setGranularity;
                window.setToday = setToday;
                window.shiftDate = shiftDate;
                window.applyCustomRange = applyCustomRange;
                window.toggleDetailPanel = toggleDetailPanel;
                window.resetToDefault = resetToDefault;
                window.toggleMobileMenu = toggleMobileMenu;

                function toggleMobileMenu() {
                    const menu = document.getElementById('mobile-menu');
                    if (menu) menu.classList.toggle('hidden');
                }
                window.clearWhoami = clearWhoami;
                // [Fix] Click outside to close More Menu (Removed as More Menu is gone)
                // document.addEventListener('click', ...);
                window.closePinModal = closePinModal;
                window.submitPinAuth = submitPinAuth;
                window.closeReturnModal = closeReturnModal;
                window.submitReturn = submitReturn;
        </script>

        <!-- PIN Auth Modal (New for Manager Ops) -->
        <div id="pin-modal"
            class="hidden fixed inset-0 modal-overlay flex justify-center items-center p-4 fade-in z-[20000]">
            <div class="bg-white rounded-xl shadow-2xl w-full max-w-sm p-6 transform transition-all scale-100">
                <h3 class="font-bold text-gray-800 mb-4 text-center text-lg">Ë™çË®ºPIN</h3>
                <p class="text-xs text-gray-500 text-center mb-4">ÊâøË™ç„ÅEÁ∑®ÈõÅEÅ´„ÅØÁÆ°ÁêÅEÄÅE®©Èôê„ÅåÂøÅE¶Å„Åß„ÅÅE/p>
                    <input type="password" id="pin-modal-input" maxlength="4" pattern="\d*" inputmode="numeric"
                        onkeydown="if(event.key === 'Enter') submitPinAuth()"
                        class="w-full text-center text-3xl tracking-[1em] p-4 border-2 border-gray-200 rounded-xl focus:border-indigo-500 focus:ring-0 font-bold text-gray-700 bg-gray-50 mb-4 placeholder-gray-200"
                        placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                <p id="pin-modal-error"
                    class="text-red-500 text-sm text-center font-bold mb-4 hidden bg-red-50 py-2 rounded">
                    PIN„ÅåÊ≠£„Åó„Åè„ÅÇ„Çä„Åæ„Åõ„Çì</p>
                <div class="grid grid-cols-2 gap-3">
                    <button onclick="closePinModal()"
                        class="py-3 text-gray-500 font-bold hover:bg-gray-100 rounded-xl transition">„Ç≠„É£„É≥„Çª„É´</button>
                    <button onclick="submitPinAuth()" id="btn-pin-auth-submit"
                        class="py-3 bg-indigo-600 text-white font-bold rounded-xl hover:bg-indigo-700 shadow-lg shadow-indigo-200 transition"><span>Ë™çË®º</span></button>
                </div>
            </div>
        </div>

        <!-- Floating Action Buttons (Restored & Aligned) -->
        <div id="fab-container"
            class="fixed bottom-6 left-0 right-0 z-[90] pointer-events-none transition-transform duration-300">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 flex justify-end gap-3 pointer-events-auto">
                <!-- New Record Trigger -->
                <div id="fab-wrapper-record" class="transition-transform duration-200 hover:scale-105 active:scale-95">
                    <button onclick="openRecordModal('new')"
                        class="group flex items-center gap-2 bg-gradient-to-r from-indigo-600 to-indigo-500 hover:from-indigo-700 hover:to-indigo-600 text-white px-5 py-3.5 rounded-full shadow-lg shadow-indigo-200 transition-all">
                        <i class="fas fa-plus text-lg group-hover:rotate-90 transition-transform duration-300"></i>
                        <span class="font-bold tracking-wide">Ë®òÈå≤„Åô„Çã</span>
                    </button>
                </div>
                <!-- New Incident Trigger -->
                <div id="fab-wrapper-incident"
                    class="transition-transform duration-200 hover:scale-105 active:scale-95">
                    <button onclick="openIncidentSimpleModal()"
                        class="group flex items-center gap-2 bg-gradient-to-r from-orange-500 to-red-500 hover:from-orange-600 hover:to-red-600 text-white px-5 py-3.5 rounded-full shadow-lg shadow-orange-200 transition-all">
                        <i class="fas fa-exclamation-triangle text-lg"></i>
                        <span class="font-bold tracking-wide">‰∫ãÊïÖÂ†±ÂëÅE/span>
                    </button>
                </div>
            </div>
        </div>

        <!-- Return Modal (Reason + PIN) -->
        <div id="return-modal"
            class="hidden fixed inset-0 modal-overlay flex justify-center items-center p-4 fade-in z-[20000]">
            <div class="bg-white rounded-xl shadow-2xl w-full max-w-sm p-6 transform transition-all scale-100">
                <h3 class="font-bold text-red-600 mb-2 text-center text-lg"><i
                        class="fas fa-undo-alt mr-2"></i>Â∑ÆÊàª„ÅÅE/h3>

                    <p class="text-xs font-bold text-gray-500 mb-1">Â∑ÆÊàª„ÅóÁêÜÁî±</p>
                    <textarea id="return-reason" rows="3"
                        class="w-full p-3 border border-gray-300 rounded-lg text-sm mb-4 focus:ring-2 focus:ring-red-500"
                        placeholder="‰øÆÊ≠£ÁÆÅEâÄ„Å™„Å©„ÇíÂÅEÂäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ..."></textarea>

                    <p class="text-xs font-bold text-gray-500 mb-1">ÁÆ°ÁêÅEÄÅEIN</p>
                    <input type="password" id="return-pin" maxlength="4" pattern="\d*" inputmode="numeric"
                        onkeydown="if(event.key === 'Enter') submitReturn()"
                        class="w-full text-center text-2xl tracking-[0.5em] p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 font-bold text-gray-700 mb-4"
                        placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢">

                    <p id="return-modal-error"
                        class="text-red-500 text-xs text-center font-bold mb-4 hidden bg-red-50 py-2 rounded"></p>

                    <div class="grid grid-cols-2 gap-3">
                        <button onclick="closeReturnModal()"
                            class="py-2 text-gray-500 font-bold hover:bg-gray-100 rounded-lg transition">„Ç≠„É£„É≥„Çª„É´</button>
                        <button onclick="submitReturn()" id="btn-return-submit"
                            class="py-2 bg-red-600 text-white font-bold rounded-lg hover:bg-red-700 shadow-lg shadow-red-200 transition flex items-center justify-center">
                            <span id="return-submit-text">Â∑ÆÊàª„ÅóÂÆüË°ÅE/span>
                                <!-- <div id="return-submit-loader" class="hidden"></div> -->
                        </button>
                    </div>
            </div>
        </div>
        <script>
                // Helper to show button spinner
                function setButtonLoading(btn, isLoading) {
                    if (!btn) return;
                    if (isLoading) {
                        // Hide text span
                        const textSpan = btn.querySelector('span:not(.spinner-loader)');
                        if (textSpan) textSpan.style.display = 'none';

                        // [Fix] Hide icon (arrow) as well
                        const icon = btn.querySelector('i');
                        if (icon) icon.style.display = 'none';

                        if (!btn.querySelector('.spinner-loader')) {
                            const sp = document.createElement('span');
                            // [Fix] Use Tailwind animate-spin and border-current for auto-coloring
                            // h-4 w-4 (1rem), border-2, rounded-full
                            // border-current sets color to text color, border-t-transparent creates the "C" shape
                            // [Fix] Add 'inline-block' to prevent collapsing in non-flex buttons
                            sp.className = 'spinner-loader inline-block animate-spin rounded-full h-4 w-4 border-2 border-current border-t-transparent mr-2';
                            // No manual style needed
                            // Insert before text
                            if (btn.firstChild) btn.insertBefore(sp, btn.firstChild);
                            else btn.appendChild(sp);
                        }

                        // [Fix] Always set disabled and opacity (moved out of inner if)
                        btn.disabled = true;
                        btn.classList.add('opacity-75', 'cursor-not-allowed');
                    } else {
                        const sp = btn.querySelector('.spinner-loader');
                        if (sp) sp.remove();

                        // Show text span again
                        const textSpan = btn.querySelector('span:not(.spinner-loader)');
                        if (textSpan) textSpan.style.display = '';

                        // [Fix] Show icon again
                        const icon = btn.querySelector('i');
                        if (icon) icon.style.display = '';

                        btn.disabled = false;
                        btn.classList.remove('opacity-75', 'cursor-not-allowed');
                    }
                }
        </script>
</body>

</html>
