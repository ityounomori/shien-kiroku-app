<!-- auth_dialog.html -->

<!DOCTYPE html>
<html>
<head>
    <base target="_top">
    <style>
        body { font-family: sans-serif; padding: 20px; background: #f4f4f4; }
        h3 { color: #d32f2f; border-bottom: 2px solid #d32f2f; padding-bottom: 5px; margin-top: 0; }
        .info { background: #e3f2fd; padding: 15px; border-radius: 5px; border-left: 5px solid #1e88e5; margin-bottom: 20px; font-size: 0.9em; }
        .step { margin-bottom: 20px; }
        .label { font-weight: bold; margin-bottom: 5px; display: block; }
        .btn-auth { background: #1e88e5; color: white; padding: 10px 15px; border: none; border-radius: 5px; cursor: pointer; text-decoration: none; display: inline-block; }
        .btn-auth:hover { background: #1565c0; }
        textarea { width: 95%; height: 80px; padding: 10px; border: 1px solid #ccc; border-radius: 5px; margin-top: 5px; }
        .btn-save { background: #43a047; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; margin-top: 10px; }
        .btn-save:hover { background: #388e3c; }
        #message { margin-top: 15px; padding: 10px; border-radius: 5px; font-weight: bold; }
        .success { background: #e8f5e9; color: #2e7d32; }
        .error { background: #ffebee; color: #d32f2f; }
    </style>
</head>
<body>
    <h3>ğŸ”‘ Dropboxå†èªè¨¼ã¨ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ãƒˆãƒ¼ã‚¯ãƒ³è¨­å®š</h3>
    <div class="info">
        ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ãƒˆãƒ¼ã‚¯ãƒ³ãŒå¤±åŠ¹ã—ãŸå ´åˆã¯ã€ä»¥ä¸‹ã®æ‰‹é †ã§å†å–å¾—ã—ã€è¨­å®šã—ã¦ãã ã•ã„ã€‚<br>
        ã“ã®æ“ä½œã¯ã‚·ã‚¹ãƒ†ãƒ å…¨ä½“ã®èªè¨¼æƒ…å ±ã‚’æ›´æ–°ã—ã¾ã™ã€‚
    </div>

    <div class="step">
        <div class="label">ã‚¹ãƒ†ãƒƒãƒ— 1: èªè¨¼URLã‚’é–‹ãã€ã€ŒOffline Access Tokenã€ã‚’å–å¾—ã™ã‚‹</div>
        <button class="btn-auth" onclick="getAuthUrl()">èªè¨¼URLã‚’é–‹ã</button>
    </div>

    <div class="step">
        <div class="label">ã‚¹ãƒ†ãƒƒãƒ— 2: å–å¾—ã—ãŸèªè¨¼ã‚³ãƒ¼ãƒ‰ã‚’è²¼ã‚Šä»˜ã‘ã‚‹ (é•·ã„æ–‡å­—åˆ—)</div>
        <textarea id="refreshTokenInput" placeholder="ã“ã“ã«å–å¾—ã—ãŸèªè¨¼ã‚³ãƒ¼ãƒ‰ã‚’è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„ã€‚"></textarea>
    </div>

    <button class="btn-save" onclick="saveRefreshToken()">ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ä¿å­˜</button>

    <div id="message"></div>

    <script>
        function getAuthUrl() {
            document.getElementById('message').className = 'success';
            document.getElementById('message').textContent = 'èªè¨¼URLã‚’å–å¾—ä¸­ã§ã™...';
            
            google.script.run
                .withSuccessHandler(function(url) {
                    // æ–°ã—ã„ã‚¿ãƒ–ã§èªè¨¼URLã‚’é–‹ã
                    window.open(url, '_blank'); 
                    document.getElementById('message').className = 'success';
                    document.getElementById('message').textContent = 'æ–°ã—ã„ã‚¿ãƒ–ã§èªè¨¼URLãŒé–‹ãã¾ã—ãŸã€‚ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å–å¾—å¾Œã€ã‚¹ãƒ†ãƒƒãƒ—2ã«é€²ã‚“ã§ãã ã•ã„ã€‚';
                })
                .withFailureHandler(function(error) {
                    document.getElementById('message').className = 'error';
                    document.getElementById('message').textContent = 'ã‚¨ãƒ©ãƒ¼: èªè¨¼URLã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆIDãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚';
                })
                .getDropboxAuthUrl(); // auth.gs ã®é–¢æ•°
        }

        function saveRefreshToken() {
            // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒå…¥åŠ›ã™ã‚‹ã®ã¯ã€Œèªè¨¼ã‚³ãƒ¼ãƒ‰ã€
            const authCode = document.getElementById('refreshTokenInput').value.trim(); 
            if (!authCode) {
                document.getElementById('message').className = 'error';
                document.getElementById('message').textContent = 'ã‚¨ãƒ©ãƒ¼: èªè¨¼ã‚³ãƒ¼ãƒ‰ï¼ˆã‚¹ãƒ†ãƒƒãƒ—1ã§å–å¾—ï¼‰ã‚’è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„ã€‚';
                return;
            }
            
            document.getElementById('message').className = 'success';
            document.getElementById('message').textContent = 'èªè¨¼ã‚³ãƒ¼ãƒ‰ã‚’é€ä¿¡ã—ã€ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ãƒˆãƒ¼ã‚¯ãƒ³äº¤æ›ä¸­ã§ã™... ã—ã°ã‚‰ããŠå¾…ã¡ãã ã•ã„ã€‚';

            google.script.run
                .withSuccessHandler(function(result) {
                    document.getElementById('message').className = 'success';
                    document.getElementById('message').textContent = result;
                })
                .withFailureHandler(function(error) {
                    document.getElementById('message').className = 'error';
                    document.getElementById('message').textContent = 'ã‚µãƒ¼ãƒãƒ¼å´ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message;
                })
                // â­ ä¿®æ­£ç‚¹: handleAuthCodeSubmission é–¢æ•°ã‚’å‘¼ã³å‡ºã™
                .handleAuthCodeSubmission(authCode); 
        }
    </script>
</body>
</html>